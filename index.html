<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wallet QC Local Storage</title>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.14/jspdf.autotable.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-purple: #8B5CF6;
      --primary-green: #10B981;
      --dark-bg: #0f0f0f;
      --card-bg: rgba(31, 31, 31, 0.7);
    }
    
    body {
      background: linear-gradient(to bottom, #000000, var(--dark-bg));
      min-height: 100vh;
      font-family: 'Segoe UI', system-ui, sans-serif;
      color: #f3f4f6;
    }
    
    .solana-card {
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
      transition: all 0.3s ease;
    }
    
    .solana-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(139, 92, 246, 0.2);
    }
    
    .gradient-text {
      background: linear-gradient(to right, var(--primary-purple), var(--primary-green));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    
    .btn-primary {
      background: linear-gradient(to right, var(--primary-purple), var(--primary-green));
      color: white;
      border: none;
      border-radius: 12px;
      padding: 12px 24px;
      font-weight: 600;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .btn-primary:hover {
      opacity: 0.9;
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
    }
    
    .input-field {
      background: rgba(55, 55, 55, 0.5);
      border: 1px solid rgba(107, 114, 128, 0.3);
      border-radius: 12px;
      padding: 14px 16px;
      color: white;
      width: 100%;
      transition: border 0.3s ease;
    }
    
    .input-field:focus {
      outline: none;
      border-color: var(--primary-purple);
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
    }
    
    .tab-active {
      background: rgba(139, 92, 246, 0.2);
      color: var(--primary-purple);
      font-weight: 600;
    }
    
    .transaction-in {
      border-left: 4px solid var(--primary-green);
    }
    
    .transaction-out {
      border-left: 4px solid #EF4444;
    }
    
    .user-avatar {
      background: linear-gradient(to right, var(--primary-purple), var(--primary-green));
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-weight: bold;
    }
    
    .section-hidden {
      display: none;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(139, 92, 246, 0.3);
      border-radius: 50%;
      border-top-color: var(--primary-purple);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .post-card {
      background: rgba(40, 40, 40, 0.7);
      border-radius: 12px;
      overflow: hidden;
      transition: transform 0.3s ease;
    }
    
    .post-card:hover {
      transform: translateY(-3px);
    }
    
    .attachment-preview {
      max-height: 300px;
      object-fit: contain; /* Changed from cover to contain for better preview */
      border-radius: 8px;
      margin-top: 10px;
      background-color: #000;
    }
    
    .agenda-card {
      background: rgba(45, 45, 45, 0.7);
      border-left: 4px solid var(--primary-green);
      border-radius: 8px;
    }
    
    .role-badge {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 9999px;
      margin-left: 8px;
    }
    
    .admin-badge {
      background: linear-gradient(to right, #f59e0b, #ef4444);
    }
    
    .member-badge {
      background: linear-gradient(to right, #3b82f6, #8b5cf6);
    }
    
    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }
    
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(31, 31, 31, 0.5);
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--primary-purple);
      border-radius: 4px;
    }
    
    .file-upload-label {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      padding: 12px 16px;
      border-radius: 12px;
      background: rgba(55, 55, 55, 0.5);
      border: 1px dashed rgba(139, 92, 246, 0.5);
      transition: all 0.3s ease;
    }
    
    .file-upload-label:hover {
      border-color: var(--primary-purple);
      background: rgba(55, 55, 55, 0.7);
    }
    
    .admin-info-box {
      background: rgba(139, 92, 246, 0.1);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .admin-info-box h3 {
      color: var(--primary-purple);
      margin-bottom: 15px;
      font-weight: 600;
    }
    
    .admin-info-box ul {
      list-style-type: none;
      padding-left: 0;
    }
    
    .admin-info-box li {
      margin-bottom: 10px;
      padding-left: 25px;
      position: relative;
    }
    
    .admin-info-box li:before {
      content: "•";
      color: var(--primary-green);
      position: absolute;
      left: 0;
      font-size: 20px;
      line-height: 1;
    }
    
    .comment-box {
      background: rgba(50, 50, 50, 0.5);
      border-radius: 8px;
      padding: 10px;
      margin-top: 10px;
    }
    
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .action-button {
      background: rgba(70, 70, 70, 0.5);
      border: none;
      border-radius: 8px;
      padding: 5px 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .action-button:hover {
      background: rgba(90, 90, 90, 0.7);
    }
    
    .like-button.active {
      color: #EF4444;
    }
    
    .user-list-item {
      display: flex;
      align-items: center;
      padding: 12px;
      border-bottom: 1px solid rgba(70, 70, 70, 0.5);
    }
    
    .user-actions {
      margin-left: auto;
      display: flex;
      gap: 10px;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col">
  <header class="bg-black/80 py-4 px-6 border-b border-purple-900/50 sticky top-0 z-50">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-2xl font-bold gradient-text">Wallet QC Local Storage</h1>
      <div id="auth-section" class="flex items-center space-x-4">
        <span id="user-email" class="text-sm text-gray-300 hidden"></span>
        <span id="user-role" class="text-xs px-2 py-1 rounded-full bg-purple-600/50 hidden">Member</span>
        <button id="logout-btn" class="px-4 py-2 bg-red-600/80 hover:bg-red-500/90 rounded-lg text-sm hidden">
          Logout
        </button>
        <button id="login-btn" class="btn-primary">Login</button>
      </div>
    </div>
  </header>

  <main class="flex-grow container mx-auto px-4 py-8">
    <section id="auth-container" class="max-w-md mx-auto solana-card p-8">
      <div class="text-center mb-8">
        <h2 class="text-3xl font-bold gradient-text mb-2">Selamat Datang</h2>
        <p class="text-gray-400">Kelola kas tim QC dengan mudah dan aman</p>
      </div>

      <div class="flex border-b border-gray-800 mb-6">
        <button id="login-tab" class="flex-1 py-4 font-medium tab-active">
          Login
        </button>
        <button id="register-tab" class="flex-1 py-4 font-medium text-gray-400">
          Register
        </button>
        <button id="reset-tab" class="flex-1 py-4 font-medium text-gray-400">
          Reset Password
        </button>
      </div>

      <form id="login-form">
        <div class="space-y-4">
          <div>
            <label for="login-email" class="block text-sm mb-2 text-gray-300">Email</label>
            <input 
              type="email" 
              id="login-email" 
              required
              class="input-field"
              placeholder="email@contoh.com"
            >
          </div>
          <div>
            <label for="login-password" class="block text-sm mb-2 text-gray-300">Password</label>
            <input 
              type="password" 
              id="login-password" 
              required
              class="input-field"
              placeholder="••••••••"
            >
          </div>
          <button type="submit" class="btn-primary w-full">
            Masuk
          </button>
        </div>
      </form>

      <form id="register-form" class="hidden">
        <div class="space-y-4">
          <div>
            <label for="register-name" class="block text-sm mb-2 text-gray-300">Nama Lengkap</label>
            <input 
              type="text" 
              id="register-name" 
              required
              class="input-field"
              placeholder="Nama Anda"
            >
          </div>
          <div>
            <label for="register-email" class="block text-sm mb-2 text-gray-300">Email</label>
            <input 
              type="email" 
              id="register-email" 
              required
              class="input-field"
              placeholder="email@contoh.com"
            >
          </div>
          <div>
            <label for="register-password" class="block text-sm mb-2 text-gray-300">Password</label>
            <input 
              type="password" 
              id="register-password" 
              required
              class="input-field"
              placeholder="••••••••"
            >
          </div>
          <div class="hidden" id="admin-code-container">
            <label for="admin-code" class="block text-sm mb-2 text-gray-300">Kode Admin</label>
            <input 
              type="password" 
              id="admin-code" 
              class="input-field"
              placeholder="Masukkan kode admin"
            >
          </div>
          <div class="flex items-center">
            <input type="checkbox" id="is-admin" class="mr-2">
            <label for="is-admin" class="text-sm">Daftar sebagai Admin</label>
          </div>
          <button type="submit" class="btn-primary w-full">
            Daftar
          </button>
        </div>
      </form>
      
      <form id="reset-form" class="hidden">
        <div class="space-y-4">
          <div>
            <label for="reset-email" class="block text-sm mb-2 text-gray-300">Email</label>
            <input 
              type="email" 
              id="reset-email" 
              required
              class="input-field"
              placeholder="email@contoh.com"
            >
          </div>
          <button type="submit" class="btn-primary w-full">
            Kirim Link Reset Password
          </button>
        </div>
      </form>
      
      <div class="admin-info-box mt-6">
        <h3>Cara Masuk Sebagai Admin</h3>
        <ul>
          <li>Untuk akun yang sudah ada: Gunakan email dan password yang sudah didaftarkan</li>
          <li>Untuk membuat akun admin baru: Centang "Daftar sebagai Admin" dan masukkan kode admin: <strong>admin123</strong></li>
          <li>Akun demo admin: <strong>admin@walletqc.com</strong> / password: <strong>admin123</strong></li>
        </ul>
      </div>
      
      <div id="error-message" class="mt-4 text-center text-red-400 text-sm hidden"></div>
      <div id="success-message" class="mt-4 text-center text-green-400 text-sm hidden"></div>
    </section>

    <section id="dashboard" class="hidden">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-1 space-y-6">
          <div class="solana-card p-6">
            <div class="flex items-center space-x-4">
              <div class="relative">
                <div id="profile-avatar" class="user-avatar w-16 h-16 text-xl">
                  <span id="user-initial">U</span>
                </div>
                <img id="profile-image" class="absolute inset-0 w-16 h-16 rounded-full object-cover hidden" alt="Profile">
              </div>
              <div>
                <div class="flex items-center">
                  <h3 id="user-name" class="font-medium text-lg">User Name</h3>
                  <span id="role-badge" class="role-badge member-badge">Member</span>
                </div>
                <p id="user-email-display" class="text-sm text-gray-400">user@email.com</p>
                <div class="mt-2 text-sm">
                  <p>Kas Masuk: <span id="user-income" class="text-green-400">Rp 0</span></p>
                  <p>Kas Keluar: <span id="user-expense" class="text-red-400">Rp 0</span></p>
                  <p>Total Saldo: <span id="user-total-balance" class="font-medium">Rp 0</span></p>
                </div>
              </div>
            </div>
          </div>

          <div class="solana-card p-6">
            <h3 class="font-medium mb-4 text-purple-400">Menu Cepat</h3>
            <ul class="space-y-3">
              <li>
                <button id="show-kas" class="w-full text-left p-3 hover:bg-gray-800/50 rounded-lg flex items-center">
                  <span class="mr-3">💰</span> Kas & Transaksi
                </button>
              </li>
              <li>
                <button id="show-agenda" class="w-full text-left p-3 hover:bg-gray-800/50 rounded-lg flex items-center">
                  <span class="mr-3">📅</span> Agenda QC
                </button>
              </li>
              <li>
                <button id="show-sosial" class="w-full text-left p-3 hover:bg-gray-800/50 rounded-lg flex items-center">
                  <span class="mr-3">💬</span> Sosial Media
                </button>
              </li>
              <li class="admin-only">
                <button id="show-admin" class="w-full text-left p-3 hover:bg-gray-800/50 rounded-lg flex items-center">
                  <span class="mr-3">🔒</span> Admin Panel
                </button>
              </li>
              <li>
                <button id="show-setting" class="w-full text-left p-3 hover:bg-gray-800/50 rounded-lg flex items-center">
                  <span class="mr-3">⚙️</span> Pengaturan
                </button>
              </li>
            </ul>
          </div>

          <div class="solana-card bg-gradient-to-br from-purple-900/30 to-green-900/20 p-6">
            <h3 class="font-medium mb-2">Total Saldo</h3>
            <p id="total-saldo" class="text-3xl font-bold font-mono">Rp 0</p>
            <div class="mt-4 bg-black/20 rounded-lg p-3">
              <div class="flex justify-between mb-2">
                <span>Pemasukan</span>
                <span id="income-amount" class="text-green-400">+ Rp 0</span>
              </div>
              <div class="flex justify-between">
                <span>Pengeluaran</span>
                <span id="expense-amount" class="text-red-400">- Rp 0</span>
              </div>
            </div>
          </div>
        </div>

        <div class="lg:col-span-2 space-y-6">
          <section id="kas-section" class="solana-card p-6">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-xl font-semibold">Kas & Transaksi</h2>
              <div>
                <button id="print-transactions" class="px-4 py-2 bg-gray-700/50 hover:bg-gray-600/50 rounded-lg mr-2">
                  <i class="fas fa-print mr-1"></i> Cetak PDF
                </button>
                <button id="add-transaction-btn" class="btn-primary admin-only">
                  <i class="fas fa-plus mr-2"></i> Tambah Transaksi
                </button>
              </div>
            </div>
            
            <div class="mb-8">
              <h3 class="text-lg font-medium mb-4">Statistik Keuangan</h3>
              <div class="chart-container">
                <canvas id="finance-chart"></canvas>
              </div>
            </div>
            
            <form id="transaction-form" class="hidden space-y-4 mb-6">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
            <label class="block text-sm mb-2">Jenis Transaksi</label>
            <select id="transaction-type" class="input-field">
                <option value="masuk">Kas Masuk</option>
                <option value="keluar">Kas Keluar</option>
            </select>
        </div>
        <div>
            <label class="block text-sm mb-2">Jumlah (Rp)</label>
            <input type="number" id="transaction-amount" class="input-field" placeholder="1000000" required min="1">
        </div>
    </div>
    <div>
        <label class="block text-sm mb-2">Keterangan</label>
        <input type="text" id="transaction-desc" class="input-field" placeholder="Deskripsi transaksi" required>
    </div>

    <div class="form-group">
        <label class="block text-sm mb-2">Penerima Email</label>
        <div>
            <input type="radio" id="radioSemuaUser" name="penerimaEmail" value="semua_user" class="mr-2">
            <label for="radioSemuaUser" class="inline-block text-sm">Semua User</label>
        </div>
        <div>
            <input type="radio" id="radioPilihUser" name="penerimaEmail" value="pilih_user" class="mr-2">
            <label for="radioPilihUser" class="inline-block text-sm">Pilih User Tertentu</label>
        </div>
        <div>
            <input type="radio" id="radioInputManual" name="penerimaEmail" value="input_manual" class="mr-2">
            <label for="radioInputManual" class="inline-block text-sm">Input Manual</label>
        </div>

        <div id="emailInputContainer" class="mt-4 section-hidden">
            <label for="inputEmail" class="block text-sm mb-2">Email User (pisahkan dengan koma jika lebih dari satu):</label>
            <input type="email" id="inputEmail" name="emails" class="input-field" placeholder="contoh@domain.com, lain@domain.com" multiple>
        </div>

        <div id="allUserMessage" class="mt-2 section-hidden text-sm text-gray-400">
            <p>Transaksi ini akan dikirim ke semua user yang terdaftar.</p>
        </div>
    </div>
    <div class="flex justify-end space-x-3">
        <button type="button" id="cancel-transaction-btn" class="px-4 py-2 bg-gray-700/50 hover:bg-gray-600/50 rounded-lg">
            Batal
        </button>
        <button type="submit" class="btn-primary">
            Simpan Transaksi
        </button>
    </div>
</form>

            <div id="transactions-list" class="space-y-4 max-h-[500px] overflow-y-auto">
              <div class="text-center py-10">
                <div class="loading mx-auto"></div>
                <p class="mt-3 text-gray-400">Memuat data transaksi...</p>
              </div>
            </div>
          </section>
          
          <section id="agenda-section" class="solana-card p-6 hidden">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-xl font-semibold">Agenda QC</h2>
              <button id="add-agenda-btn" class="btn-primary admin-only">
                <i class="fas fa-plus mr-2"></i> Tambah Agenda
              </button>
            </div>

            <form id="agenda-form" class="hidden space-y-4 mb-6">
              <div>
                <label class="block text-sm mb-2">Judul Agenda</label>
                <input type="text" id="agenda-title" class="input-field" placeholder="Meeting QC" required>
              </div>
              <div>
                <label class="block text-sm mb-2">Deskripsi</label>
                <textarea id="agenda-desc" rows="3" class="input-field" placeholder="Detail agenda" required></textarea>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm mb-2">Tanggal</label>
                  <input type="date" id="agenda-date" class="input-field" required>
                </div>
                <div>
                  <label class="block text-sm mb-2">Lampiran</label>
                  <label for="agenda-file" class="file-upload-label">
                    <span id="agenda-file-name-display">Pilih file...</span>
                    <i class="fas fa-cloud-upload-alt"></i>
                  </label>
                  <input type="file" id="agenda-file" class="hidden">
                  <div id="agenda-attachment-preview" class="hidden mt-2 text-sm text-gray-400">
                    <span id="agenda-preview-name"></span>
                    <button type="button" id="remove-agenda-attachment" class="ml-2 text-red-400">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
              </div>
              <div class="flex justify-end space-x-3">
                <button type="button" id="cancel-agenda-btn" class="px-4 py-2 bg-gray-700/50 hover:bg-gray-600/50 rounded-lg">
                  Batal
                </button>
                <button type="submit" class="btn-primary">
                  Simpan Agenda
                </button>
              </div>
            </form>

            <div id="agenda-list" class="space-y-4 max-h-[600px] overflow-y-auto">
              <div class="text-center py-10">
                <div class="loading mx-auto"></div>
                <p class="mt-3 text-gray-400">Memuat data agenda...</p>
              </div>
            </div>
          </section>
          
          <section id="sosial-section" class="solana-card p-6 hidden">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-xl font-semibold">Sosial Media QC</h2>
            </div>

            <form id="post-form" class="space-y-4 mb-6">
              <div>
                <textarea id="post-content" rows="3" class="input-field" placeholder="Apa yang ingin Anda bagikan hari ini?" required></textarea>
              </div>
              <div class="flex justify-between items-center">
                <div class="flex items-center">
                  <label for="post-image" class="file-upload-label mr-3">
                    <span id="image-name-display">Lampirkan Gambar/Video</span>
                    <i class="fas fa-image"></i>
                  </label>
                  <input type="file" id="post-image" accept="image/*,video/*" class="hidden">
                </div>
                <button type="submit" class="btn-primary">
                  Posting
                </button>
              </div>
            </form>
            
            <div id="post-attachment-preview-container" class="hidden mt-4">
              <img id="preview-image" class="attachment-preview w-full" alt="Preview lampiran">
              <video id="preview-video" class="attachment-preview w-full hidden" controls></video>
              <button id="remove-attachment" class="mt-2 text-red-400 text-sm">
                <i class="fas fa-times mr-1"></i> Hapus lampiran
              </button>
            </div>
            
            <div id="social-feed" class="mt-8 space-y-6 max-h-[600px] overflow-y-auto">
              <div class="text-center py-10">
                <div class="loading mx-auto"></div>
                <p class="mt-3 text-gray-400">Memuat postingan...</p>
              </div>
            </div>
          </section>
          
          <section id="admin-section" class="solana-card p-6 hidden">
            <h2 class="text-xl font-semibold mb-6">Admin Panel</h2>
            
            <div class="flex border-b border-gray-800 mb-6">
              <button id="users-tab" class="py-3 px-4 font-medium tab-active">Users</button>
              <button id="transactions-admin-tab" class="py-3 px-4 font-medium text-gray-400">Transaksi</button>
              <button id="agendas-admin-tab" class="py-3 px-4 font-medium text-gray-400">Agenda</button>
            </div>
            
            <div id="users-admin-content">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium">Manajemen Pengguna</h3>
              </div>
              
              <div id="users-list" class="space-y-3 max-h-[500px] overflow-y-auto">
                <div class="text-center py-10">
                  <div class="loading mx-auto"></div>
                  <p class="mt-3 text-gray-400">Memuat data pengguna...</p>
                </div>
              </div>
            </div>
            
            <div id="transactions-admin-content" class="hidden">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium">Manajemen Transaksi</h3>
              </div>
              
              <div id="admin-transactions-list" class="space-y-4 max-h-[500px] overflow-y-auto">
                <div class="text-center py-10">
                  <div class="loading mx-auto"></div>
                  <p class="mt-3 text-gray-400">Memuat data transaksi...</p>
                </div>
              </div>
            </div>
            
            <div id="agendas-admin-content" class="hidden">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium">Manajemen Agenda</h3>
              </div>
              
              <div id="admin-agendas-list" class="space-y-4 max-h-[500px] overflow-y-auto">
                <div class="text-center py-10">
                  <div class="loading mx-auto"></div>
                  <p class="mt-3 text-gray-400">Memuat data agenda...</p>
                </div>
              </div>
            </div>
          </section>
          
          <section id="setting-section" class="solana-card p-6 hidden">
            <h2 class="text-xl font-semibold mb-6">Pengaturan Akun</h2>
            <form id="setting-form" class="space-y-6">
              <div class="flex items-center space-x-6">
                <div class="relative">
                  <div id="profile-avatar-setting" class="user-avatar w-24 h-24 text-2xl">
                    <span id="user-initial-setting">U</span>
                  </div>
                  <img id="profile-image-setting" class="absolute inset-0 w-24 h-24 rounded-full object-cover hidden" alt="Profile">
                  <label for="profile-image-input" class="absolute bottom-0 right-0 bg-purple-600 rounded-full p-2 cursor-pointer">
                    <i class="fas fa-camera text-white"></i>
                  </label>
                  <input type="file" id="profile-image-input" accept="image/*" class="hidden">
                </div>
                <div>
                  <h3 class="text-lg font-medium">Foto Profil</h3>
                  <p class="text-gray-400 text-sm">Ukuran maks. 5MB (JPG, PNG)</p>
                </div>
              </div>
              
              <div>
                <label class="block text-sm mb-2">Nama Lengkap</label>
                <input type="text" id="setting-name" class="input-field" placeholder="Nama Anda">
              </div>
              
              <div>
                <label class="block text-sm mb-2">Email</label>
                <input type="email" id="setting-email" class="input-field" disabled>
              </div>
              
              <div>
                <label class="block text-sm mb-2">Password Baru (biarkan kosong jika tidak ingin mengubah)</label>
                <input type="password" id="setting-password" class="input-field" placeholder="••••••••">
              </div>
              
              <div class="pt-4">
                <button type="submit" class="btn-primary mr-3">
                  Simpan Perubahan
                </button>
                <button type="button" id="delete-account-btn" class="px-4 py-2 bg-red-600/80 hover:bg-red-700 rounded-lg">
                  Hapus Akun
                </button>
              </div>
            </form>
          </section>
        </div>
      </div>
    </section>
  </main>

  <script>
    // Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyD0RL0zvv4DL9EBax3XouugVZpkHdzyVNQ",
  authDomain: "wallet-qc-local-storage.firebaseapp.com",
  projectId: "wallet-qc-local-storage",
  storageBucket: "wallet-qc-local-storage.appspot.com",
  messagingSenderId: "443546801664",
  appId: "1:443546801664:web:6d0342e1b8261dd920aae5",
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
const storage = firebase.storage(); // Jika Anda menggunakan Firebase Storage

// Collections references
const usersRef = db.collection('users');
const transactionsRef = db.collection('transactions');
const appDataRef = db.collection('global_metrics').doc('app_data'); // Dokumen tunggal untuk metrik global

// Global variables
let currentUser = null;
let editingTransactionId = null;

// ==================== HELPER FUNCTIONS ====================

// Fungsi untuk menampilkan pesan error
function showError(message) {
    const messageDiv = document.getElementById('message-div');
    if (messageDiv) {
        messageDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
            <strong class="font-bold">Error!</strong>
            <span class="block sm:inline">${message}</span>
            <span class="absolute top-0 bottom-0 right-0 px-4 py-3 close-btn" onclick="this.parentElement.style.display='none';">
                <svg class="fill-current h-6 w-6 text-red-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.103l-2.651 3.746a1.2 1.2 0 0 1-1.697-1.697l3.746-2.651-3.746-2.651a1.2 1.2 0 0 1 1.697-1.697l2.651 3.746 2.651-3.746a1.2 1.2 0 0 1 1.697 1.697l-3.746 2.651 3.746 2.651a1.2 1.2 0 0 1 0 1.697z"/></svg>
            </span>
        </div>`;
        messageDiv.classList.remove('hidden');
    }
}

// Fungsi untuk menampilkan pesan sukses
function showSuccess(message) {
    const messageDiv = document.getElementById('message-div');
    if (messageDiv) {
        messageDiv.innerHTML = `<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative" role="alert">
            <strong class="font-bold">Sukses!</strong>
            <span class="block sm:inline">${message}</span>
            <span class="absolute top-0 bottom-0 right-0 px-4 py-3 close-btn" onclick="this.parentElement.style.display='none';">
                <svg class="fill-current h-6 w-6 text-green-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.103l-2.651 3.746a1.2 1.2 0 0 1-1.697-1.697l3.746-2.651-3.746-2.651a1.2 1.2 0 0 1 1.697-1.697l2.651 3.746 2.651-3.746a1.2 1.2 0 0 1 0 1.697z"/></svg>
            </span>
        </div>`;
        messageDiv.classList.remove('hidden');
    }
}

// Fungsi untuk memformat angka menjadi Rupiah
function formatRupiah(number) {
    return new Intl.NumberFormat('id-ID', {
        style: 'currency',
        currency: 'IDR',
        minimumFractionDigits: 0
    }).format(number);
}

// Fungsi untuk memperbarui tampilan saldo di UI
function updateBalance(totalIncome = 0, totalExpense = 0) {
    const balance = totalIncome - totalExpense;

    // --- Update elemen-elemen di bagian atas (Kas Masuk, Kas Keluar, Total Saldo) ---
    const userIncomeElement = document.getElementById('user-income');
    const userExpenseElement = document.getElementById('user-expense');
    const userTotalBalanceElement = document.getElementById('user-total-balance');

    if (userIncomeElement) {
        userIncomeElement.textContent = formatRupiah(totalIncome);
    } else {
        console.warn("Elemen HTML dengan ID 'user-income' tidak ditemukan.");
    }
    if (userExpenseElement) {
        userExpenseElement.textContent = formatRupiah(totalExpense);
    } else {
        console.warn("Elemen HTML dengan ID 'user-expense' tidak ditemukan.");
    }
    if (userTotalBalanceElement) {
        userTotalBalanceElement.textContent = formatRupiah(balance);
    } else {
        console.warn("Elemen HTML dengan ID 'user-total-balance' tidak ditemukan.");
    }

    // --- Update elemen-elemen di 'Solana Card' (Pemasukan, Pengeluaran, Total Saldo besar) ---
    const incomeAmountElement = document.getElementById('income-amount');
    const expenseAmountElement = document.getElementById('expense-amount');
    const totalSaldoElement = document.getElementById('total-saldo');

    if (incomeAmountElement) {
        incomeAmountElement.textContent = '+ ' + formatRupiah(totalIncome);
    } else {
        console.warn("Elemen HTML dengan ID 'income-amount' (Solana Card) tidak ditemukan.");
    }
    if (expenseAmountElement) {
        expenseAmountElement.textContent = '- ' + formatRupiah(totalExpense);
    } else {
        console.warn("Elemen HTML dengan ID 'expense-amount' (Solana Card) tidak ditemukan.");
    }
    if (totalSaldoElement) {
        totalSaldoElement.textContent = formatRupiah(balance);
    } else {
        console.warn("Elemen HTML dengan ID 'total-saldo' (Solana Card) tidak ditemukan.");
    }

    // Perbarui chart keuangan (pastikan fungsi ini ada di kode Anda)
    if (typeof updateFinanceChart === 'function') {
        updateFinanceChart(totalIncome, totalExpense);
    }
}

// Fungsi untuk mereset saldo user ke 0
async function resetUserBalance(userId) {
    const userDocRef = usersRef.doc(userId);
    return db.runTransaction(async (transaction) => {
        const userDoc = await transaction.get(userDocRef);
        if (userDoc.exists) {
            const userData = userDoc.data();
            if (userData.totalIncome !== 0 || userData.totalExpense !== 0) {
                transaction.update(userDocRef, {
                    totalIncome: 0,
                    totalExpense: 0
                });
            }
        }
    });
}

// Fungsi untuk memformat daftar penerima
function formatRecipients(recipients) {
    if (recipients.includes('ALL_USERS')) return 'Semua User';
    return recipients.slice(0, 3).join(', ') + (recipients.length > 3 ? '...' : '');
}

// Fungsi untuk mengatur event listener tombol edit dan delete transaksi
function setupTransactionActions() {
    if (currentUser?.role === 'admin') {
        document.querySelectorAll('.edit-transaction').forEach(btn => {
            btn.addEventListener('click', (e) => editTransaction(e.target.dataset.id));
        });

        document.querySelectorAll('.delete-transaction').forEach(btn => {
            btn.addEventListener('click', (e) => deleteTransaction(e.target.dataset.id));
        });
    }
}

// ==================== AUTHENTICATION ====================

// Event listener untuk login
document.getElementById('login-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
   console.log("Login form submitted!");
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;

    try {
        await auth.signInWithEmailAndPassword(email, password);
        showSuccess("Login berhasil!");
    } catch (error) {
        showError("Gagal login: " + error.message);
        console.error("Login error:", error);
    }
});

// Event listener untuk register
document.getElementById('register-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('register-name').value;
    const email = document.getElementById('register-email').value;
    const password = document.getElementById('register-password').value;

    try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        await userCredential.user.updateProfile({
            displayName: name
        });

        // Simpan data user ke Firestore
        await usersRef.doc(userCredential.user.uid).set({
            name: name,
            email: email,
            role: 'user', // Default role
            totalIncome: 0,
            totalExpense: 0,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        showSuccess("Registrasi berhasil! Silakan login.");
    } catch (error) {
        showError("Gagal registrasi: " + error.message);
        console.error("Register error:", error);
    }
});

// Event listener untuk logout
document.getElementById('logout-btn')?.addEventListener('click', async () => {
    try {
        await auth.signOut();
        showSuccess("Logout berhasil!");
    } catch (error) {
        showError("Gagal logout: " + error.message);
        console.error("Logout error:", error);
    }
});

// Mengelola perubahan status autentikasi
auth.onAuthStateChanged(async (user) => {
    const authSection = document.getElementById('auth-section');
    const dashboardSection = document.getElementById('dashboard-section');
    const adminDashboardSection = document.getElementById('admin-dashboard-section');
    const userEmailDisplay = document.getElementById('user-email-display');
    const userNameDisplay = document.getElementById('user-name-display');

    if (user) {
        // User is signed in.
        currentUser = user;
        const userDoc = await usersRef.doc(user.uid).get();
        if (userDoc.exists) {
            currentUser = { ...user, ...userDoc.data() };
        } else {
            // Jika dokumen user tidak ada, buat dokumen baru (misal setelah migrasi atau jika user dibuat di tempat lain)
            await usersRef.doc(user.uid).set({
                name: user.displayName || 'Unknown User',
                email: user.email,
                role: 'user', // Default role jika tidak ada di Firestore
                totalIncome: 0,
                totalExpense: 0,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true }); // Gunakan merge agar tidak menimpa field lain jika sudah ada
            currentUser = { ...user, name: user.displayName || 'Unknown User', email: user.email, role: 'user', totalIncome: 0, totalExpense: 0 };
        }

        if (authSection) authSection.classList.add('hidden');
        if (dashboardSection) dashboardSection.classList.remove('hidden');
        if (userEmailDisplay) userEmailDisplay.textContent = currentUser.email;
        if (userNameDisplay) userNameDisplay.textContent = currentUser.name || currentUser.email;

        if (currentUser.role === 'admin') {
            if (adminDashboardSection) adminDashboardSection.classList.remove('hidden');
            // Jika ada tab admin, set tab default ke 'users' atau 'transactions'
            document.getElementById('transactions-admin-content')?.classList.remove('hidden'); // Show transactions by default for admin
            document.getElementById('transactions-admin-tab')?.classList.add('tab-active');
            document.getElementById('users-admin-content')?.classList.add('hidden');
            document.getElementById('agendas-admin-content')?.classList.add('hidden');
            document.getElementById('users-tab')?.classList.remove('tab-active');
            document.getElementById('agendas-admin-tab')?.classList.remove('tab-active');
            loadAdminTransactions(); // Load admin transactions by default
        } else {
            if (adminDashboardSection) adminDashboardSection.classList.add('hidden');
            // Load user-specific data
            loadTransactions();
            loadUserData(); // Panggil ini untuk user biasa juga
        }

    } else {
        // User is signed out.
        currentUser = null;
        if (authSection) authSection.classList.remove('hidden');
        if (dashboardSection) dashboardSection.classList.add('hidden');
        if (adminDashboardSection) adminDashboardSection.classList.add('hidden');
        // Reset UI atau tampilkan pesan login
        updateBalance(0, 0); // Reset UI saldo
    }
});


// ==================== LOAD TRANSACTIONS (User & Admin Dashboard) ====================

function loadTransactions() {
    const transactionsList = document.getElementById('transactions-list');

    transactionsList.innerHTML = `
        <div class="text-center py-10">
            <div class="loading mx-auto"></div>
            <p class="mt-3 text-gray-400">Memuat data transaksi...</p>
        </div>
    `;

    transactionsRef.orderBy('date', 'desc').get().then(async (snapshot) => {
        transactionsList.innerHTML = '';

        let totalIncome = 0;
        let totalExpense = 0;

        // Handle empty state
        if (snapshot.empty) {
            transactionsList.innerHTML = `
                <p class="text-center py-6 text-gray-400">Belum ada transaksi</p>
            `;

            // --- Perbaikan di sini: Pastikan reset saldo user/global selesai sebelum updateBalance ---
            let resetPromises = [];
            if (currentUser?.uid) {
                resetPromises.push(resetUserBalance(currentUser.uid)
                    .then(() => console.log("Saldo user direset ke 0 karena tidak ada transaksi."))
                    .catch(error => console.error("Gagal mereset saldo user:", error))
                );
            }
            // Juga reset saldo global jika tidak ada transaksi sama sekali
            resetPromises.push(
                db.runTransaction(async (transaction) => {
                    const globalMetricsDocRef = appDataRef;
                    const globalMetricsDoc = await transaction.get(globalMetricsDocRef); // Baca global_metrics
                    if (globalMetricsDoc.exists) {
                        const globalData = globalMetricsDoc.data();
                        if ((globalData.totalAppIncome || 0) !== 0 || (globalData.totalAppExpense || 0) !== 0) {
                            transaction.update(globalMetricsDocRef, {
                                totalAppIncome: 0,
                                totalAppExpense: 0,
                                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            console.log("Saldo global direset menjadi 0 karena tidak ada transaksi.");
                        }
                    } else {
                        transaction.set(globalMetricsDocRef, { // Inisialisasi jika belum ada
                            totalAppIncome: 0,
                            totalAppExpense: 0,
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        console.log("Dokumen global_metrics diinisialisasi ke 0.");
                    }
                })
                .catch(error => console.error("Gagal mereset/menginisialisasi saldo global:", error))
            );

            await Promise.all(resetPromises); // Tunggu semua operasi reset selesai

            updateBalance(0, 0); // Panggil updateBalance dengan 0,0 setelah semua reset selesai
            return;
        }

        // Tampilkan transaksi
        snapshot.forEach(doc => {
            const transaction = doc.data();

            // Hitung total (ini akan dilakukan setelah loop)
            if (transaction.type === 'masuk') {
                totalIncome += transaction.amount;
            } else {
                totalExpense += transaction.amount;
            }

            // Format tanggal
            const transactionDate = transaction.date?.toDate() || new Date();
            const formattedDate = transactionDate.toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });

            // Buat elemen transaksi
            const transactionElement = document.createElement('div');
            transactionElement.className = `p-4 rounded-lg mb-3 ${
                transaction.type === 'masuk'
                    ? 'bg-green-50 border border-green-100'
                    : 'bg-red-50 border border-red-100'
            }`;

            transactionElement.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <h4 class="font-medium text-gray-800">${transaction.description}</h4>
                        <p class="text-sm text-gray-500 mt-1">${formattedDate}</p>
                        ${transaction.recipients ? `
                            <p class="text-xs text-gray-400 mt-2">
                                <i class="fas fa-envelope mr-1"></i>
                                ${formatRecipients(transaction.recipients)}
                            </p>
                        ` : ''}
                    </div>
                    <div class="text-right">
                        <p class="${
                            transaction.type === 'masuk'
                                ? 'text-green-600'
                                : 'text-red-600'
                        } font-mono font-medium">
                            ${transaction.type === 'masuk' ? '+' : '-'}
                            ${formatRupiah(transaction.amount)}
                        </p>
                        <p class="text-xs text-gray-500 mt-1">${transaction.userName}</p>
                    </div>
                </div>
                ${currentUser?.role === 'admin' ? `
                    <div class="flex gap-2 mt-3">
                        <button class="edit-transaction px-3 py-1 bg-blue-50 text-blue-600 rounded text-sm"
                                data-id="${doc.id}">
                            <i class="fas fa-edit mr-1"></i> Edit
                        </button>
                        <button class="delete-transaction px-3 py-1 bg-red-50 text-red-600 rounded text-sm"
                                data-id="${doc.id}">
                            <i class="fas fa-trash mr-1"></i> Hapus
                        </button>
                    </div>
                ` : ''}
            `;

            transactionsList.appendChild(transactionElement);
        });

        // Panggil updateBalance dengan totalIncome dan totalExpense yang sudah dihitung
        updateBalance(totalIncome, totalExpense);

        // Setup event listeners untuk admin (edit/delete)
        setupTransactionActions();

    }).catch(error => {
        console.error("Error loading transactions:", error);
        transactionsList.innerHTML = `
            <p class="text-center py-6 text-red-500">
                <i class="fas fa-exclamation-circle mr-2"></i>
                Gagal memuat transaksi: ${error.message}
            </p>
        `;
        updateBalance(0, 0); // Tetap update saldo meskipun ada error
    });
}

// Fungsi untuk memuat data user (saldo pribadi)
async function loadUserData() {
    if (!currentUser || !currentUser.uid) {
        console.warn("User tidak login atau UID tidak tersedia.");
        return;
    }

    try {
        const userDoc = await usersRef.doc(currentUser.uid).get();
        if (userDoc.exists) {
            const userData = userDoc.data();
            updateBalance(userData.totalIncome || 0, userData.totalExpense || 0);
        } else {
            console.warn("Dokumen user tidak ditemukan di Firestore.");
            updateBalance(0, 0); // Reset UI jika dokumen tidak ada
        }
    } catch (error) {
        console.error("Gagal memuat data user:", error);
        updateBalance(0, 0); // Reset UI jika ada error
    }
}


// Fungsi untuk memuat transaksi di Admin Dashboard
async function loadAdminTransactions() {
    const adminTransactionsList = document.getElementById('admin-transactions-list');
    if (!adminTransactionsList) return;

    adminTransactionsList.innerHTML = `
        <div class="text-center py-10">
            <div class="loading mx-auto"></div>
            <p class="mt-3 text-gray-400">Memuat data transaksi admin...</p>
        </div>
    `;

    try {
        const snapshot = await transactionsRef.orderBy('date', 'desc').get();
        adminTransactionsList.innerHTML = '';

        if (snapshot.empty) {
            adminTransactionsList.innerHTML = `
                <p class="text-center py-6 text-gray-400">Belum ada transaksi di sistem.</p>
            `;
            // Untuk admin, saldo dashboard utama tetap dari loadUserData atau global_metrics
            return;
        }

        snapshot.forEach(doc => {
            const transaction = doc.data();
            const transactionDate = transaction.date?.toDate() || new Date();
            const formattedDate = transactionDate.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });

            const transactionElement = document.createElement('div');
            transactionElement.className = `p-4 rounded-lg mb-3 ${
                transaction.type === 'masuk' ? 'bg-green-50 border border-green-100' : 'bg-red-50 border border-red-100'
            }`;

            transactionElement.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <h4 class="font-medium text-gray-800">${transaction.description}</h4>
                        <p class="text-sm text-gray-500 mt-1">${formattedDate}</p>
                        ${transaction.recipients ? `
                            <p class="text-xs text-gray-400 mt-2">
                                <i class="fas fa-envelope mr-1"></i>
                                ${formatRecipients(transaction.recipients)}
                            </p>
                        ` : ''}
                    </div>
                    <div class="text-right">
                        <p class="${
                            transaction.type === 'masuk' ? 'text-green-600' : 'text-red-600'
                        } font-mono font-medium">
                            ${transaction.type === 'masuk' ? '+' : '-'}
                            ${formatRupiah(transaction.amount)}
                        </p>
                        <p class="text-xs text-gray-500 mt-1">Oleh: ${transaction.userName}</p>
                    </div>
                </div>
                ${currentUser?.role === 'admin' ? `
                    <div class="flex gap-2 mt-3">
                        <button class="edit-transaction px-3 py-1 bg-blue-50 text-blue-600 rounded text-sm"
                                data-id="${doc.id}">
                            <i class="fas fa-edit mr-1"></i> Edit
                        </button>
                        <button class="delete-transaction px-3 py-1 bg-red-50 text-red-600 rounded text-sm"
                                data-id="${doc.id}">
                            <i class="fas fa-trash mr-1"></i> Hapus
                        </button>
                    </div>
                ` : ''}
            `;
            adminTransactionsList.appendChild(transactionElement);
        });
        setupTransactionActions(); // Setup tombol edit/delete untuk admin
    } catch (error) {
        console.error("Error loading admin transactions:", error);
        adminTransactionsList.innerHTML = `
            <p class="text-center py-6 text-red-500">
                <i class="fas fa-exclamation-circle mr-2"></i>
                Gagal memuat transaksi admin: ${error.message}
            </p>
        `;
    }
}


// Fungsi untuk memuat user di Admin Dashboard
async function loadUsers() {
    const usersList = document.getElementById('users-list');
    if (!usersList) return;

    usersList.innerHTML = `
        <div class="text-center py-10">
            <div class="loading mx-auto"></div>
            <p class="mt-3 text-gray-400">Memuat data user...</p>
        </div>
    `;

    try {
        const snapshot = await usersRef.get();
        usersList.innerHTML = '';

        if (snapshot.empty) {
            usersList.innerHTML = `
                <p class="text-center py-6 text-gray-400">Belum ada user terdaftar.</p>
            `;
            return;
        }

        snapshot.forEach(doc => {
            const user = doc.data();
            const userElement = document.createElement('div');
            userElement.className = `p-4 rounded-lg mb-3 bg-white border border-gray-200`;
            userElement.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <h4 class="font-medium text-gray-800">${user.name || 'Nama Tidak Ditetapkan'}</h4>
                        <p class="text-sm text-gray-500">${user.email}</p>
                        <p class="text-xs text-gray-400 mt-1">Role: ${user.role}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-green-600">Masuk: ${formatRupiah(user.totalIncome || 0)}</p>
                        <p class="text-sm text-red-600">Keluar: ${formatRupiah(user.totalExpense || 0)}</p>
                        <p class="text-md font-bold mt-1">Saldo: ${formatRupiah((user.totalIncome || 0) - (user.totalExpense || 0))}</p>
                    </div>
                </div>
            `;
            usersList.appendChild(userElement);
        });
    } catch (error) {
        console.error("Error loading users:", error);
        usersList.innerHTML = `
            <p class="text-center py-6 text-red-500">
                <i class="fas fa-exclamation-circle mr-2"></i>
                Gagal memuat user: ${error.message}
            </p>
        `;
    }
}

// Fungsi untuk memuat agenda (jika ada)
async function loadAdminAgendas() {
    const agendasList = document.getElementById('agendas-list'); // Pastikan Anda memiliki elemen ini
    if (!agendasList) return;

    agendasList.innerHTML = `
        <div class="text-center py-10">
            <div class="loading mx-auto"></div>
            <p class="mt-3 text-gray-400">Memuat data agenda...</p>
        </div>
    `;

    // Contoh: Asumsi Anda memiliki koleksi 'agendas'
    try {
        const snapshot = await db.collection('agendas').orderBy('date', 'desc').get();
        agendasList.innerHTML = '';

        if (snapshot.empty) {
            agendasList.innerHTML = `
                <p class="text-center py-6 text-gray-400">Belum ada agenda.</p>
            `;
            return;
        }

        snapshot.forEach(doc => {
            const agenda = doc.data();
            const agendaDate = agenda.date?.toDate() || new Date();
            const formattedDate = agendaDate.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });

            const agendaElement = document.createElement('div');
            agendaElement.className = `p-4 rounded-lg mb-3 bg-blue-50 border border-blue-100`;
            agendaElement.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <h4 class="font-medium text-gray-800">${agenda.title}</h4>
                        <p class="text-sm text-gray-500 mt-1">${formattedDate}</p>
                        <p class="text-xs text-gray-400 mt-2">${agenda.description}</p>
                    </div>
                </div>
            `;
            agendasList.appendChild(agendaElement);
        });
    } catch (error) {
        console.error("Error loading agendas:", error);
        agendasList.innerHTML = `
            <p class="text-center py-6 text-red-500">
                <i class="fas fa-exclamation-circle mr-2"></i>
                Gagal memuat agenda: ${error.message}
            </p>
        `;
    }
}


// ==================== TRANSACTION ACTIONS (ADD, EDIT, DELETE) ====================

// Event listener untuk submit form transaksi (ADD/EDIT)
document.getElementById('transaction-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const type = document.getElementById('transaction-type').value;
    const amount = parseFloat(document.getElementById('transaction-amount').value);
    const description = document.getElementById('transaction-desc').value;
    const selectedRecipientType = document.querySelector('input[name="recipient-type"]:checked')?.value;
    const recipientEmailsInput = document.getElementById('recipient-emails-input')?.value;

    // Pastikan currentUser tersedia
    if (!currentUser || !currentUser.uid || !currentUser.displayName || !currentUser.email || !currentUser.role) {
        showError("Data user tidak lengkap. Silakan login ulang.");
        return;
    }

    // Validasi input
    if (isNaN(amount) || amount <= 0) {
        showError("Jumlah harus angka positif.");
        return;
    }
    if (!description.trim()) {
        showError("Deskripsi tidak boleh kosong.");
        return;
    }

    let recipientEmails = [];
    if (selectedRecipientType === 'semua_user') {
        recipientEmails.push('ALL_USERS');
    } else if (selectedRecipientType === 'pilih_user' || selectedRecipientType === 'input_manual') {
        recipientEmails = recipientEmailsInput.split(',').map(email => email.trim()).filter(email => email);
        if (recipientEmails.length === 0) {
            showError("Harap masukkan setidaknya satu email penerima.");
            return;
        }
    }

    const transactionData = {
        userId: currentUser.uid,
        userName: currentUser.displayName,
        userEmail: currentUser.email, // Tambahkan email user yang membuat transaksi
        type,
        amount,
        description,
        date: firebase.firestore.FieldValue.serverTimestamp(), // Gunakan server timestamp
        recipients: recipientEmails.length > 0 ? recipientEmails : [],
        recipientType: selectedRecipientType
    };

    // Mode Tambah / Edit
    if (editingTransactionId) {
        // Mode Edit (Logic yang lebih kompleks akan dibutuhkan untuk edit transaksi
        // yang mempengaruhi saldo user, karena perlu menghitung ulang saldo lama vs baru.
        // Untuk saat ini, asumsikan edit hanya mengubah deskripsi/tipe, bukan amount/recipient.)
        // Untuk edit yang melibatkan amount/recipient, Anda harus:
        // 1. Baca transaksi lama.
        // 2. Hitung dampak transaksi lama pada saldo user/global.
        // 3. Revert dampak transaksi lama.
        // 4. Hitung dampak transaksi baru.
        // 5. Aplikasikan dampak transaksi baru.
        showError("Fungsi edit transaksi yang mempengaruhi saldo belum sepenuhnya diimplementasikan. Harap hapus dan buat ulang.");
        return;
    } else {
        // Mode Tambah
        try {
            await db.runTransaction(async (transaction) => {
                console.log("Starting add new transaction transaction...");

                const newTransactionRef = transactionsRef.doc(); // Referensi dokumen transaksi baru

                // --- FASE 1: SEMUA OPERASI BACA ---
                // Baca data saldo global terlebih dahulu
                const globalMetricsDocRef = appDataRef;
                const globalMetricsDoc = await transaction.get(globalMetricsDocRef);
                let globalData = globalMetricsDoc.data() || { totalAppIncome: 0, totalAppExpense: 0 };

                let usersToUpdate = []; // Array untuk menyimpan referensi dan data user yang perlu diperbarui

                if (selectedRecipientType === 'semua_user') {
                    console.log("Reading all users' balances for 'semua_user' transaction.");
                    const allUsersSnapshot = await usersRef.get(); // Baca semua user
                    console.log(`Found ${allUsersSnapshot.size} users to update.`);

                    if (allUsersSnapshot.empty) {
                        console.warn("No users found in 'users' collection to update for 'semua_user'.");
                    }
                    allUsersSnapshot.docs.forEach(userDoc => {
                        usersToUpdate.push({ ref: usersRef.doc(userDoc.id), data: userDoc.data() });
                    });
                } else if (selectedRecipientType === 'pilih_user' || selectedRecipientType === 'input_manual') {
                    console.log(`Reading selected users' balances for ${recipientEmails.length} recipients.`);
                    const userReadPromises = recipientEmails.map(async (email) => {
                        const userQuerySnapshot = await usersRef.where('email', '==', email).limit(1).get();
                        if (!userQuerySnapshot.empty) {
                            const userDoc = userQuerySnapshot.docs[0];
                            return { ref: usersRef.doc(userDoc.id), data: userDoc.data() };
                        }
                        console.warn(`User with email ${email} not found. Skipping read for update.`);
                        return null;
                    });
                    const fetchedUsers = await Promise.all(userReadPromises);
                    usersToUpdate = fetchedUsers.filter(u => u !== null); // Filter out nulls

                    if (usersToUpdate.length === 0) {
                        throw new Error("Tidak ada user penerima yang valid ditemukan.");
                    }

                } else {
                    // Ini untuk transaksi ke diri sendiri (admin)
                    console.log("Reading current user's balance.");
                    const currentUserDocRef = usersRef.doc(currentUser.uid);
                    const currentUserDoc = await transaction.get(currentUserDocRef);
                    if (!currentUserDoc.exists) {
                        throw new Error("Dokumen user saat ini tidak ditemukan.");
                    }
                    usersToUpdate.push({ ref: currentUserDocRef, data: currentUserDoc.data() });
                }

                // --- FASE 2: SEMUA OPERASI TULIS ---

                // 1. Simpan Transaksi Baru
                console.log("Saving new transaction with ID:", newTransactionRef.id);
                transaction.set(newTransactionRef, transactionData);

                // 2. Update Saldo User/Users yang Terlibat
                for (const user of usersToUpdate) {
                    let newTotalIncome = user.data.totalIncome || 0;
                    let newTotalExpense = user.data.totalExpense || 0;

                    if (type === 'masuk') {
                        newTotalIncome += amount;
                    } else {
                        newTotalExpense += amount;
                    }
                    console.log(`Updating user ${user.ref.id} (${user.data.email || user.data.name || 'N/A'}): Income=${newTotalIncome}, Expense=${newTotalExpense}`);
                    transaction.update(user.ref, {
                        totalIncome: newTotalIncome,
                        totalExpense: newTotalExpense
                    });
                }

                // 3. Update Saldo Global
                console.log("Updating global balance.");
                let newTotalAppIncome = globalData.totalAppIncome;
                let newTotalAppExpense = globalData.totalAppExpense;

                if (type === 'masuk') {
                    newTotalAppIncome += amount;
                } else {
                    newTotalAppExpense += amount;
                }
                transaction.update(globalMetricsDocRef, {
                    totalAppIncome: newTotalAppIncome,
                    totalAppExpense: newTotalAppExpense,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
            });

            showSuccess("Transaksi berhasil ditambahkan!");
        } catch (error) {
            showError("Gagal menambahkan transaksi: " + error.message);
            console.error("Firestore transaction failed (Add Mode):", error);
        } finally {
            document.getElementById('transaction-form').classList.add('hidden');
            document.getElementById('transaction-form').reset();
            // Setelah transaksi, muat ulang yang relevan
            if (currentUser?.role === 'admin') {
                loadAdminTransactions(); // Admin mungkin ingin melihat semua transaksi
                loadUserData(); // Admin juga perlu mengupdate saldo pribadi mereka
            } else {
                loadTransactions(); // User biasa hanya melihat transaksi mereka
                loadUserData(); // User biasa perlu mengupdate saldo pribadi mereka
            }
        }
    }
});


// Fungsi untuk mengambil data transaksi untuk diedit (belum mengimplementasikan logika update saldo)
function editTransaction(id) {
    transactionsRef.doc(id).get().then(doc => {
        if (doc.exists) {
            const transaction = doc.data();
            document.getElementById('transaction-type').value = transaction.type;
            document.getElementById('transaction-amount').value = transaction.amount;
            document.getElementById('transaction-desc').value = transaction.description;
            // Logika untuk mengisi recipient-type dan recipient-emails-input jika ada
            if (transaction.recipientType) {
                document.querySelector(`input[name="recipient-type"][value="${transaction.recipientType}"]`).checked = true;
                if (transaction.recipientType === 'pilih_user' || transaction.recipientType === 'input_manual') {
                    document.getElementById('recipient-emails-input').value = transaction.recipients.filter(r => r !== 'ALL_USERS').join(', ');
                    document.getElementById('recipient-emails-group').classList.remove('hidden');
                } else {
                    document.getElementById('recipient-emails-group').classList.add('hidden');
                }
            } else { // Default ke self jika tidak ada recipientType
                document.querySelector('input[name="recipient-type"][value="self"]').checked = true;
                document.getElementById('recipient-emails-group').classList.add('hidden');
            }

            document.getElementById('transaction-form').classList.remove('hidden');
            editingTransactionId = id;
            showSuccess("Anda sedang mengedit transaksi ini. Perubahan pada jumlah atau penerima tidak akan memperbarui saldo secara otomatis.");
        } else {
            showError("Transaksi tidak ditemukan.");
        }
    }).catch(error => {
        showError("Gagal mengambil transaksi untuk diedit: " + error.message);
    });
}

// Fungsi untuk menghapus transaksi
function deleteTransaction(id) {
    if (confirm("Apakah Anda yakin ingin menghapus transaksi ini?")) {
        db.runTransaction(async (transaction) => {
            // --- FASE 1: SEMUA OPERASI BACA ---
            const transactionDocRef = transactionsRef.doc(id);
            const transactionDoc = await transaction.get(transactionDocRef);

            if (!transactionDoc.exists) {
                throw new Error("Transaksi tidak ditemukan.");
            }
            const transactionData = transactionDoc.data();

            // Baca data saldo global
            const globalMetricsDocRef = appDataRef;
            const globalMetricsDoc = await transaction.get(globalMetricsDocRef);
            let globalData = globalMetricsDoc.data() || { totalAppIncome: 0, totalAppExpense: 0 };

            // Kumpulkan user yang perlu di-update saldonya karena transaksi ini dihapus
            let usersToRevert = [];

            // Logika untuk menentukan user mana yang saldonya terpengaruh oleh transaksi ini
            if (transactionData.recipientType === 'semua_user' || (transactionData.recipients && transactionData.recipients.includes('ALL_USERS'))) {
                // Jika transaksi ini sebelumnya mempengaruhi semua user, maka baca semua user
                const allUsersSnapshot = await usersRef.get();
                allUsersSnapshot.docs.forEach(userDoc => {
                    usersToRevert.push({ ref: usersRef.doc(userDoc.id), data: userDoc.data() });
                });
            } else if (transactionData.recipients && transactionData.recipients.length > 0) {
                // Jika transaksi ini mempengaruhi user spesifik, baca user-user tersebut
                const recipientReadPromises = transactionData.recipients.map(async (email) => {
                    const userQuerySnapshot = await usersRef.where('email', '==', email).limit(1).get();
                    if (!userQuerySnapshot.empty) {
                        const userDoc = userQuerySnapshot.docs[0];
                        return { ref: usersRef.doc(userDoc.id), data: userDoc.data() };
                    }
                    console.warn(`User with email ${email} associated with deleted transaction not found.`);
                    return null;
                });
                const fetchedRecipients = await Promise.all(recipientReadPromises);
                usersToRevert = fetchedRecipients.filter(u => u !== null);
            } else {
                // Jika transaksi hanya untuk pembuatnya (admin), baca user itu sendiri
                const userDocRef = usersRef.doc(transactionData.userId); // userId dari transaksi
                const userDoc = await transaction.get(userDocRef);
                if (userDoc.exists) {
                    usersToRevert.push({ ref: userDocRef, data: userDoc.data() });
                }
            }

            // --- FASE 2: SEMUA OPERASI TULIS ---

            // 1. Revert saldo user/users yang terkait
            for (const user of usersToRevert) {
                let newTotalIncome = user.data.totalIncome || 0;
                let newTotalExpense = user.data.totalExpense || 0;

                if (transactionData.type === 'masuk') {
                    newTotalIncome -= transactionData.amount; // Kurangi karena transaksi masuk dihapus
                } else {
                    newTotalExpense -= transactionData.amount; // Kurangi karena transaksi keluar dihapus
                }
                transaction.update(user.ref, {
                    totalIncome: newTotalIncome,
                    totalExpense: newTotalExpense
                });
                console.log(`Reverting user ${user.ref.id}: Income=${newTotalIncome}, Expense=${newTotalExpense}`);
            }

            // 2. Revert saldo global
            let newTotalAppIncome = globalData.totalAppIncome;
            let newTotalAppExpense = globalData.totalAppExpense;

            if (transactionData.type === 'masuk') {
                newTotalAppIncome -= transactionData.amount;
            } else {
                newTotalAppExpense -= transactionData.amount;
            }
            transaction.update(globalMetricsDocRef, {
                totalAppIncome: newTotalAppIncome,
                totalAppExpense: newTotalAppExpense,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            });
            console.log(`Reverting global balance: Income=${newTotalAppIncome}, Expense=${newTotalAppExpense}`);

            // 3. Hapus transaksi
            transaction.delete(transactionDocRef);
            console.log(`Deleting transaction with ID: ${id}`);
        })
        .then(() => {
            showSuccess("Transaksi berhasil dihapus!");
            // Setelah transaksi, muat ulang yang relevan
            if (currentUser?.role === 'admin') {
                loadAdminTransactions(); // Admin mungkin ingin melihat semua transaksi
                loadUserData(); // Admin juga perlu mengupdate saldo pribadi mereka
            } else {
                loadTransactions(); // User biasa hanya melihat transaksi mereka
                loadUserData(); // User biasa perlu mengupdate saldo pribadi mereka
            }
        })
        .catch((error) => {
            showError("Gagal menghapus transaksi: " + error.message);
            console.error("Firestore transaction failed (Delete Mode):", error);
        });
    }
}


// ==================== RECIPIENT TYPE TOGGLE ====================
document.querySelectorAll('input[name="recipient-type"]').forEach(radio => {
    radio.addEventListener('change', (event) => {
        const recipientEmailsGroup = document.getElementById('recipient-emails-group');
        if (event.target.value === 'pilih_user' || event.target.value === 'input_manual') {
            recipientEmailsGroup.classList.remove('hidden');
        } else {
            recipientEmailsGroup.classList.add('hidden');
        }
    });
});


// ==================== PRINT PDF FUNCTIONALITY ====================
document.getElementById('print-transactions')?.addEventListener('click', () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(18);
    doc.text("Laporan Transaksi Wallet QC", 14, 22);
    doc.setFontSize(11);
    doc.text(`Dicetak pada: ${new Date().toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'})}`, 14, 30);

    const transactionsData = [];
    transactionsRef.orderBy('date', 'desc').get().then(snapshot => {
        snapshot.forEach(doc => {
            const transaction = doc.data();
            const transactionDate = transaction.date ? transaction.date.toDate() : new Date();
            const formattedDate = transactionDate.toLocaleDateString('id-ID');
            transactionsData.push([
                formattedDate,
                transaction.userName,
                transaction.description,
                transaction.type === 'masuk' ? formatRupiah(transaction.amount) : '-',
                transaction.type === 'keluar' ? formatRupiah(transaction.amount) : ''
            ]);
        });

        doc.autoTable({
            startY: 40,
            head: [['Tanggal', 'Pengguna', 'Deskripsi', 'Masuk', 'Keluar']],
            body: transactionsData,
            theme: 'striped',
            headStyles: { fillColor: [139, 92, 246] }, // Primary purple
            styles: { fontSize: 9, cellPadding: 3 },
            columnStyles: {
                0: { cellWidth: 25 },
                1: { cellWidth: 25 },
                2: { cellWidth: 60 },
                3: { cellWidth: 30 },
                4: { cellWidth: 30 }
            }
        });

        doc.save('Laporan_Transaksi_WalletQC.pdf');
        showSuccess("Laporan transaksi berhasil diunduh!");
    }).catch(error => {
        showError("Gagal membuat laporan PDF: " + error.message);
    });
});

// ==================== CHART.JS INTEGRATION (Asumsi Anda memiliki elemen canvas dengan ID 'finance-chart') ====================
let financeChart;
function updateFinanceChart(income, expense) {
    const ctx = document.getElementById('finance-chart')?.getContext('2d');
    if (!ctx) {
        console.warn("Elemen canvas 'finance-chart' tidak ditemukan.");
        return;
    }

    const data = {
        labels: ['Pemasukan', 'Pengeluaran'],
        datasets: [{
            data: [income, expense],
            backgroundColor: ['#4CAF50', '#F44336'], // Green for income, Red for expense
            hoverOffset: 4
        }]
    };

    if (financeChart) {
        financeChart.data = data;
        financeChart.update();
    } else {
        financeChart = new Chart(ctx, {
            type: 'doughnut',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(tooltipItem) {
                                return tooltipItem.label + ': ' + formatRupiah(tooltipItem.raw);
                            }
                        }
                    }
                }
            },
        });
    }
}


// ==================== ADMIN DASHBOARD TAB SWITCHING ====================
document.getElementById('users-admin-tab')?.addEventListener('click', () => {
    document.getElementById('users-admin-content').classList.remove('hidden');
    document.getElementById('transactions-admin-content').classList.add('hidden');
    document.getElementById('agendas-admin-content').classList.add('hidden');
    document.getElementById('users-admin-tab').classList.add('tab-active'); // Sesuaikan ID tab
    document.getElementById('transactions-admin-tab').classList.remove('tab-active');
    document.getElementById('agendas-admin-tab').classList.remove('tab-active');
    loadUsers(); // Refresh users list
});

document.getElementById('transactions-admin-tab')?.addEventListener('click', () => {
    document.getElementById('users-admin-content').classList.add('hidden');
    document.getElementById('transactions-admin-content').classList.remove('hidden');
    document.getElementById('agendas-admin-content').classList.add('hidden');
    document.getElementById('users-admin-tab').classList.remove('tab-active'); // Sesuaikan ID tab
    document.getElementById('transactions-admin-tab').classList.add('tab-active');
    document.getElementById('agendas-admin-tab').classList.remove('tab-active');
    loadAdminTransactions();
});

document.getElementById('agendas-admin-tab')?.addEventListener('click', () => {
    document.getElementById('users-admin-content').classList.add('hidden');
    document.getElementById('transactions-admin-content').classList.add('hidden');
    document.getElementById('agendas-admin-content').classList.remove('hidden');
    document.getElementById('users-admin-tab').classList.remove('tab-active'); // Sesuaikan ID tab
    document.getElementById('transactions-admin-tab').classList.remove('tab-active');
    document.getElementById('agendas-admin-tab').classList.add('tab-active');
    loadAdminAgendas();
});

// ==================== Lain-lain ====================
// Event listener untuk tombol 'Tambah Transaksi Baru'
document.getElementById('add-transaction-btn')?.addEventListener('click', () => {
    document.getElementById('transaction-form').classList.remove('hidden');
    document.getElementById('transaction-form').reset(); // Reset form
    editingTransactionId = null; // Pastikan ini null saat menambah baru
    // Sembunyikan input email penerima secara default
    document.getElementById('recipient-emails-group').classList.add('hidden');
    document.querySelector('input[name="recipient-type"][value="self"]').checked = true; // Set default ke 'self'
});
                                                                </script>
    
</body>
</html>
