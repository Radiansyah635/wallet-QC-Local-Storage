<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wallet QC Local Storage</title>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.14/jspdf.autotable.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-purple: #8B5CF6;
      --primary-green: #10B981;
      --dark-bg: #0f0f0f;
      --card-bg: rgba(31, 31, 31, 0.7);
    }
    
    body {
      background: linear-gradient(to bottom, #000000, var(--dark-bg));
      min-height: 100vh;
      font-family: 'Segoe UI', system-ui, sans-serif;
      color: #f3f4f6;
    }
    
    .solana-card {
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
      transition: all 0.3s ease;
    }
    
    .solana-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(139, 92, 246, 0.2);
    }
    
    .gradient-text {
      background: linear-gradient(to right, var(--primary-purple), var(--primary-green));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    
    .btn-primary {
      background: linear-gradient(to right, var(--primary-purple), var(--primary-green));
      color: white;
      border: none;
      border-radius: 12px;
      padding: 12px 24px;
      font-weight: 600;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .btn-primary:hover {
      opacity: 0.9;
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
    }
    
    .input-field {
      background: rgba(55, 55, 55, 0.5);
      border: 1px solid rgba(107, 114, 128, 0.3);
      border-radius: 12px;
      padding: 14px 16px;
      color: white;
      width: 100%;
      transition: border 0.3s ease;
    }
    
    .input-field:focus {
      outline: none;
      border-color: var(--primary-purple);
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
    }
    
    .tab-active {
      background: rgba(139, 92, 246, 0.2);
      color: var(--primary-purple);
      font-weight: 600;
    }
    
    .transaction-in {
      border-left: 4px solid var(--primary-green);
    }
    
    .transaction-out {
      border-left: 4px solid #EF4444;
    }
    
    .user-avatar {
      background: linear-gradient(to right, var(--primary-purple), var(--primary-green));
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-weight: bold;
    }
    
    .section-hidden {
      display: none;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(139, 92, 246, 0.3);
      border-radius: 50%;
      border-top-color: var(--primary-purple);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .post-card {
      background: rgba(40, 40, 40, 0.7);
      border-radius: 12px;
      overflow: hidden;
      transition: transform 0.3s ease;
    }
    
    .post-card:hover {
      transform: translateY(-3px);
    }
    
    .attachment-preview {
      max-height: 300px;
      object-fit: contain; /* Changed from cover to contain for better preview */
      border-radius: 8px;
      margin-top: 10px;
      background-color: #000;
    }
    
    .agenda-card {
      background: rgba(45, 45, 45, 0.7);
      border-left: 4px solid var(--primary-green);
      border-radius: 8px;
    }
    
    .role-badge {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 9999px;
      margin-left: 8px;
    }
    
    .admin-badge {
      background: linear-gradient(to right, #f59e0b, #ef4444);
    }
    
    .member-badge {
      background: linear-gradient(to right, #3b82f6, #8b5cf6);
    }
    
    chart-container {
    position: relative;
    height: 300px;
    width: 100%;
    min-height: 300px;
    background: rgba(255,255,255,0.05); /* Latar belakang saat loading */
}
    
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(31, 31, 31, 0.5);
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--primary-purple);
      border-radius: 4px;
    }
    
    .file-upload-label {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      padding: 12px 16px;
      border-radius: 12px;
      background: rgba(55, 55, 55, 0.5);
      border: 1px dashed rgba(139, 92, 246, 0.5);
      transition: all 0.3s ease;
    }
    
    .file-upload-label:hover {
      border-color: var(--primary-purple);
      background: rgba(55, 55, 55, 0.7);
    }
    
    .admin-info-box {
      background: rgba(139, 92, 246, 0.1);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .admin-info-box h3 {
      color: var(--primary-purple);
      margin-bottom: 15px;
      font-weight: 600;
    }
    
    .admin-info-box ul {
      list-style-type: none;
      padding-left: 0;
    }
    
    .admin-info-box li {
      margin-bottom: 10px;
      padding-left: 25px;
      position: relative;
    }
    
    .admin-info-box li:before {
      content: "•";
      color: var(--primary-green);
      position: absolute;
      left: 0;
      font-size: 20px;
      line-height: 1;
    }
    
    .comment-box {
      background: rgba(50, 50, 50, 0.5);
      border-radius: 8px;
      padding: 10px;
      margin-top: 10px;
    }
    
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .action-button {
      background: rgba(70, 70, 70, 0.5);
      border: none;
      border-radius: 8px;
      padding: 5px 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .action-button:hover {
      background: rgba(90, 90, 90, 0.7);
    }
    
    .like-button.active {
      color: #EF4444;
    }
    
    .user-list-item {
      display: flex;
      align-items: center;
      padding: 12px;
      border-bottom: 1px solid rgba(70, 70, 70, 0.5);
    }
    
    .user-actions {
      margin-left: auto;
      display: flex;
      gap: 10px;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col">
  <header class="bg-black/80 py-4 px-6 border-b border-purple-900/50 sticky top-0 z-50">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-2xl font-bold gradient-text">Wallet QC Local Storage</h1>
      <div id="auth-section" class="flex items-center space-x-4">
        <span id="user-email" class="text-sm text-gray-300 hidden"></span>
        <span id="user-role" class="text-xs px-2 py-1 rounded-full bg-purple-600/50 hidden">Member</span>
        <button id="logout-btn" class="px-4 py-2 bg-red-600/80 hover:bg-red-500/90 rounded-lg text-sm hidden">
          Logout
        </button>
        <button id="login-btn" class="btn-primary">Login</button>
      </div>
    </div>
  </header>

  <main class="flex-grow container mx-auto px-4 py-8">
    <section id="auth-container" class="max-w-md mx-auto solana-card p-8">
      <div class="text-center mb-8">
        <h2 class="text-3xl font-bold gradient-text mb-2">Selamat Datang</h2>
        <p class="text-gray-400">Kelola kas tim QC dengan mudah dan aman</p>
      </div>

      <div class="flex border-b border-gray-800 mb-6">
        <button id="login-tab" class="flex-1 py-4 font-medium tab-active">
          Login
        </button>
        <button id="register-tab" class="flex-1 py-4 font-medium text-gray-400">
          Register
        </button>
        <button id="reset-tab" class="flex-1 py-4 font-medium text-gray-400">
          Reset Password
        </button>
      </div>

      <form id="login-form">
        <div class="space-y-4">
          <div>
            <label for="login-email" class="block text-sm mb-2 text-gray-300">Email</label>
            <input 
              type="email" 
              id="login-email" 
              required
              class="input-field"
              placeholder="email@contoh.com"
            >
          </div>
          <div>
            <label for="login-password" class="block text-sm mb-2 text-gray-300">Password</label>
            <input 
              type="password" 
              id="login-password" 
              required
              class="input-field"
              placeholder="••••••••"
            >
          </div>
          <button type="submit" class="btn-primary w-full">
            Masuk
          </button>
        </div>
      </form>

      <form id="register-form" class="hidden">
        <div class="space-y-4">
          <div>
            <label for="register-name" class="block text-sm mb-2 text-gray-300">Nama Lengkap</label>
            <input 
              type="text" 
              id="register-name" 
              required
              class="input-field"
              placeholder="Nama Anda"
            >
          </div>
          <div>
            <label for="register-email" class="block text-sm mb-2 text-gray-300">Email</label>
            <input 
              type="email" 
              id="register-email" 
              required
              class="input-field"
              placeholder="email@contoh.com"
            >
          </div>
          <div>
            <label for="register-password" class="block text-sm mb-2 text-gray-300">Password</label>
            <input 
              type="password" 
              id="register-password" 
              required
              class="input-field"
              placeholder="••••••••"
            >
          </div>
          <div class="hidden" id="admin-code-container">
            <label for="admin-code" class="block text-sm mb-2 text-gray-300">Kode Admin</label>
            <input 
              type="password" 
              id="admin-code" 
              class="input-field"
              placeholder="Masukkan kode admin"
            >
          </div>
          <div class="flex items-center">
            <input type="checkbox" id="is-admin" class="mr-2">
            <label for="is-admin" class="text-sm">Daftar sebagai Admin</label>
          </div>
          <button type="submit" class="btn-primary w-full">
            Daftar
          </button>
        </div>
      </form>
      
      <form id="reset-form" class="hidden">
        <div class="space-y-4">
          <div>
            <label for="reset-email" class="block text-sm mb-2 text-gray-300">Email</label>
            <input 
              type="email" 
              id="reset-email" 
              required
              class="input-field"
              placeholder="email@contoh.com"
            >
          </div>
          <button type="submit" class="btn-primary w-full">
            Kirim Link Reset Password
          </button>
        </div>
      </form>
      
      <div class="admin-info-box mt-6">
        <h3>Cara Masuk Sebagai Admin</h3>
        <ul>
          <li>Untuk akun yang sudah ada: Gunakan email dan password yang sudah didaftarkan</li>
          <li>Untuk membuat akun admin baru: Centang "Daftar sebagai Admin" dan masukkan kode admin: <strong>admin123</strong></li>
          <li>Akun demo admin: <strong>admin@walletqc.com</strong> / password: <strong>admin123</strong></li>
        </ul>
      </div>
      
      <div id="error-message" class="mt-4 text-center text-red-400 text-sm hidden"></div>
      <div id="success-message" class="mt-4 text-center text-green-400 text-sm hidden"></div>
    </section>

    <section id="dashboard" class="hidden">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-1 space-y-6">
          <div class="solana-card p-6">
            <div class="flex items-center space-x-4">
              <div class="relative">
                <div id="profile-avatar" class="user-avatar w-16 h-16 text-xl">
                  <span id="user-initial">U</span>
                </div>
                <img id="profile-image" class="absolute inset-0 w-16 h-16 rounded-full object-cover hidden" alt="Profile">
              </div>
              <div>
                <div class="flex items-center">
                  <h3 id="user-name" class="font-medium text-lg">User Name</h3>
                  <span id="role-badge" class="role-badge member-badge">Member</span>
                </div>
                <p id="user-email-display" class="text-sm text-gray-400">user@email.com</p>
                <div class="mt-2 text-sm">
                  <p>Kas Masuk: <span id="user-income" class="text-green-400">Rp 0</span></p>
                  <p>Kas Keluar: <span id="user-expense" class="text-red-400">Rp 0</span></p>
                  <p>Total Saldo: <span id="user-total-balance" class="font-medium">Rp 0</span></p>
                </div>
              </div>
            </div>
          </div>

          <div class="solana-card p-6">
            <h3 class="font-medium mb-4 text-purple-400">Menu Cepat</h3>
            <ul class="space-y-3">
              <li>
                <button id="show-kas" class="w-full text-left p-3 hover:bg-gray-800/50 rounded-lg flex items-center">
                  <span class="mr-3">💰</span> Kas & Transaksi
                </button>
              </li>
              <li>
                <button id="show-agenda" class="w-full text-left p-3 hover:bg-gray-800/50 rounded-lg flex items-center">
                  <span class="mr-3">📅</span> Agenda QC
                </button>
              </li>
              <li>
                <button id="show-sosial" class="w-full text-left p-3 hover:bg-gray-800/50 rounded-lg flex items-center">
                  <span class="mr-3">💬</span> Sosial Media
                </button>
              </li>
              <li class="admin-only">
                <button id="show-admin" class="w-full text-left p-3 hover:bg-gray-800/50 rounded-lg flex items-center">
                  <span class="mr-3">🔒</span> Admin Panel
                </button>
              </li>
              <li>
                <button id="show-setting" class="w-full text-left p-3 hover:bg-gray-800/50 rounded-lg flex items-center">
                  <span class="mr-3">⚙️</span> Pengaturan
                </button>
              </li>
              <li>
                <button id="show-transfer" class="w-full text-left p-3 hover:bg-gray-800/50 rounded-lg flex items-center">
                  <span class="mr-3">💸</span> Transfer Saldo
                </button>
              </li>
              <li>
                <button id="show-ecommerce" class="w-full text-left p-3 hover:bg-gray-800/50 rounded-lg flex items-center">
                  <span class="mr-3">🛍️</span> Jual Produk
                </button>
              </li>
            </ul>
          </div>

          <div class="solana-card bg-gradient-to-br from-purple-900/30 to-green-900/20 p-6">
            <h3 class="font-medium mb-2">Total Saldo</h3>
            <p id="total-saldo" class="text-3xl font-bold font-mono">Rp 0</p>
            <div class="mt-4 bg-black/20 rounded-lg p-3">
              <div class="flex justify-between mb-2">
                <span>Pemasukan</span>
                <span id="income-amount" class="text-green-400">+ Rp 0</span>
              </div>
              <div class="flex justify-between">
                <span>Pengeluaran</span>
                <span id="expense-amount" class="text-red-400">- Rp 0</span>
              </div>
            </div>
          </div>
        </div>

        <div class="lg:col-span-2 space-y-6">
          <section id="kas-section" class="solana-card p-6">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-xl font-semibold">Kas & Transaksi</h2>
              <div>
                <button id="print-transactions" class="px-4 py-2 bg-gray-700/50 hover:bg-gray-600/50 rounded-lg mr-2">
                  <i class="fas fa-print mr-1"></i> Cetak PDF
                </button>
                <button id="add-transaction-btn" class="btn-primary admin-only">
                  <i class="fas fa-plus mr-2"></i> Tambah Transaksi
                </button>
              </div>
            </div>
            
            <div class="mb-8">
              <h3 class="text-lg font-medium mb-4">Statistik Keuangan</h3>
              <div class="chart-container">
                <canvas id="finance-chart"></canvas>
              </div>
            </div>
            
            <form id="transaction-form" class="hidden space-y-4 mb-6">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
            <label class="block text-sm mb-2">Jenis Transaksi</label>
            <select id="transaction-type" class="input-field">
                <option value="masuk">Kas Masuk</option>
                <option value="keluar">Kas Keluar</option>
            </select>
        </div>
        <div>
            <label class="block text-sm mb-2">Jumlah (Rp)</label>
            <input type="number" id="transaction-amount" class="input-field" placeholder="1000000" required min="1">
        </div>
    </div>
    <div>
        <label class="block text-sm mb-2">Keterangan</label>
        <input type="text" id="transaction-desc" class="input-field" placeholder="Deskripsi transaksi" required>
    </div>

    <div class="form-group">
        <label class="block text-sm mb-2">Penerima Email</label>
        <div>
            <input type="radio" id="radioSemuaUser" name="penerimaEmail" value="semua_user" class="mr-2">
            <label for="radioSemuaUser" class="inline-block text-sm">Semua User</label>
        </div>
        <div>
            <input type="radio" id="radioPilihUser" name="penerimaEmail" value="pilih_user" class="mr-2">
            <label for="radioPilihUser" class="inline-block text-sm">Pilih User Tertentu</label>
        </div>
        <div>
            <input type="radio" id="radioInputManual" name="penerimaEmail" value="input_manual" class="mr-2">
            <label for="radioInputManual" class="inline-block text-sm">Input Manual</label>
        </div>

        <div id="emailInputContainer" class="mt-4 section-hidden">
            <label for="inputEmail" class="block text-sm mb-2">Email User (pisahkan dengan koma jika lebih dari satu):</label>
            <input type="email" id="inputEmail" name="emails" class="input-field" placeholder="contoh@domain.com, lain@domain.com" multiple>
        </div>

        <div id="allUserMessage" class="mt-2 section-hidden text-sm text-gray-400">
            <p>Transaksi ini akan dikirim ke semua user yang terdaftar.</p>
        </div>
    </div>
    <div class="flex justify-end space-x-3">
        <button type="button" id="cancel-transaction-btn" class="px-4 py-2 bg-gray-700/50 hover:bg-gray-600/50 rounded-lg">
            Batal
        </button>
        <button type="submit" class="btn-primary">
            Simpan Transaksi
        </button>
    </div>
</form>

            <div id="transactions-list" class="space-y-4 max-h-[500px] overflow-y-auto">
              <div class="text-center py-10">
                <div class="loading mx-auto"></div>
                <p class="mt-3 text-gray-400">Memuat data transaksi...</p>
              </div>
            </div>
          </section>
          
          <section id="agenda-section" class="solana-card p-6 hidden">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-xl font-semibold">Agenda QC</h2>
              <button id="add-agenda-btn" class="btn-primary admin-only">
                <i class="fas fa-plus mr-2"></i> Tambah Agenda
              </button>
            </div>

            <form id="agenda-form" class="hidden space-y-4 mb-6">
              <div>
                <label class="block text-sm mb-2">Judul Agenda</label>
                <input type="text" id="agenda-title" class="input-field" placeholder="Meeting QC" required>
              </div>
              <div>
                <label class="block text-sm mb-2">Deskripsi</label>
                <textarea id="agenda-desc" rows="3" class="input-field" placeholder="Detail agenda" required></textarea>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm mb-2">Tanggal</label>
                  <input type="date" id="agenda-date" class="input-field" required>
                </div>
                <div>
                  <label class="block text-sm mb-2">Lampiran</label>
                  <label for="agenda-file" class="file-upload-label">
                    <span id="agenda-file-name-display">Pilih file...</span>
                    <i class="fas fa-cloud-upload-alt"></i>
                  </label>
                  <input type="file" id="agenda-file" class="hidden">
                  <div id="agenda-attachment-preview" class="hidden mt-2 text-sm text-gray-400">
                    <span id="agenda-preview-name"></span>
                    <button type="button" id="remove-agenda-attachment" class="ml-2 text-red-400">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
              </div>
              <div class="flex justify-end space-x-3">
                <button type="button" id="cancel-agenda-btn" class="px-4 py-2 bg-gray-700/50 hover:bg-gray-600/50 rounded-lg">
                  Batal
                </button>
                <button type="submit" class="btn-primary">
                  Simpan Agenda
                </button>
              </div>
            </form>

            <div id="agenda-list" class="space-y-4 max-h-[600px] overflow-y-auto">
              <div class="text-center py-10">
                <div class="loading mx-auto"></div>
                <p class="mt-3 text-gray-400">Memuat data agenda...</p>
              </div>
            </div>
          </section>
          
          <section id="sosial-section" class="solana-card p-6 hidden">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-xl font-semibold">Sosial Media QC</h2>
            </div>

            <form id="post-form" class="space-y-4 mb-6">
              <div>
                <textarea id="post-content" rows="3" class="input-field" placeholder="Apa yang ingin Anda bagikan hari ini?" required></textarea>
              </div>
              <div class="flex justify-between items-center">
                <div class="flex items-center">
                  <label for="post-image" class="file-upload-label mr-3">
                    <span id="image-name-display">Lampirkan Gambar/Video</span>
                    <i class="fas fa-image"></i>
                  </label>
                  <input type="file" id="post-image" accept="image/*,video/*" class="hidden">
                </div>
                <button type="submit" class="btn-primary">
                  Posting
                </button>
              </div>
            </form>
            
            <div id="post-attachment-preview-container" class="hidden mt-4">
              <img id="preview-image" class="attachment-preview w-full" alt="Preview lampiran">
              <video id="preview-video" class="attachment-preview w-full hidden" controls></video>
              <button id="remove-attachment" class="mt-2 text-red-400 text-sm">
                <i class="fas fa-times mr-1"></i> Hapus lampiran
              </button>
            </div>
            
            <div id="social-feed" class="mt-8 space-y-6 max-h-[600px] overflow-y-auto">
              <div class="text-center py-10">
                <div class="loading mx-auto"></div>
                <p class="mt-3 text-gray-400">Memuat postingan...</p>
              </div>
            </div>
            <div id="user-profile-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 hidden">
              <div class="solana-card p-6 w-full max-w-xl max-h-[90vh] overflow-y-auto relative">
                <button id="close-user-profile-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white text-xl">
                  <i class="fas fa-times"></i>
                </button>
                <div class="flex flex-col items-center text-center mb-6">
                  <div id="profile-modal-avatar" class="user-avatar w-24 h-24 text-4xl mb-4">
                    <span id="profile-modal-initial">U</span>
                  </div>
                  <img id="profile-modal-image" class="w-24 h-24 rounded-full object-cover hidden mb-4" alt="Profile">
                  <h3 id="profile-modal-name" class="text-2xl font-bold gradient-text"></h3>
                  <p id="profile-modal-email" class="text-gray-400 text-sm"></p>
                  <span id="profile-modal-role" class="role-badge mt-2"></span>
                </div>
            
                <h4 class="text-lg font-semibold mb-3">Posting Terbaru</h4>
                <div id="profile-modal-posts" class="space-y-4 max-h-48 overflow-y-auto mb-6">
                  <p class="text-center text-gray-400">Belum ada postingan.</p>
                </div>
            
                <h4 class="text-lg font-semibold mb-3">Produk yang Dijual</h4>
                <div id="profile-modal-products" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-48 overflow-y-auto">
                  <p class="text-center text-gray-400">Belum ada produk yang dijual.</p>
                </div>
              </div>
            </div>
          </section>
          
          <section id="admin-section" class="solana-card p-6 hidden">
            <h2 class="text-xl font-semibold mb-6">Admin Panel</h2>
            
            <div class="flex border-b border-gray-800 mb-6">
              <button id="users-tab" class="py-3 px-4 font-medium tab-active">Users</button>
              <button id="transactions-admin-tab" class="py-3 px-4 font-medium text-gray-400">Transaksi</button>
              <button id="agendas-admin-tab" class="py-3 px-4 font-medium text-gray-400">Agenda</button>
            </div>
            
            <div id="users-admin-content">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium">Manajemen Pengguna</h3>
              </div>
              
              <div id="users-list" class="space-y-3 max-h-[500px] overflow-y-auto">
                <div class="text-center py-10">
                  <div class="loading mx-auto"></div>
                  <p class="mt-3 text-gray-400">Memuat data pengguna...</p>
                </div>
              </div>
            </div>
            
            <div id="transactions-admin-content" class="hidden">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium">Manajemen Transaksi</h3>
              </div>
              
              <div id="admin-transactions-list" class="space-y-4 max-h-[500px] overflow-y-auto">
                <div class="text-center py-10">
                  <div class="loading mx-auto"></div>
                  <p class="mt-3 text-gray-400">Memuat data transaksi...</p>
                </div>
              </div>
            </div>
            
            <div id="agendas-admin-content" class="hidden">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium">Manajemen Agenda</h3>
              </div>
              
              <div id="admin-agendas-list" class="space-y-4 max-h-[500px] overflow-y-auto">
                <div class="text-center py-10">
                  <div class="loading mx-auto"></div>
                  <p class="mt-3 text-gray-400">Memuat data agenda...</p>
                </div>
              </div>
            </div>
          </section>
          
          <section id="setting-section" class="solana-card p-6 hidden">
            <h2 class="text-xl font-semibold mb-6">Pengaturan Akun</h2>
            <form id="setting-form" class="space-y-6">
              <div class="flex items-center space-x-6">
                <div class="relative">
                  <div id="profile-avatar-setting" class="user-avatar w-24 h-24 text-2xl">
                    <span id="user-initial-setting">U</span>
                  </div>
                  <img id="profile-image-setting" class="absolute inset-0 w-24 h-24 rounded-full object-cover hidden" alt="Profile">
                  <label for="profile-image-input" class="absolute bottom-0 right-0 bg-purple-600 rounded-full p-2 cursor-pointer">
                    <i class="fas fa-camera text-white"></i>
                  </label>
                  <input type="file" id="profile-image-input" accept="image/*" class="hidden">
                </div>
                <div>
                  <h3 class="text-lg font-medium">Foto Profil</h3>
                  <p class="text-gray-400 text-sm">Ukuran maks. 5MB (JPG, PNG)</p>
                </div>
              </div>
              
              <div>
                <label class="block text-sm mb-2">Nama Lengkap</label>
                <input type="text" id="setting-name" class="input-field" placeholder="Nama Anda">
              </div>
              
              <div>
                <label class="block text-sm mb-2">Email</label>
                <input type="email" id="setting-email" class="input-field" disabled>
              </div>
              
              <div>
                <label class="block text-sm mb-2">Password Baru (biarkan kosong jika tidak ingin mengubah)</label>
                <input type="password" id="setting-password" class="input-field" placeholder="••••••••">
              </div>
              
              <div class="pt-4">
                <button type="submit" class="btn-primary mr-3">
                  Simpan Perubahan
                </button>
                <button type="button" id="delete-account-btn" class="px-4 py-2 bg-red-600/80 hover:bg-red-700 rounded-lg">
                  Hapus Akun
                </button>
              </div>
            </form>
          </section>

            <section id="create-pin-section" class="solana-card p-6 hidden">
    <div class="text-center mb-6">
        <h2 class="text-2xl font-bold gradient-text">Buat PIN Transaksi</h2>
        <p class="text-gray-400 mt-2">Buat PIN 4 digit untuk keamanan transaksi Anda</p>
    </div>

    <form id="create-pin-form" class="space-y-6">
        <div>
            <label class="block text-sm mb-2">PIN Baru (4 digit angka)</label>
            <input type="password" id="new-pin" class="input-field text-center tracking-widest"
                   placeholder="••••" inputmode="numeric" pattern="\d{4}" maxlength="4" required>
        </div>
        
        <div>
            <label class="block text-sm mb-2">Konfirmasi PIN</label>
            <input type="password" id="confirm-pin" class="input-field text-center tracking-widest"
                   placeholder="••••" inputmode="numeric" pattern="\d{4}" maxlength="4" required>
        </div>
        
        <div id="pin-error-message" class="text-red-400 text-sm hidden"></div>
        
        <button type="submit" class="btn-primary w-full">
            Simpan PIN
        </button>
        
        <div class="bg-yellow-900/20 border border-yellow-700 rounded-lg p-3 text-sm text-yellow-300">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            PIN ini akan digunakan untuk verifikasi setiap transaksi. Jangan berikan PIN Anda kepada siapapun.
        </div>
    </form>
</section>

<section id="transfer-section" class="solana-card p-6 hidden">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-semibold gradient-text">Transfer Saldo</h2>
        <button id="show-contacts-btn" class="px-4 py-2 bg-purple-600/80 hover:bg-purple-700 rounded-lg text-sm">
            <i class="fas fa-address-book mr-2"></i> Kontak Saya
        </button>
    </div>

    <form id="p2p-transfer-form" class="space-y-4 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm mb-2">Email Penerima</label>
                <div class="relative">
                    <input type="email" id="recipient-email" class="input-field" placeholder="email_penerima@contoh.com" required>
                    <button type="button" id="recipient-history-btn" class="absolute right-3 top-3 text-purple-400 hover:text-purple-300">
                        <i class="fas fa-history"></i>
                    </button>
                </div>
            </div>
            <div>
                <label class="block text-sm mb-2">Jumlah (Rp)</label>
                <div class="relative">
                    <input type="number" id="transfer-amount" class="input-field pl-10" placeholder="100000" required 
                           min="10000" max="10000000" step="1000">
                    <span class="absolute left-3 top-3 text-gray-400">Rp</span>
                </div>
                <p class="text-xs text-gray-400 mt-1">Min. Rp 10.000, Max. Rp 10.000.000</p>
            </div>
        </div>

        <div>
            <label class="block text-sm mb-2">Pesan (Opsional)</label>
            <input type="text" id="transfer-note" class="input-field" placeholder="Untuk pembayaran..." maxlength="100">
        </div>

        <div>
            <label class="block text-sm mb-2">PIN Transaksi (4 digit)</label>
            <input type="password" id="transfer-pin" class="input-field" placeholder="••••" 
                   inputmode="numeric" pattern="\d{4}" maxlength="4" required>
        </div>

        <div id="transfer-error-message" class="text-red-400 text-sm hidden"></div>
        <div id="transfer-info-message" class="text-purple-400 text-sm hidden"></div>

        <div class="flex justify-between items-center pt-2">
            <div>
                <p class="text-sm text-gray-400">Biaya admin: <span id="transfer-fee">Rp 0</span></p>
                <p class="text-sm font-medium">Total yang akan didebit: <span id="transfer-total">Rp 0</span></p>
            </div>
            <button type="submit" id="submit-transfer-btn" class="btn-primary px-6">
                <span id="submit-transfer-text">Konfirmasi Transfer</span>
                <span id="submit-transfer-loader" class="hidden ml-2">
                    <i class="fas fa-spinner fa-spin"></i>
                </span>
            </button>
        </div>
    </form>

    <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-medium">Riwayat Transfer</h3>
        <div class="flex space-x-2">
            <select id="filter-transfer-type" class="input-field text-sm py-1 px-2">
                <option value="all">Semua</option>
                <option value="in">Masuk</option>
                <option value="out">Keluar</option>
            </select>
            <input type="text" id="search-transfer" class="input-field text-sm py-1 px-2" placeholder="Cari...">
        </div>
    </div>

    <div id="p2p-transactions-list" class="space-y-3 max-h-[500px] overflow-y-auto">
        <div class="text-center py-10">
            <div class="loading mx-auto"></div>
            <p class="mt-3 text-gray-400">Memuat riwayat transfer...</p>
        </div>
    </div>
</section>

          <section id="ecommerce-section" class="solana-card p-6 hidden">
            <h2 class="text-xl font-semibold mb-6">Produk</h2>
          
            <div class="flex border-b border-gray-800 mb-6">
              <button id="browse-products-tab" class="py-3 px-4 font-medium tab-active">Jelajahi Produk</button>
              <button id="my-products-tab" class="py-3 px-4 font-medium text-gray-400">Produk Saya</button>
            </div>
          
            <div id="browse-products-content">
              <div class="mb-4">
                <input type="text" id="product-search-input" class="input-field" placeholder="Cari produk..." />
              </div>
              <div id="products-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-h-[600px] overflow-y-auto">
                <div class="text-center py-10 col-span-full">
                  <div class="loading mx-auto"></div>
                  <p class="mt-3 text-gray-400">Memuat produk...</p>
                </div>
              </div>
            </div>
          
            <div id="my-products-content" class="hidden">
              <button id="add-product-btn" class="btn-primary mb-4">
                <i class="fas fa-plus mr-2"></i> Tambah Produk Baru
              </button>
          
              <form id="product-form" class="hidden space-y-4 mb-6">
                <div>
                  <label class="block text-sm mb-2">Nama Produk</label>
                  <input type="text" id="product-name" class="input-field" placeholder="Nama produk" required>
                </div>
                <div>
                  <label class="block text-sm mb-2">Deskripsi Produk</label>
                  <textarea id="product-description" rows="3" class="input-field" placeholder="Deskripsi lengkap produk" required></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm mb-2">Harga (Rp)</label>
                    <input type="number" id="product-price" class="input-field" placeholder="100000" required min="0">
                  </div>
                  <div>
                    <label class="block text-sm mb-2">Stok</label>
                    <input type="number" id="product-stock" class="input-field" placeholder="10" required min="0">
                  </div>
                </div>
                <div>
                  <label class="block text-sm mb-2">Gambar Produk</label>
                  <label for="product-images-input" class="file-upload-label">
                    <span id="product-image-name-display">Pilih gambar... (maks. 5)</span>
                    <i class="fas fa-image"></i>
                  </label>
                  <input type="file" id="product-images-input" accept="image/*" class="hidden" multiple>
                  <div id="product-images-preview" class="mt-2 flex flex-wrap gap-2"></div>
                </div>
                <div id="product-form-error" class="text-red-400 text-sm hidden"></div>
                <div class="flex justify-end space-x-3">
                  <button type="button" id="cancel-product-btn" class="px-4 py-2 bg-gray-700/50 hover:bg-gray-600/50 rounded-lg">
                    Batal
                  </button>
                  <button type="submit" class="btn-primary">
                    Simpan Produk
                  </button>
                </div>
              </form>
          
              <div id="my-products-list" class="space-y-4 max-h-[500px] overflow-y-auto">
                <div class="text-center py-10">
                  <div class="loading mx-auto"></div>
                  <p class="mt-3 text-gray-400">Memuat produk Anda...</p>
                </div>
              </div>
            </div>
          </section>
          
          <div id="product-detail-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 hidden">
            <div class="solana-card p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto relative">
              <button id="close-product-detail-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white text-xl">
                <i class="fas fa-times"></i>
              </button>
              <h3 id="detail-product-name" class="text-2xl font-bold mb-4 gradient-text"></h3>
              <div id="detail-product-images" class="mb-4 grid grid-cols-1 md:grid-cols-2 gap-2">
                </div>
              <p class="text-gray-300 mb-2">Harga: <span id="detail-product-price" class="font-bold text-lg text-green-400"></span></p>
              <p class="text-gray-300 mb-2">Stok: <span id="detail-product-stock"></span></p>
              <p class="text-gray-300 mb-4">Penjual: <span id="detail-seller-name" class="font-medium"></span> (<span id="detail-seller-email"></span>)</p>
              <p id="detail-product-description" class="text-gray-400 mb-6"></p>
          
              <button id="message-seller-btn" class="btn-primary w-full">
                <i class="fas fa-comment-dots mr-2"></i> Kirim Pesan ke Penjual
              </button>
            </div>
          </div>
          
          <div id="message-seller-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 hidden">
            <div class="solana-card p-6 w-full max-w-xl max-h-[90vh] overflow-y-auto relative">
              <button id="close-message-seller-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white text-xl">
                <i class="fas fa-times"></i>
              </button>
              <h3 class="text-xl font-semibold mb-4 gradient-text">Pesan ke <span id="chat-recipient-name"></span></h3>
              <p class="text-gray-400 text-sm mb-4">Produk: <span id="chat-product-name" class="font-medium"></span></p>
          
              <div id="chat-messages" class="bg-gray-800/50 p-4 rounded-lg max-h-60 overflow-y-auto mb-4 space-y-3">
                <div class="text-center text-gray-400">Belum ada pesan.</div>
              </div>
          
              <form id="chat-form" class="flex space-x-2">
                <input type="text" id="chat-input" class="input-field flex-grow" placeholder="Ketik pesan Anda..." required>
                <button type="submit" class="btn-primary px-4 py-2">Kirim</button>
              </form>
            </div>
          </div>

        </div>
      </div>
    </section>
  </main>

  <script>
    // ================= FIREBASE INITIALIZATION =================
    const firebaseConfig = {
      apiKey: "AIzaSyD0RL0zvv4DL9EBax3XouugVZpkHdzyVNQ",
      authDomain: "wallet-qc-local-storage.firebaseapp.com",
      projectId: "wallet-qc-local-storage",
      storageBucket: "wallet-qc-local-storage.appspot.com",
      messagingSenderId: "443546801664",
      appId: "1:443546801664:web:6d0342e1b8261dd920aae5"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // Firestore collections
    const usersRef = db.collection("users");
    const transactionsRef = db.collection("transactions");
    const agendasRef = db.collection("agendas");
    const postsRef = db.collection("posts");
    const appDataRef = db.collection('app_data').doc('global_metrics');
    const notificationsRef = db.collection("notifications"); // NEW
    const productsRef = db.collection("products"); // NEW
    const conversationsRef = db.collection("conversations"); // NEW

    // Global variables
    let currentUser = null;
    let financeChart = null;
    let selectedAgendaFile = null;
    let selectedPostFile = null;
    let profileImageFile = null;
    let editingTransactionId = null;
    let editingAgendaId = null;
    let editingPostId = null;

    // ================= UTILITY FUNCTIONS =================
    function showError(message) {
      const errorElement = document.getElementById('error-message');
      errorElement.textContent = message;
      errorElement.classList.remove('hidden');
      setTimeout(() => errorElement.classList.add('hidden'), 5000);
      console.error(message);
    }
    
    function showSuccess(message) {
      const successElement = document.getElementById('success-message');
      successElement.textContent = message;
      successElement.classList.remove('hidden');
      setTimeout(() => successElement.classList.add('hidden'), 5000);
      console.log(message);
    }

    function formatRupiah(amount) {
      return 'Rp ' + amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }
    
    function hideAllSections() {
      document.getElementById('kas-section').classList.add('hidden');
      document.getElementById('agenda-section').classList.add('hidden');
      document.getElementById('sosial-section').classList.add('hidden');
      document.getElementById('admin-section').classList.add('hidden');
      document.getElementById('setting-section').classList.add('hidden');
    }

    function formatRecipients(recipients) {
      if (!recipients || recipients.length === 0) return 'Tidak ada penerima';
      if (recipients.includes('ALL_USERS')) return 'Semua User';
      return recipients.slice(0, 3).join(', ') + (recipients.length > 3 ? '...' : '');
    }

    function initializeRadioButtons() {
      const radioSemuaUser = document.getElementById('radioSemuaUser');
      const radioPilihUser = document.getElementById('radioPilihUser');
      const radioInputManual = document.getElementById('radioInputManual');
      const emailInputContainer = document.getElementById('emailInputContainer');
      const allUserMessage = document.getElementById('allUserMessage');

      if (!radioSemuaUser || !emailInputContainer || !allUserMessage) {
        console.error("Email recipient form elements not found!");
        return;
      }

      function toggleEmailInput() {
        if (radioSemuaUser.checked) {
          emailInputContainer.classList.add('section-hidden');
          allUserMessage.classList.remove('section-hidden');
          document.getElementById('inputEmail').removeAttribute('required');
        } else {
          emailInputContainer.classList.remove('section-hidden');
          allUserMessage.classList.add('section-hidden');
          document.getElementById('inputEmail').setAttribute('required', 'true');
        }
      }

      // Add event listeners if not already added
      if (!radioSemuaUser.hasListener) {
        radioSemuaUser.addEventListener('change', toggleEmailInput);
        radioPilihUser.addEventListener('change', toggleEmailInput);
        radioInputManual.addEventListener('change', toggleEmailInput);
        radioSemuaUser.hasListener = true;
      }

      // Set initial state
      toggleEmailInput();
    }

  // ================= AUTHENTICATION FUNCTIONS =================
function initAuthListeners() {
  // Fungsi untuk menampilkan pesan sukses
  // Durasi diperpanjang menjadi 10 detik
  function showSuccess(message) {
    const successMessageDiv = document.getElementById('success-message');
    successMessageDiv.innerHTML = message;
    successMessageDiv.classList.remove('hidden');
    setTimeout(() => {
      successMessageDiv.classList.add('hidden');
    }, 10000); // Tampilkan 10 detik
  }

  // Fungsi untuk menampilkan pesan error
  // Durasi diperpanjang menjadi 10 detik
  function showError(message) {
    const errorMessageDiv = document.getElementById('error-message');
    errorMessageDiv.innerHTML = message;
    errorMessageDiv.classList.remove('hidden');
    setTimeout(() => {
      errorMessageDiv.classList.add('hidden');
    }, 10000); // Tampilkan 10 detik
  }

  // ================= LOGIN HANDLER =================
  document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    
    // Pindahkan deklarasi originalText ke sini agar dapat diakses di finally
    const loginBtn = e.target.querySelector('button[type="submit"]');
    let originalText = loginBtn ? loginBtn.innerHTML : 'Masuk'; // Default text jika tombol tidak ditemukan

    try {
      // Tampilkan loading state
      if (loginBtn) {
        loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';
        loginBtn.disabled = true;
      }

      // Coba login
      const userCredential = await auth.signInWithEmailAndPassword(email, password);
      const user = userCredential.user;

      // Periksa verifikasi email
      if (!user.emailVerified) {
        await auth.signOut(); // Logout user karena belum verifikasi
        
        showError(`
          <div class="text-center p-4">
            <i class="fas fa-envelope text-4xl text-yellow-500 mb-3"></i>
            <h4 class="font-bold text-xl">Email Belum Diverifikasi!</h4>
            <p class="mt-2 text-gray-200">Silakan cek inbox email <strong>${email}</strong> untuk verifikasi.</p>
            <p class="text-sm text-gray-400 mt-1">Periksa folder spam jika tidak menemukan email.</p>
            <div class="mt-4 flex justify-center gap-3">
              <button onclick="resendVerificationEmail('${email}')" 
                      class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-white">
                <i class="fas fa-paper-plane mr-2"></i> Kirim Ulang Email
              </button>
              <button onclick="document.getElementById('login-form').reset()" 
                      class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg text-white">
                <i class="fas fa-times mr-2"></i> Tutup
              </button>
            </div>
          </div>
        `);
        return;
      }

      // Periksa apakah data user ada di Firestore
      const userDoc = await usersRef.doc(user.uid).get();
      if (!userDoc.exists) {
        await auth.signOut(); // Logout user karena data tidak lengkap
        
        showError(`
          <div class="text-center p-4">
            <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-3"></i>
            <h4 class="font-bold text-xl">Data Pengguna Tidak Lengkap!</h4>
            <p class="mt-2 text-gray-200">Akun Anda belum terdaftar lengkap di sistem.</p>
            <button onclick="location.reload()" 
                    class="mt-3 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white">
              <i class="fas fa-sync-alt mr-2"></i> Muat Ulang Halaman
            </button>
          </div>
        `);
        return;
      }

      // Jika semua valid, masuk ke dashboard
      showSuccess(`
        <div class="text-center p-4">
          <i class="fas fa-check-circle text-4xl text-green-500 mb-3"></i>
          <h4 class="font-bold text-xl">Login Berhasil!</h4>
          <p class="mt-2 text-gray-200">Selamat datang kembali, ${userDoc.data().name || email}</p>
          <div class="mt-4">
            <div class="loading mx-auto"></div>
            <p class="text-sm text-gray-400">Mengarahkan ke dashboard...</p>
          </div>
        </div>
      `);
      
      // Redirect ke dashboard setelah 2 detik
      setTimeout(() => {
        currentUser = user;
        loadUserData();
      }, 2000);

    } catch (error) {
      let errorMessage = '';
      
      // Handle berbagai jenis error
      switch(error.code) {
        case 'auth/user-not-found':
          errorMessage = `
            <div class="text-center p-4">
              <i class="fas fa-user-times text-4xl text-red-500 mb-3"></i>
              <h4 class="font-bold text-xl">Email Tidak Terdaftar!</h4>
              <p class="mt-2 text-gray-200">Email <strong>${email}</strong> belum terdaftar.</p>
              <div class="mt-4 flex justify-center gap-3">
                <button onclick="document.getElementById('register-tab').click(); document.getElementById('register-email').value = '${email}'" 
                        class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-white">
                  <i class="fas fa-user-plus mr-2"></i> Daftar Sekarang
                </button>
                <button onclick="document.getElementById('reset-tab').click(); document.getElementById('reset-email').value = '${email}'" 
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white">
                  <i class="fas fa-key mr-2"></i> Reset Password
                </button>
              </div>
            </div>
          `;
          break;
          
        case 'auth/wrong-password':
          errorMessage = `
            <div class="text-center p-4">
              <i class="fas fa-lock text-4xl text-red-500 mb-3"></i>
              <h4 class="font-bold text-xl">Password Salah!</h4>
              <p class="mt-2 text-gray-200">Password yang Anda masukkan tidak sesuai.</p>
              <button onclick="document.getElementById('reset-tab').click(); document.getElementById('reset-email').value = '${email}'" 
                      class="mt-3 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white">
                <i class="fas fa-key mr-2"></i> Lupa Password?
              </button>
            </div>
          `;
          break;
          
        case 'auth/too-many-requests':
          errorMessage = `
            <div class="text-center p-4">
              <i class="fas fa-shield-alt text-4xl text-red-500 mb-3"></i>
              <h4 class="font-bold text-xl">Terlalu Banyak Percobaan!</h4>
              <p class="mt-2 text-gray-200">Akses sementara dibatasi. Coba lagi nanti atau reset password.</p>
              <button onclick="document.getElementById('reset-tab').click(); document.getElementById('reset-email').value = '${email}'" 
                      class="mt-3 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white">
                <i class="fas fa-key mr-2"></i> Reset Password
              </button>
            </div>
          `;
          break;
          
        default:
          errorMessage = `
            <div class="text-center p-4">
              <i class="fas fa-exclamation-circle text-4xl text-red-500 mb-3"></i>
              <h4 class="font-bold text-xl">Gagal Login!</h4>
              <p class="mt-2 text-gray-200">${error.message || 'Terjadi kesalahan saat proses login'}</p>
            </div>
          `;
      }
      
      showError(errorMessage);
    } finally {
      // Reset button state
      if (loginBtn) {
        loginBtn.innerHTML = originalText;
        loginBtn.disabled = false;
      }
    }
  });

  // ================= REGISTER HANDLER =================
  document.getElementById('register-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('register-name').value;
    const email = document.getElementById('register-email').value;
    const password = document.getElementById('register-password').value;
    const isAdmin = document.getElementById('is-admin').checked;
    const adminCode = document.getElementById('admin-code').value;

    // Pindahkan deklarasi originalText ke sini agar dapat diakses di finally
    const registerBtn = e.target.querySelector('button[type="submit"]');
    let originalText = registerBtn ? registerBtn.innerHTML : 'Daftar'; // Default text

    if (isAdmin && adminCode !== "admin123") {
      showError(`
        <div class="text-center p-4">
          <i class="fas fa-lock text-4xl text-red-500 mb-3"></i>
          <h4 class="font-bold text-xl">Kode Admin Salah!</h4>
          <p class="mt-2 text-gray-200">Hubungi administrator untuk mendapatkan kode yang valid.</p>
        </div>
      `);
      // Pastikan button direset jika ada error sebelum try
      if (registerBtn) {
        registerBtn.innerHTML = originalText;
        registerBtn.disabled = false;
      }
      return;
    }

    try {
      // Tampilkan loading state
      if (registerBtn) {
        registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mendaftarkan...';
        registerBtn.disabled = true;
      }

      // 1. Buat user di Firebase Auth
      const userCredential = await auth.createUserWithEmailAndPassword(email, password);
      const user = userCredential.user;

      // 2. Kirim email verifikasi (tanpa menunggu)
      const verificationPromise = user.sendEmailVerification({
        url: window.location.href + '?from=verify-email',
        handleCodeInApp: true
      }).catch(error => {
        console.error("Gagal mengirim email verifikasi:", error);
      });

      // 3. Simpan data user di Firestore
      await usersRef.doc(user.uid).set({
        uid: user.uid,
        name: name,
        email: email,
        lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
        lastUpdate: firebase.firestore.FieldValue.serverTimestamp(),
        role: isAdmin ? "admin" : "member",
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        profileImage: "",
        saldo:0,
        totalIncome: 0,
        totalExpense: 0
      });

      // 4. Tampilkan notifikasi sukses
      showSuccess(`
        <div class="text-center p-4">
          <i class="fas fa-envelope-circle-check text-4xl text-green-500 mb-3"></i>
          <h4 class="font-bold text-xl">Pendaftaran Berhasil!</h4>
          <p class="mt-2 text-gray-200">Akun untuk <strong>${name}</strong> telah dibuat.</p>
          <p class="text-sm text-gray-400 mt-1">Email verifikasi telah dikirim ke ${email}</p>
          
          <div class="mt-4 bg-blue-900/20 border border-blue-700 rounded-lg p-3 text-left">
            <p class="text-sm text-blue-300">
              <i class="fas fa-info-circle mr-1"></i> Jika tidak menerima email:
            </p>
            <ul class="list-disc pl-5 text-sm text-blue-200 mt-1">
              <li>Periksa folder spam</li>
              <li>Tunggu beberapa menit</li>
              <li>Kirim ulang email verifikasi</li>
            </ul>
          </div>
          
          <div class="mt-4 flex justify-center gap-3">
            <button onclick="resendVerificationEmail('${email}')" 
                    class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-white">
              <i class="fas fa-paper-plane mr-2"></i> Kirim Ulang Email
            </button>
            <button onclick="document.getElementById('login-tab').click(); document.getElementById('login-email').value = '${email}'" 
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white">
              <i class="fas fa-sign-in-alt mr-2"></i> Ke Halaman Login
            </button>
          </div>
        </div>
      `);

      // 5. Reset form
      document.getElementById('register-form').reset();
      document.getElementById('admin-code-container').classList.add('hidden');
      document.getElementById('is-admin').checked = false;

      // 6. Logout otomatis setelah notifikasi sukses (10 detik) sudah cukup terbaca
      // Menunggu 11 detik agar notifikasi (10 detik) punya waktu penuh
      setTimeout(async () => {
        try {
          await auth.signOut();
        } catch (logoutError) {
          console.error("Gagal logout setelah pendaftaran:", logoutError);
        }
      }, 11000); // Logout setelah 11 detik

      // 7. Pastikan email verifikasi terkirim (di background)
      await verificationPromise;

    } catch (error) {
      let errorMessage = '';
      
      if (error.code === 'auth/email-already-in-use') {
        errorMessage = `
          <div class="text-center p-4">
            <i class="fas fa-envelope text-4xl text-red-500 mb-3"></i>
            <h4 class="font-bold text-xl">Email Sudah Terdaftar!</h4>
            <p class="mt-2 text-gray-200">Email <strong>${email}</strong> sudah digunakan.</p>
            <div class="mt-4 flex justify-center gap-3">
              <button onclick="document.getElementById('login-tab').click(); document.getElementById('login-email').value = '${email}'" 
                      class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-white">
                <i class="fas fa-sign-in-alt mr-2"></i> Login Sekarang
              </button>
              <button onclick="document.getElementById('reset-tab').click(); document.getElementById('reset-email').value = '${email}'" 
                      class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white">
                <i class="fas fa-key mr-2"></i> Reset Password
              </button>
            </div>
          </div>
        `;
      } else if (error.code === 'auth/weak-password') {
        errorMessage = `
          <div class="text-center p-4">
            <i class="fas fa-shield-alt text-4xl text-red-500 mb-3"></i>
            <h4 class="font-bold text-xl">Password Terlalu Lemah!</h4>
            <p class="mt-2 text-gray-200">Password harus minimal 6 karakter.</p>
          </div>
        `;
      } else if (error.code === 'auth/invalid-email') {
        errorMessage = `
          <div class="text-center p-4">
            <i class="fas fa-at text-4xl text-red-500 mb-3"></i>
            <h4 class="font-bold text-xl">Format Email Tidak Valid!</h4>
            <p class="mt-2 text-gray-200">Gunakan format email yang benar (contoh: user@domain.com)</p>
          </div>
        `;
      } else {
        errorMessage = `
          <div class="text-center p-4">
            <i class="fas fa-exclamation-circle text-4xl text-red-500 mb-3"></i>
            <h4 class="font-bold text-xl">Gagal Mendaftar!</h4>
            <p class="mt-2 text-gray-200">${error.message || 'Terjadi kesalahan saat pendaftaran'}</p>
          </div>
        `;
      }
      
      showError(errorMessage);
    } finally {
      // Reset button state
      if (registerBtn) {
        registerBtn.innerHTML = originalText;
        registerBtn.disabled = false;
      }
    }
  });

  // ================= RESET PASSWORD HANDLER =================
  document.getElementById('reset-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('reset-email').value;
    
    // Pindahkan deklarasi originalText ke sini agar dapat diakses di finally
    const resetBtn = e.target.querySelector('button[type="submit"]');
    let originalText = resetBtn ? resetBtn.innerHTML : 'Kirim Link Reset'; // Default text

    try {
      // Tampilkan loading state
      if (resetBtn) {
        resetBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mengirim...';
        resetBtn.disabled = true;
      }

      await auth.sendPasswordResetEmail(email, {
        url: window.location.href + '?from=reset-password',
        handleCodeInApp: true
      });

      // Notifikasi sukses dengan detail
      showSuccess(`
        <div class="text-center p-4">
          <i class="fas fa-paper-plane text-4xl text-green-500 mb-3"></i>
          <h4 class="font-bold text-xl">Email Reset Password Terkirim!</h4>
          <p class="mt-2 text-gray-200">Tautan reset telah dikirim ke <strong>${email}</strong></p>
          <p class="text-sm text-gray-400 mt-1">Link berlaku selama 24 jam.</p>
          
          <div class="mt-4 bg-blue-900/20 border border-blue-700 rounded-lg p-3 text-left">
            <p class="text-sm text-blue-300">
              <i class="fas fa-info-circle mr-1"></i> Jika tidak menerima email:
            </p>
            <ul class="list-disc pl-5 text-sm text-blue-200 mt-1">
              <li>Periksa folder spam</li>
              <li>Pastikan email yang dimasukkan benar</li>
              <li>Kirim ulang email reset</li>
            </ul>
          </div>
          
          <div class="mt-4 flex justify-center gap-3">
            <button onclick="resendResetPasswordEmail('${email}')" 
                    class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-white">
              <i class="fas fa-redo mr-2"></i> Kirim Ulang
            </button>
            <button onclick="document.getElementById('login-tab').click(); document.getElementById('login-email').value = '${email}'" 
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white">
              <i class="fas fa-sign-in-alt mr-2"></i> Ke Halaman Login
            </button>
          </div>
        </div>
      `);

      document.getElementById('reset-form').reset();
      
    } catch (error) {
      let errorMessage = '';
      
      if (error.code === 'auth/user-not-found') {
        errorMessage = `
          <div class="text-center p-4">
            <i class="fas fa-user-times text-4xl text-red-500 mb-3"></i>
            <h4 class="font-bold text-xl">Email Tidak Terdaftar!</h4>
            <p class="mt-2 text-gray-200">Email <strong>${email}</strong> belum terdaftar di sistem.</p>
            <button onclick="document.getElementById('register-tab').click(); document.getElementById('register-email').value = '${email}'" 
                    class="mt-3 px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-white">
              <i class="fas fa-user-plus mr-2"></i> Daftar Sekarang
            </button>
          </div>
        `;
      } else if (error.code === 'auth/invalid-email') {
        errorMessage = `
          <div class="text-center p-4">
            <i class="fas fa-at text-4xl text-red-500 mb-3"></i>
            <h4 class="font-bold text-xl">Format Email Tidak Valid!</h4>
            <p class="mt-2 text-gray-200">Gunakan format email yang benar (contoh: user@domain.com)</p>
          </div>
        `;
      } else {
        errorMessage = `
          <div class="text-center p-4">
            <i class="fas fa-exclamation-circle text-4xl text-red-500 mb-3"></i>
            <h4 class="font-bold text-xl">Gagal Mengirim Email Reset!</h4>
            <p class="mt-2 text-gray-200">${error.message || 'Terjadi kesalahan saat mengirim email reset password'}</p>
          </div>
        `;
      }
      
      showError(errorMessage);
    } finally {
      // Reset button state
      if (resetBtn) {
        resetBtn.innerHTML = originalText;
        resetBtn.disabled = false;
      }
    }
  });

  // ================= AUTH STATE LISTENER =================
  auth.onAuthStateChanged(async user => {
    if (user) {
      // Periksa verifikasi email dan data Firestore
      const userDoc = await usersRef.doc(user.uid).get();
      
      if (user.emailVerified && userDoc.exists) {
        currentUser = user;
        await loadUserData();
        
        // Handle redirect setelah verifikasi email/reset password
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('from')) {
          let message = '';
          
          switch(urlParams.get('from')) {
            case 'verify-email':
              message = `
                <div class="text-center p-4">
                  <i class="fas fa-check-circle text-4xl text-green-500 mb-3"></i>
                  <h4 class="font-bold text-xl">Email Berhasil Diverifikasi!</h4>
                  <p class="mt-2 text-gray-200">Akun Anda sekarang aktif. Selamat datang, ${userDoc.data().name || user.email}!</p>
                </div>
              `;
              break;
              
            case 'reset-password':
              message = `
                <div class="text-center p-4">
                  <i class="fas fa-key text-4xl text-green-500 mb-3"></i>
                  <h4 class="font-bold text-xl">Password Berhasil Diubah!</h4>
                  <p class="mt-2 text-gray-200">Anda telah login dengan password baru.</p>
                </div>
              `;
              break;
          }
          
          if (message) {
            showSuccess(message);
            // Hapus parameter URL
            window.history.replaceState({}, document.title, window.location.pathname);
          }
        }
      } else {
        // Logout jika email belum verifikasi atau data tidak lengkap
        await auth.signOut();
      }
    } else {
      // User tidak login
      currentUser = null;
      document.getElementById('dashboard').classList.add('hidden');
      document.getElementById('auth-container').classList.remove('hidden');
      document.getElementById('logout-btn').classList.add('hidden');
      document.getElementById('login-btn').classList.remove('hidden');
      document.getElementById('user-email').classList.add('hidden');
      document.getElementById('user-role').classList.add('hidden');
      
      document.querySelectorAll('.admin-only').forEach(el => {
        el.style.display = 'none';
      });

      document.getElementById('login-tab').click();
    }
  });

  // ================= HELPER FUNCTIONS =================
  // Fungsi untuk kirim ulang email verifikasi
  window.resendVerificationEmail = async (email) => {
    let originalButtonTexts = {}; // Untuk menyimpan teks asli tombol

    try {
      let user = auth.currentUser;
      
      // Jika email diberikan sebagai parameter tapi user belum login
      if (email && (!user || user.email !== email)) {
        const methods = await auth.fetchSignInMethodsForEmail(email);
        if (methods.length > 0) {
          showError(`
            <div class="text-center p-4">
              <i class="fas fa-info-circle text-4xl text-blue-500 mb-3"></i>
              <h4 class="font-bold text-xl">Silakan Login Terlebih Dahulu</h4>
              <p class="mt-2 text-gray-200">Akun dengan email ${email} sudah ada.</p>
              <button onclick="document.getElementById('login-tab').click(); document.getElementById('login-email').value = '${email}'" 
                      class="mt-3 px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-white">
                <i class="fas fa-sign-in-alt mr-2"></i> Login Sekarang
              </button>
            </div>
          `);
          return;
        }
      }

      if (!user) {
        throw new Error("Tidak ada user yang login. Silakan login terlebih dahulu.");
      }

      // Tampilkan loading state pada semua tombol kirim ulang
      const buttons = document.querySelectorAll(`button[onclick*="resendVerificationEmail('${user.email}')"], button[onclick*="resendVerificationEmail()"]`);
      buttons.forEach((btn, index) => {
        originalButtonTexts[index] = btn.innerHTML; // Simpan teks asli
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mengirim...';
        btn.disabled = true;
      });

      await user.sendEmailVerification({
        url: window.location.href + '?from=verify-email',
        handleCodeInApp: true
      });
      
      showSuccess(`
        <div class="text-center p-4">
          <i class="fas fa-paper-plane text-4xl text-green-500 mb-3"></i>
          <h4 class="font-bold text-xl">Email Verifikasi Telah Dikirim Ulang!</h4>
          <p class="mt-2 text-gray-200">Silakan cek inbox email <strong>${user.email}</strong></p>
          <p class="text-sm text-gray-400 mt-1">Link verifikasi berlaku selama 24 jam.</p>
        </div>
      `);
    } catch (error) {
      showError(`
        <div class="text-center p-4">
          <i class="fas fa-exclamation-circle text-4xl text-red-500 mb-3"></i>
          <h4 class="font-bold text-xl">Gagal Mengirim Ulang Email!</h4>
          <p class="mt-2 text-gray-200">${error.message}</p>
        </div>
      `);
    } finally {
      // Reset button state
      const buttons = document.querySelectorAll(`button[onclick*="resendVerificationEmail('${email}')"], button[onclick*="resendVerificationEmail()"]`);
      buttons.forEach((btn, index) => {
        btn.innerHTML = originalButtonTexts[index] || '<i class="fas fa-paper-plane mr-2"></i> Kirim Ulang'; // Gunakan teks asli
        btn.disabled = false;
      });
    }
  };

  // Fungsi untuk kirim ulang email reset password
  window.resendResetPasswordEmail = async (email) => {
    let originalButtonTexts = {}; // Untuk menyimpan teks asli tombol

    try {
      if (!email) {
        email = prompt("Masukkan email Anda:");
        if (!email) return;
      }
      
      // Tampilkan loading state pada semua tombol kirim ulang
      const buttons = document.querySelectorAll(`button[onclick*="resendResetPasswordEmail('${email}')"], button[onclick*="resendResetPasswordEmail()"]`);
      buttons.forEach((btn, index) => {
        originalButtonTexts[index] = btn.innerHTML; // Simpan teks asli
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mengirim...';
        btn.disabled = true;
      });

      await auth.sendPasswordResetEmail(email, {
        url: window.location.href + '?from=reset-password',
        handleCodeInApp: true
      });
      
      showSuccess(`
        <div class="text-center p-4">
          <i class="fas fa-paper-plane text-4xl text-green-500 mb-3"></i>
          <h4 class="font-bold text-xl">Email Reset Password Telah Dikirim Ulang!</h4>
          <p class="mt-2 text-gray-200">Silakan cek inbox email <strong>${email}</strong></p>
          <p class="text-sm text-gray-400 mt-1">Link reset berlaku selama 24 jam.</p>
        </div>
      `);
    } catch (error) {
      showError(`
        <div class="text-center p-4">
          <i class="fas fa-exclamation-circle text-4xl text-red-500 mb-3"></i>
          <h4 class="font-bold text-xl">Gagal Mengirim Ulang Email Reset!</h4>
          <p class="mt-2 text-gray-200">${error.message}</p>
        </div>
      `);
    } finally {
      // Reset button state
      const buttons = document.querySelectorAll(`button[onclick*="resendResetPasswordEmail('${email}')"], button[onclick*="resendResetPasswordEmail()"]`);
      buttons.forEach((btn, index) => {
        btn.innerHTML = originalButtonTexts[index] || '<i class="fas fa-redo mr-2"></i> Kirim Ulang'; // Gunakan teks asli
        btn.disabled = false;
      });
    }
  };
  // Logout button
      document.getElementById('logout-btn').addEventListener('click', async () => {
        try {
          await auth.signOut();
          showSuccess("Anda telah berhasil logout.");
        } catch (error) {
          showError("Gagal logout: " + error.message);
        }
      });
}
    // ================= USER MANAGEMENT =================
    async function loadUserData() {
      if (!currentUser) return;

      try {
        const userDoc = await usersRef.doc(currentUser.uid).get();
        
        if (!userDoc.exists) {
          showError("Data pengguna tidak ditemukan di Firestore.");
          await auth.signOut();
          return;
        }

        const userData = userDoc.data();
        
        // Update UI
        document.getElementById('user-initial').textContent = userData.name.charAt(0);
        document.getElementById('user-initial-setting').textContent = userData.name.charAt(0);
        document.getElementById('user-name').textContent = userData.name;
        document.getElementById('user-email-display').textContent = userData.email;
        document.getElementById('setting-name').value = userData.name;
        document.getElementById('setting-email').value = userData.email;
        
        // Update role badge
        const roleBadge = document.getElementById('role-badge');
        roleBadge.textContent = userData.role === 'admin' ? 'Admin' : 'Member';
        roleBadge.className = userData.role === 'admin' ? 
          'role-badge admin-badge' : 'role-badge member-badge';
        
        // Update user stats
        document.getElementById('user-income').textContent = formatRupiah(userData.totalIncome || 0);
        document.getElementById('user-expense').textContent = formatRupiah(userData.totalExpense || 0);
        
        // Show profile image if exists
        if (userData.profileImage) {
          document.getElementById('profile-avatar').classList.add('hidden');
          document.getElementById('profile-image').classList.remove('hidden');
          document.getElementById('profile-image').src = userData.profileImage;
          
          document.getElementById('profile-avatar-setting').classList.add('hidden');
          document.getElementById('profile-image-setting').classList.remove('hidden');
          document.getElementById('profile-image-setting').src = userData.profileImage;
        } else {
          document.getElementById('profile-avatar').classList.remove('hidden');
          document.getElementById('profile-image').classList.add('hidden');
          document.getElementById('profile-avatar-setting').classList.remove('hidden');
          document.getElementById('profile-image-setting').classList.add('hidden');
        }
        
        // Show admin elements
        if (userData.role === 'admin') {
          document.querySelectorAll('.admin-only').forEach(el => {
            el.style.display = 'block';
          });
        } else {
          document.querySelectorAll('.admin-only').forEach(el => {
            el.style.display = 'none';
          });
        }
        
        // Show dashboard
        document.getElementById('auth-container').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');
        document.getElementById('logout-btn').classList.remove('hidden');
        document.getElementById('login-btn').classList.add('hidden');
        document.getElementById('user-email').textContent = userData.email;
        document.getElementById('user-email').classList.remove('hidden');
        document.getElementById('user-role').textContent = userData.role === 'admin' ? 'Admin' : 'Member';
        document.getElementById('user-role').classList.remove('hidden');
        
        // Load data
        await Promise.all([
          loadTransactions(),
          loadAgendas(),
          loadPosts(),
          loadUsers()
        ]);

        updateBalance();

        // Set default section to kas-section after login
        hideAllSections();
        document.getElementById('kas-section').classList.remove('hidden');

      } catch (error) {
        showError("Gagal memuat data pengguna: " + error.message);
        auth.signOut();
      }
    }

    // ================= TRANSACTION MANAGEMENT =================
    function initTransactionListeners() {
      // Add transaction button
      document.getElementById('add-transaction-btn').addEventListener('click', () => {
        document.getElementById('transaction-form').classList.remove('hidden');
        document.getElementById('transaction-form').reset();
        editingTransactionId = null;
        document.getElementById('radioSemuaUser').checked = true;
        initializeRadioButtons();
      });

      // Cancel transaction button
      document.getElementById('cancel-transaction-btn').addEventListener('click', () => {
        document.getElementById('transaction-form').classList.add('hidden');
        document.getElementById('transaction-form').reset();
        editingTransactionId = null;
        document.getElementById('radioSemuaUser').checked = true;
        document.getElementById('emailInputContainer').classList.add('section-hidden');
        document.getElementById('allUserMessage').classList.remove('section-hidden');
      });

      // Transaction form submit
      document.getElementById('transaction-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const type = document.getElementById('transaction-type').value;
  const amount = parseFloat(document.getElementById('transaction-amount').value);
  const description = document.getElementById('transaction-desc').value;
  
  const radioPenerimaTerpilih = document.querySelector('input[name="penerimaEmail"]:checked');
  let selectedRecipientType = null;
  let recipientEmails = [];
  let totalAmount = 0; // This will track the total amount for global balance

  if (radioPenerimaTerpilih) {
    selectedRecipientType = radioPenerimaTerpilih.value;
    if (selectedRecipientType === 'pilih_user' || selectedRecipientType === 'input_manual') {
      const inputEmailValue = document.getElementById('inputEmail').value;
      recipientEmails = inputEmailValue.split(',').map(email => email.trim()).filter(email => email);
      totalAmount = amount; // For specific users, total amount is just the amount
    } else if (selectedRecipientType === 'semua_user') {
      recipientEmails = ['ALL_USERS'];
      // For ALL_USERS, we'll calculate the total amount after getting user count
    }
  } else {
    showError("Pilih jenis penerima email.");
    return;
  }

  // Validation checks
  if (isNaN(amount) || amount <= 0) {
    showError("Jumlah transaksi harus angka positif.");
    return;
  }
  if (!description.trim()) {
    showError("Deskripsi transaksi tidak boleh kosong.");
    return;
  }
  if (!currentUser || !currentUser.uid) {
    showError("Anda harus login untuk melakukan transaksi.");
    return;
  }

  try {
    await db.runTransaction(async (transaction) => {
      const newTransactionRef = transactionsRef.doc();
      
      // Get global metrics
      const globalMetricsDoc = await transaction.get(appDataRef);
      let globalData = globalMetricsDoc.data() || { totalAppIncome: 0, totalAppExpense: 0 };
      
      // Get users to update based on recipient type
      let usersToUpdate = [];
      
      if (selectedRecipientType === 'semua_user') {
        const allUsersSnapshot = await usersRef.get();
        allUsersSnapshot.docs.forEach(userDoc => {
          usersToUpdate.push({
            ref: usersRef.doc(userDoc.id),
            data: userDoc.data()
          });
        });
        // Calculate total amount for ALL_USERS (amount * number of users)
        totalAmount = amount * allUsersSnapshot.size;
      } else if (selectedRecipientType === 'pilih_user' || selectedRecipientType === 'input_manual') {
        // Get specific users by email
        for (const email of recipientEmails) {
          const userQuery = await usersRef.where('email', '==', email).limit(1).get();
          if (!userQuery.empty) {
            const userDoc = userQuery.docs[0];
            usersToUpdate.push({
              ref: usersRef.doc(userDoc.id),
              data: userDoc.data()
            });
          }
        }
        totalAmount = amount; // For specific users, total amount is just the amount
      } else {
        // Default to current user
        const currentUserDoc = await transaction.get(usersRef.doc(currentUser.uid));
        usersToUpdate.push({
          ref: usersRef.doc(currentUser.uid),
          data: currentUserDoc.data()
        });
        totalAmount = amount; // For current user, total amount is just the amount
      }

      // PHASE 2: ALL WRITES
      // 1. Create new transaction
      transaction.set(newTransactionRef, {
        userId: currentUser.uid,
        userName: document.getElementById('user-name').textContent,
        type: type,
        amount: amount, // Individual amount
        totalAmount: totalAmount, // Total amount for all recipients
        description: description,
        date: firebase.firestore.FieldValue.serverTimestamp(),
        recipients: recipientEmails
      });
      
      // 2. Update user balances
      for (const user of usersToUpdate) {
        let newIncome = user.data.totalIncome || 0;
        let newExpense = user.data.totalExpense || 0;
        
        if (type === 'masuk') {
          newIncome += amount;
        } else {
          newExpense += amount;
        }
        
        transaction.update(user.ref, {
          totalIncome: newIncome,
          totalExpense: newExpense
        });
      }
      
      // 3. Update global metrics using the totalAmount
      let newAppIncome = globalData.totalAppIncome || 0;
      let newAppExpense = globalData.totalAppExpense || 0;
      
      if (type === 'masuk') {
        newAppIncome += totalAmount;
      } else {
        newAppExpense += totalAmount;
      }
      
      transaction.update(appDataRef, {
        totalAppIncome: newAppIncome,
        totalAppExpense: newAppExpense,
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
      });
    });

    showSuccess("Transaksi berhasil ditambahkan!");
    document.getElementById('transaction-form').classList.add('hidden');
    document.getElementById('transaction-form').reset();
    loadTransactions();
    updateBalance();
  } catch (error) {
    showError("Gagal menambahkan transaksi: " + error.message);
  }
});

      // Print transactions button
      document.getElementById('print-transactions').addEventListener('click', async () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.setFontSize(18);
        doc.text("Laporan Transaksi Wallet QC", 14, 22);
        doc.setFontSize(11);
        doc.text(`Dicetak pada: ${new Date().toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'})}`, 14, 30);
        
        try {
          const snapshot = await transactionsRef.orderBy('date', 'desc').get();
          const transactionsData = [];
          
          snapshot.forEach(doc => {
            const transaction = doc.data();
            const transactionDate = transaction.date ? transaction.date.toDate() : new Date();
            const formattedDate = transactionDate.toLocaleDateString('id-ID');
            transactionsData.push([
              formattedDate,
              transaction.userName,
              transaction.description,
              transaction.type === 'masuk' ? formatRupiah(transaction.amount) : '-',
              transaction.type === 'keluar' ? formatRupiah(transaction.amount) : ''
            ]);
          });

          doc.autoTable({
            startY: 40,
            head: [['Tanggal', 'Pengguna', 'Deskripsi', 'Masuk', 'Keluar']],
            body: transactionsData,
            theme: 'striped',
            headStyles: { fillColor: [139, 92, 246] },
            styles: { fontSize: 9, cellPadding: 3 },
            columnStyles: {
              0: { cellWidth: 25 },
              1: { cellWidth: 25 },
              2: { cellWidth: 60 },
              3: { cellWidth: 30 },
              4: { cellWidth: 30 }
            }
          });

          doc.save('Laporan_Transaksi_WalletQC.pdf');
          showSuccess("Laporan transaksi berhasil diunduh!");
        } catch (error) {
          showError("Gagal membuat laporan PDF: " + error.message);
        }
      });
    }

    async function loadTransactions() {
      const transactionsList = document.getElementById('transactions-list');
      transactionsList.innerHTML = `
        <div class="text-center py-10">
          <div class="loading mx-auto"></div>
          <p class="mt-3 text-gray-400">Memuat data transaksi...</p>
        </div>
      `;

      try {
        const snapshot = await transactionsRef.orderBy('date', 'desc').get();
        transactionsList.innerHTML = '';

        if (snapshot.empty) {
          transactionsList.innerHTML = `
            <p class="text-center py-6 text-gray-400">Belum ada transaksi</p>
          `;
          
          // Reset balances if no transactions
          if (currentUser?.uid) {
            await resetUserBalance(currentUser.uid);
          }
          
          await resetGlobalBalance();
          updateBalance(0, 0);
          return;
        }

        let totalIncome = 0;
        let totalExpense = 0;
        
        snapshot.forEach(doc => {
          const transaction = doc.data();
          
          if (transaction.type === 'masuk') {
            totalIncome += transaction.amount;
          } else {
            totalExpense += transaction.amount;
          }

          const transactionDate = transaction.date?.toDate() || new Date();
          const formattedDate = transactionDate.toLocaleDateString('id-ID', {
            day: 'numeric',
            month: 'long',
            year: 'numeric'
          });

          const transactionElement = document.createElement('div');
          transactionElement.className = `p-4 rounded-lg mb-3 ${
            transaction.type === 'masuk' 
              ? 'bg-green-50 border border-green-100' 
              : 'bg-red-50 border border-red-100'
          }`;
          
          transactionElement.innerHTML = `
            <div class="flex justify-between items-start">
              <div>
                <h4 class="font-medium text-gray-800">${transaction.description}</h4>
                <p class="text-sm text-gray-500 mt-1">${formattedDate}</p>
                ${transaction.recipients ? `
                  <p class="text-xs text-gray-400 mt-2">
                    <i class="fas fa-envelope mr-1"></i>
                    ${formatRecipients(transaction.recipients)}
                  </p>
                ` : ''}
              </div>
              <div class="text-right">
                <p class="${
                  transaction.type === 'masuk' 
                    ? 'text-green-600' 
                    : 'text-red-600'
                } font-mono font-medium">
                  ${transaction.type === 'masuk' ? '+' : '-'} 
                  ${formatRupiah(transaction.amount)}
                </p>
                <p class="text-xs text-gray-500 mt-1">${transaction.userName}</p>
              </div>
            </div>
            ${currentUser?.role === 'admin' ? `
              <div class="flex gap-2 mt-3">
                <button class="edit-transaction px-3 py-1 bg-blue-50 text-blue-600 rounded text-sm" 
                        data-id="${doc.id}">
                  <i class="fas fa-edit mr-1"></i> Edit
                </button>
                <button class="delete-transaction px-3 py-1 bg-red-50 text-red-600 rounded text-sm" 
                        data-id="${doc.id}">
                  <i class="fas fa-trash mr-1"></i> Hapus
                </button>
              </div>
            ` : ''}
          `;
          
          transactionsList.appendChild(transactionElement);
        });

        updateBalance(totalIncome, totalExpense);
        setupTransactionActions();

      } catch (error) {
        transactionsList.innerHTML = `
          <p class="text-center py-6 text-red-500">
            <i class="fas fa-exclamation-circle mr-2"></i>
            Gagal memuat transaksi: ${error.message}
          </p>
        `;
        updateBalance(0, 0);
      }
    }

    async function resetUserBalance(userId) {
      const userDocRef = usersRef.doc(userId);
      return db.runTransaction(async (transaction) => {
        const userDoc = await transaction.get(userDocRef);
        if (userDoc.exists) {
          const userData = userDoc.data();
          if (userData.totalIncome !== 0 || userData.totalExpense !== 0) {
            transaction.update(userDocRef, {
              totalIncome: 0,
              totalExpense: 0
            });
          }
        }
      });
    }

    async function resetGlobalBalance() {
      return db.runTransaction(async (transaction) => {
        const globalMetricsDocRef = appDataRef;
        const globalMetricsDoc = await transaction.get(globalMetricsDocRef);
        if (globalMetricsDoc.exists) {
          const globalData = globalMetricsDoc.data();
          if ((globalData.totalAppIncome || 0) !== 0 || (globalData.totalAppExpense || 0) !== 0) {
            transaction.update(globalMetricsDocRef, {
              totalAppIncome: 0,
              totalAppExpense: 0,
              lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
        } else {
          transaction.set(globalMetricsDocRef, {
            totalAppIncome: 0,
            totalExpense: 0,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
      });
    }

    function setupTransactionActions() {
      if (currentUser?.role === 'admin') {
        document.querySelectorAll('.edit-transaction').forEach(btn => {
          btn.addEventListener('click', (e) => editTransaction(e.target.dataset.id));
        });
        
        document.querySelectorAll('.delete-transaction').forEach(btn => {
          btn.addEventListener('click', (e) => deleteTransaction(e.target.dataset.id));
        });
      }
    }

    async function editTransaction(id) {
      try {
        const doc = await transactionsRef.doc(id).get();
        if (!doc.exists) {
          showError("Transaksi tidak ditemukan.");
          return;
        }

        const transaction = doc.data();
        document.getElementById('transaction-type').value = transaction.type;
        document.getElementById('transaction-amount').value = transaction.amount;
        document.getElementById('transaction-desc').value = transaction.description;
        
        // Set recipient type
        if (transaction.recipients?.includes('ALL_USERS')) {
          document.getElementById('radioSemuaUser').checked = true;
        } else if (transaction.recipients?.length > 0) {
          document.getElementById('radioPilihUser').checked = true;
          document.getElementById('inputEmail').value = transaction.recipients.join(', ');
        } else {
          document.getElementById('radioSemuaUser').checked = true;
        }
        
        initializeRadioButtons();
        document.getElementById('transaction-form').classList.remove('hidden');
        editingTransactionId = id;
        showSuccess("Anda sedang mengedit transaksi ini.");
      } catch (error) {
        showError("Gagal mengambil transaksi untuk diedit: " + error.message);
      }
    }

    async function deleteTransaction(id) {
  if (!confirm("Apakah Anda yakin ingin menghapus transaksi ini?")) return;

  try {
    await db.runTransaction(async (transaction) => {
      const transactionDocRef = transactionsRef.doc(id);
      const transactionDoc = await transaction.get(transactionDocRef);
      
      if (!transactionDoc.exists) {
        throw new Error("Transaksi tidak ditemukan.");
      }
      
      const transactionData = transactionDoc.data();
      const globalMetricsDocRef = appDataRef;
      const globalMetricsDoc = await transaction.get(globalMetricsDocRef);
      let globalData = globalMetricsDoc.data() || { totalAppIncome: 0, totalAppExpense: 0 };

      // Calculate the total amount to revert
      let totalAmountToRevert = transactionData.amount;
      if (transactionData.recipients?.includes('ALL_USERS')) {
        const allUsersSnapshot = await usersRef.get();
        totalAmountToRevert = transactionData.amount * allUsersSnapshot.size;
      }

      // Revert user balances
      if (transactionData.recipients?.includes('ALL_USERS')) {
        const allUsersSnapshot = await usersRef.get();
        for (const userDoc of allUsersSnapshot.docs) {
          const userRef = usersRef.doc(userDoc.id);
          const userData = userDoc.data();
          let newIncome = userData.totalIncome || 0;
          let newExpense = userData.totalExpense || 0;

          if (transactionData.type === 'masuk') {
            newIncome -= transactionData.amount;
          } else {
            newExpense -= transactionData.amount;
          }
          
          transaction.update(userRef, {
            totalIncome: newIncome,
            totalExpense: newExpense
          });
        }
      } else if (transactionData.recipients?.length > 0) {
        for (const email of transactionData.recipients) {
          const userQuerySnapshot = await usersRef.where('email', '==', email).limit(1).get();
          if (!userQuerySnapshot.empty) {
            const userDoc = userQuerySnapshot.docs[0];
            const userRef = usersRef.doc(userDoc.id);
            const userData = userDoc.data();
            let newIncome = userData.totalIncome || 0;
            let newExpense = userData.totalExpense || 0;

            if (transactionData.type === 'masuk') {
              newIncome -= transactionData.amount;
            } else {
              newExpense -= transactionData.amount;
            }
            
            transaction.update(userRef, {
              totalIncome: newIncome,
              totalExpense: newExpense
            });
          }
        }
      } else {
        // Revert for transaction creator
        const userDocRef = usersRef.doc(transactionData.userId);
        const userDoc = await transaction.get(userDocRef);
        if (userDoc.exists) {
          const userData = userDoc.data();
          let newIncome = userData.totalIncome || 0;
          let newExpense = userData.totalExpense || 0;

          if (transactionData.type === 'masuk') {
            newIncome -= transactionData.amount;
          } else {
            newExpense -= transactionData.amount;
          }
          
          transaction.update(userDocRef, {
            totalIncome: newIncome,
            totalExpense: newExpense
          });
        }
      }

      // Revert global balance
      let newTotalAppIncome = globalData.totalAppIncome;
      let newTotalAppExpense = globalData.totalAppExpense;

      if (transactionData.type === 'masuk') {
        newTotalAppIncome -= totalAmountToRevert;
      } else {
        newTotalAppExpense -= totalAmountToRevert;
      }
      
      transaction.update(globalMetricsDocRef, {
        totalAppIncome: newTotalAppIncome,
        totalAppExpense: newTotalAppExpense,
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
      });

      // Delete the transaction
      transaction.delete(transactionDocRef);
    });

    showSuccess("Transaksi berhasil dihapus!");
    loadTransactions();
  } catch (error) {
    showError("Gagal menghapus transaksi: " + error.message);
  }
}

     // ================= FUNGSI TRANSFER P2P YANG DIREVISI =================
    // ========== 1. UTILITY FUNCTIONS (Fungsi-fungsi Pendukung) =====
const ADMIN_FEE_PERCENTAGE = 0.01;

function showError(message) {
    const errorDiv = document.getElementById('transfer-error-message');
    errorDiv.textContent = message;
    errorDiv.classList.remove('hidden');
    setTimeout(() => errorDiv.classList.add('hidden'), 5000);
}

function showSuccess(message) {
    alert(message); // Ganti dengan UI modal yang lebih baik jika diperlukan
}

function formatRupiah(number) {
    return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(number);
}

function showSection(sectionId) {
    document.getElementById('transfer-section').classList.add('hidden');
    document.getElementById('create-pin-section').classList.add('hidden');
    document.getElementById(sectionId).classList.remove('hidden');
}

async function loadP2PTransactions() {
    if (!currentUser) {
        document.getElementById('p2p-transactions-list').innerHTML = '<p class="text-center text-gray-400">Silakan login untuk melihat riwayat transfer.</p>';
        return;
    }

    const p2pTransactionsList = document.getElementById('p2p-transactions-list');
    p2pTransactionsList.innerHTML = `<div class="text-center py-10"><p class="mt-3 text-gray-400">Memuat riwayat transfer...</p></div>`;

    try {
        const querySnapshot = await transactionsRef
            .where('userId', '==', currentUser.uid)
            .where('type', 'in', ['p2p_transfer_out', 'p2p_transfer_in'])
            .orderBy('timestamp', 'desc')
            .limit(20)
            .get();

        if (querySnapshot.empty) {
            p2pTransactionsList.innerHTML = '<p class="text-center text-gray-400">Belum ada riwayat transfer.</p>';
            return;
        }

        let transactionsHtml = '';
        querySnapshot.forEach(doc => {
            const transaction = doc.data();
            const date = transaction.timestamp ? new Date(transaction.timestamp.toDate()).toLocaleString() : 'N/A';
            const typeClass = transaction.type === 'p2p_transfer_in' ? 'transaction-in' : 'transaction-out';
            const amountSign = transaction.type === 'p2p_transfer_in' ? '+' : '-';
            const amountColor = transaction.type === 'p2p_transfer-in' ? 'text-green-400' : 'text-red-400';

            transactionsHtml += `
                <div class="solana-card p-4 flex items-center justify-between ${typeClass}">
                    <div>
                        <p class="font-medium">${transaction.description}</p>
                        <p class="text-sm text-gray-400">${date}</p>
                    </div>
                    <span class="font-bold ${amountColor}">${amountSign} ${formatRupiah(transaction.amount)}</span>
                </div>
            `;
        });
        p2pTransactionsList.innerHTML = transactionsHtml;
    } catch (error) {
        console.error("Error loading P2P transactions:", error);
        p2pTransactionsList.innerHTML = '<p class="text-center text-red-400">Gagal memuat riwayat transfer.</p>';
    }
}

      // Fungsi untuk memuat bcryptjs
function loadBCrypt() {
  return new Promise((resolve, reject) => {
    if (typeof bcrypt !== 'undefined') {
      return resolve();
    }
    
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js';
    script.onload = resolve;
    script.onerror = () => reject(new Error('Gagal memuat library bcrypt'));
    document.head.appendChild(script);
  });
}

// ===============================================
// 2. FUNGSI UTAMA P2P TRANSFER
// ===============================================

async function showTransferForm() {
    if (!currentUser) {
        showError('Anda harus login untuk melakukan transfer.');
        return;
    }
    try {
        const userDoc = await usersRef.doc(currentUser.uid).get();
        const userData = userDoc.data();
        if (!userData || !userData.pin) {
            showSection('create-pin-section');
        } else {
            showSection('transfer-section');
            await loadP2PTransactions();
        }
    } catch (error) {
        showError('Gagal memuat data user. Silakan coba lagi.');
        console.error("Error checking user PIN:", error);
    }
}

function showTransferLoading(isLoading) {
    const submitButton = document.getElementById('p2p-transfer-form').querySelector('button[type="submit"]');
    submitButton.disabled = isLoading;
    submitButton.textContent = isLoading ? 'Mengirim...' : 'Konfirmasi Transfer';
}

async function handleP2PTransfer(e) {
    e.preventDefault();
    const recipientEmail = document.getElementById('recipient-email').value.trim().toLowerCase();
    const amount = parseFloat(document.getElementById('transfer-amount').value);
    const note = document.getElementById('transfer-note').value.trim();
    const pin = document.getElementById('transfer-pin').value.trim();
    const transferErrorMessage = document.getElementById('transfer-error-message');
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    transferErrorMessage.classList.add('hidden');
    transferErrorMessage.textContent = '';

    if (!currentUser) { showError('Anda harus login.'); return; }
    if (!emailRegex.test(recipientEmail)) { showError('Email penerima tidak valid.'); return; }
    if (amount <= 0 || isNaN(amount)) { showError('Jumlah transfer harus lebih dari 0.'); return; }
    if (!/^\d{4}$/.test(pin)) { showError('PIN harus 4 digit angka.'); return; }
    if (recipientEmail === currentUser.email.toLowerCase()) { showError('Anda tidak bisa transfer ke akun Anda sendiri.'); return; }

    try {
        showTransferLoading(true);
        const senderDocRef = usersRef.doc(currentUser.uid);
        const senderSnap = await senderDocRef.get();
        const senderData = senderSnap.data();

        const isPinValid = await bcrypt.compare(pin, senderData.pin);
        if (!isPinValid) {
            showError('PIN transaksi salah.');
            return;
        }

        const recipientQuery = await usersRef.where('email', '==', recipientEmail).limit(1).get();
        if (recipientQuery.empty) { showError('Pengguna tidak ditemukan.'); return; }
        const recipientDoc = recipientQuery.docs[0];
        const recipientId = recipientDoc.id;
        const recipientData = recipientDoc.data();

        const adminFee = amount * ADMIN_FEE_PERCENTAGE;
        const totalAmountToSend = amount + adminFee;

        if (senderData.totalBalance < totalAmountToSend) {
            showError(`Saldo tidak mencukupi. Anda perlu ${formatRupiah(totalAmountToSend)} (termasuk biaya admin).`);
            return;
        }

        await db.runTransaction(async (transaction) => {
            const senderTxDoc = await transaction.get(senderDocRef);
            const recipientTxDoc = await transaction.get(usersRef.doc(recipientId));

            if (!senderTxDoc.exists || !recipientTxDoc.exists) { throw new Error('Data pengguna tidak ditemukan saat transaksi.'); }
            
            const senderCurrentData = senderTxDoc.data();
            if (senderCurrentData.totalBalance < totalAmountToSend) { throw new Error('Saldo tidak mencukupi saat transaksi dijalankan.'); }

            transaction.update(senderDocRef, { totalBalance: senderCurrentData.totalBalance - totalAmountToSend });
            transaction.update(usersRef.doc(recipientId), { totalBalance: (recipientTxDoc.data().totalBalance || 0) + amount });

            transaction.set(transactionsRef.doc(), {
                userId: currentUser.uid, type: 'p2p_transfer_out', amount: totalAmountToSend,
                description: note || `Transfer ke ${recipientData.name || recipientEmail}`,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            });
            transaction.set(transactionsRef.doc(), {
                userId: recipientId, type: 'p2p_transfer_in', amount: amount,
                description: `Transfer dari ${senderData.name || currentUser.email}`,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            });
            transaction.set(notificationsRef.doc(), {
                userId: recipientId, title: 'Transfer Masuk',
                message: `Anda menerima transfer ${formatRupiah(amount)} dari ${senderData.name || currentUser.email}.`,
                read: false,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            });
        });

        showSuccess('Transfer berhasil dikirim!');
        document.getElementById('p2p-transfer-form').reset();
        await loadUserData();
        await loadP2PTransactions();

    } catch (err) {
        console.error('Error saat transfer:', err);
        showError(`Gagal melakukan transfer: ${err.message || err}`);
    } finally {
        showTransferLoading(false);
    }
}

async function handleCreatePin(e) {
    e.preventDefault();
    const newPin = document.getElementById('new-pin').value;
    const confirmPin = document.getElementById('confirm-pin').value;
    const pinErrorMessage = document.getElementById('pin-error-message');

    pinErrorMessage.classList.add('hidden');
    
    if (newPin !== confirmPin) { pinErrorMessage.textContent = 'PIN tidak cocok.'; pinErrorMessage.classList.remove('hidden'); return; }
    if (!/^\d{4}$/.test(newPin)) { pinErrorMessage.textContent = 'PIN harus 4 digit angka.'; pinErrorMessage.classList.remove('hidden'); return; }
    
    try {
        const salt = await bcrypt.genSalt(10);
        const hashedPin = await bcrypt.hash(newPin, salt);
        await usersRef.doc(currentUser.uid).update({ pin: hashedPin });
        showSuccess('PIN berhasil dibuat. Anda sekarang dapat melakukan transfer.');
        document.getElementById('create-pin-form').reset();
        await showTransferForm(); // Tampilkan form transfer setelah PIN berhasil dibuat
    } catch (error) {
        showError('Gagal menyimpan PIN. Silakan coba lagi.');
        console.error("Error saving PIN:", error);
    }
}

// 3. INIT LISTENER
// ===============================================
document.addEventListener('DOMContentLoaded', async () => {
    try {
        // PENTING: Panggil fungsi loadBCrypt() dan tunggu hingga selesai
        await loadBCrypt();
        console.log('Library bcrypt berhasil dimuat.');

        // Kemudian, pasang semua event listener
        // Setelah bcrypt dimuat, fungsi handleCreatePin dan handleP2PTransfer
        // yang menggunakan bcrypt sekarang sudah aman untuk dipanggil.
        
        document.getElementById('show-transfer').addEventListener('click', showTransferForm);
        document.getElementById('p2p-transfer-form').addEventListener('submit', handleP2PTransfer);
        document.getElementById('create-pin-form').addEventListener('submit', handleCreatePin);

        // Contoh: Pemasangan listener untuk Auth
        // Pastikan variabel 'auth' dan 'currentUser' sudah dideklarasikan di scope global
        // auth.onAuthStateChanged(user => {
        //     if (user) {
        //         currentUser = user;
        //         // Bisa memanggil fungsi lain yang butuh user login di sini
        //     } else {
        //         currentUser = null;
        //     }
        // });

    } catch (error) {
        // Tangani error jika gagal memuat bcrypt
        console.error('Gagal memuat library bcrypt:', error);
        // Tampilkan pesan error di UI jika diperlukan
    }
});

    // ================= AGENDA MANAGEMENT =================
    function initAgendaListeners() {
      document.getElementById('add-agenda-btn').addEventListener('click', () => {
        document.getElementById('agenda-form').classList.remove('hidden');
        document.getElementById('agenda-form').reset();
        selectedAgendaFile = null;
        document.getElementById('agenda-file-name-display').textContent = 'Pilih file...';
        document.getElementById('agenda-attachment-preview').classList.add('hidden');
        editingAgendaId = null;
      });

      document.getElementById('cancel-agenda-btn').addEventListener('click', () => {
        document.getElementById('agenda-form').classList.add('hidden');
        document.getElementById('agenda-form').reset();
        selectedAgendaFile = null;
        document.getElementById('agenda-file-name-display').textContent = 'Pilih file...';
        document.getElementById('agenda-attachment-preview').classList.add('hidden');
        editingAgendaId = null;
      });

      document.getElementById('agenda-file').addEventListener('change', (e) => {
        selectedAgendaFile = e.target.files[0];
        if (selectedAgendaFile) {
          document.getElementById('agenda-file-name-display').textContent = selectedAgendaFile.name;
          document.getElementById('agenda-preview-name').textContent = selectedAgendaFile.name;
          document.getElementById('agenda-attachment-preview').classList.remove('hidden');
        } else {
          document.getElementById('agenda-file-name-display').textContent = 'Pilih file...';
          document.getElementById('agenda-attachment-preview').classList.add('hidden');
        }
      });

      document.getElementById('remove-agenda-attachment').addEventListener('click', () => {
        selectedAgendaFile = null;
        document.getElementById('agenda-file').value = '';
        document.getElementById('agenda-file-name-display').textContent = 'Pilih file...';
        document.getElementById('agenda-attachment-preview').classList.add('hidden');
      });

      document.getElementById('agenda-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const title = document.getElementById('agenda-title').value;
        const description = document.getElementById('agenda-desc').value;
        const date = document.getElementById('agenda-date').value;

        if (!title || !description || !date) {
          showError("Harap isi semua field yang diperlukan.");
          return;
        }

        let fileUrl = '';
        if (selectedAgendaFile) {
          try {
            const storageRef = storage.ref(`agendas/${currentUser.uid}/${Date.now()}_${selectedAgendaFile.name}`);
            const snapshot = await storageRef.put(selectedAgendaFile);
            fileUrl = await snapshot.ref.getDownloadURL();
          } catch (error) {
            showError("Gagal mengunggah file lampiran: " + error.message);
            return;
          }
        }

        const agendaData = {
          userId: currentUser.uid,
          userName: document.getElementById('user-name').textContent,
          title: title,
          description: description,
          date: date,
          fileUrl: fileUrl,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
          if (editingAgendaId) {
            await agendasRef.doc(editingAgendaId).update(agendaData);
            showSuccess("Agenda berhasil diperbarui!");
          } else {
            await agendasRef.add(agendaData);
            showSuccess("Agenda berhasil ditambahkan!");
          }

          document.getElementById('agenda-form').classList.add('hidden');
          document.getElementById('agenda-form').reset();
          selectedAgendaFile = null;
          document.getElementById('agenda-file-name-display').textContent = 'Pilih file...';
          document.getElementById('agenda-attachment-preview').classList.add('hidden');
          editingAgendaId = null;
          loadAgendas();
        } catch (error) {
          showError("Gagal menyimpan agenda: " + error.message);
        }
      });
    }

    async function loadAgendas() {
      const agendaList = document.getElementById('agenda-list');
      agendaList.innerHTML = '<div class="text-center py-10"><div class="loading mx-auto"></div><p class="mt-3 text-gray-400">Memuat data agenda...</p></div>';
      
      try {
        const snapshot = await agendasRef.orderBy('date', 'desc').get();
        agendaList.innerHTML = '';
        
        if (snapshot.empty) {
          agendaList.innerHTML = '<p class="text-center py-6 text-gray-400">Belum ada agenda</p>';
          return;
        }
        
        snapshot.forEach(doc => {
          const agenda = doc.data();
          const agendaDate = agenda.date;
          
          const agendaElement = document.createElement('div');
          agendaElement.className = `agenda-card p-4 bg-gray-800/50`;
          agendaElement.innerHTML = `
            <div class="flex justify-between items-center mb-2">
              <h4 class="font-medium text-lg">${agenda.title}</h4>
              <p class="text-sm text-gray-400">${agendaDate}</p>
            </div>
            <p class="text-gray-300 text-sm mb-2">${agenda.description}</p>
            ${agenda.fileUrl ? `<p class="text-xs text-purple-400"><a href="${agenda.fileUrl}" target="_blank" class="hover:underline"><i class="fas fa-paperclip mr-1"></i> Lampiran</a></p>` : ''}
            <p class="text-xs text-gray-500 mt-2">Dibuat oleh: ${agenda.userName}</p>
            ${currentUser && currentUser.role === 'admin' ? `
              <div class="action-buttons mt-3">
                <button class="edit-agenda action-button" data-id="${doc.id}">
                  <i class="fas fa-edit mr-1"></i> Edit
                </button>
                <button class="delete-agenda action-button text-red-400" data-id="${doc.id}">
                  <i class="fas fa-trash mr-1"></i> Hapus
                </button>
              </div>
            ` : ''}
          `;
          
          agendaList.appendChild(agendaElement);
        });

        if (currentUser && currentUser.role === 'admin') {
          agendaList.querySelectorAll('.edit-agenda').forEach(button => {
            button.onclick = (e) => editAgenda(e.currentTarget.dataset.id);
          });
          agendaList.querySelectorAll('.delete-agenda').forEach(button => {
            button.onclick = (e) => deleteAgenda(e.currentTarget.dataset.id);
          });
        }
      } catch (error) {
        agendaList.innerHTML = `<p class="text-center py-6 text-red-400">Gagal memuat agenda: ${error.message}</p>`;
      }
    }

    async function editAgenda(id) {
      try {
        const doc = await agendasRef.doc(id).get();
        if (!doc.exists) {
          showError("Agenda tidak ditemukan.");
          return;
        }

        const agenda = doc.data();
        document.getElementById('agenda-title').value = agenda.title;
        document.getElementById('agenda-desc').value = agenda.description;
        document.getElementById('agenda-date').value = agenda.date;
        
        if (agenda.fileUrl) {
          const fileName = agenda.fileUrl.split('/').pop().split('?')[0].split('_').slice(1).join('_');
          document.getElementById('agenda-file-name-display').textContent = fileName;
          document.getElementById('agenda-preview-name').textContent = fileName;
          document.getElementById('agenda-attachment-preview').classList.remove('hidden');
        } else {
          document.getElementById('agenda-file-name-display').textContent = 'Pilih file...';
          document.getElementById('agenda-attachment-preview').classList.add('hidden');
        }

        document.getElementById('agenda-form').classList.remove('hidden');
        editingAgendaId = id;
        showSuccess("Anda sedang mengedit agenda ini.");
      } catch (error) {
        showError("Gagal mengambil agenda untuk diedit: " + error.message);
      }
    }

    async function deleteAgenda(id) {
      if (!confirm("Apakah Anda yakin ingin menghapus agenda ini?")) return;

      try {
        const doc = await agendasRef.doc(id).get();
        if (!doc.exists) {
          showError("Agenda tidak ditemukan.");
          return;
        }

        const agenda = doc.data();
        
        // Delete file from storage if exists
        if (agenda.fileUrl) {
          const fileRef = storage.refFromURL(agenda.fileUrl);
          await fileRef.delete();
        }

        await agendasRef.doc(id).delete();
        showSuccess("Agenda berhasil dihapus!");
        loadAgendas();
      } catch (error) {
        showError("Gagal menghapus agenda: " + error.message);
      }
    }

    // ================= SOCIAL MEDIA FUNCTIONS =================
    function initSocialListeners() {
      // Post image change
      document.getElementById('post-image').addEventListener('change', (e) => {
        selectedPostFile = e.target.files[0];
        const previewImage = document.getElementById('preview-image');
        const previewVideo = document.getElementById('preview-video');
        const previewContainer = document.getElementById('post-attachment-preview-container');

        if (selectedPostFile) {
          const fileType = selectedPostFile.type;
          const reader = new FileReader();
          reader.onload = (e) => {
            if (fileType.startsWith('image/')) {
              previewImage.src = e.target.result;
              previewImage.classList.remove('hidden');
              previewVideo.classList.add('hidden');
            } else if (fileType.startsWith('video/')) {
              previewVideo.src = e.target.result;
              previewVideo.classList.remove('hidden');
              previewImage.classList.add('hidden');
            }
            previewContainer.classList.remove('hidden');
          };
          reader.readAsDataURL(selectedPostFile);
          document.getElementById('image-name-display').textContent = selectedPostFile.name;
        } else {
          previewContainer.classList.add('hidden');
          previewImage.classList.add('hidden');
          previewVideo.classList.add('hidden');
          previewImage.src = '';
          previewVideo.src = '';
          document.getElementById('image-name-display').textContent = 'Lampirkan Gambar/Video';
        }
      });

      // Remove attachment
      document.getElementById('remove-attachment').addEventListener('click', () => {
        selectedPostFile = null;
        document.getElementById('post-image').value = '';
        document.getElementById('post-attachment-preview-container').classList.add('hidden');
        document.getElementById('preview-image').classList.add('hidden');
        document.getElementById('preview-video').classList.add('hidden');
        document.getElementById('preview-image').src = '';
        document.getElementById('preview-video').src = '';
        document.getElementById('image-name-display').textContent = 'Lampirkan Gambar/Video';
      });

      // Post form submit
      document.getElementById('post-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const content = document.getElementById('post-content').value;

        if (!currentUser?.uid) {
          showError("Anda harus login untuk membuat postingan.");
          return;
        }

        if (!content.trim() && !selectedPostFile) {
          showError("Postingan tidak boleh kosong!");
          return;
        }

        let fileUrl = '';
        let fileType = '';

        if (selectedPostFile) {
          try {
            const storageRef = storage.ref(`posts/${currentUser.uid}/${Date.now()}_${selectedPostFile.name}`);
            const snapshot = await storageRef.put(selectedPostFile);
            fileUrl = await snapshot.ref.getDownloadURL();
            fileType = selectedPostFile.type.startsWith('image/') ? 'image' : 
                      (selectedPostFile.type.startsWith('video/') ? 'video' : '');
          } catch (error) {
            showError("Gagal mengunggah lampiran postingan: " + error.message);
            return;
          }
        }

        const userProfileImage = currentUser.photoURL || document.getElementById('profile-image').src || '';
        const userName = currentUser.name || currentUser.email.split('@')[0] || document.getElementById('user-name').textContent;

        try {
          await postsRef.add({
            userId: currentUser.uid,
            userName: userName,
            userProfileImage: userProfileImage,
            content: content.trim(),
            fileUrl: fileUrl,
            fileType: fileType,
            likesCount: 0,
            commentsCount: 0,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });

          showSuccess("Postingan berhasil diterbitkan!");
          document.getElementById('post-form').reset();
          document.getElementById('remove-attachment').click();
          loadPosts();
        } catch (error) {
          showError("Gagal menerbitkan postingan: " + error.message);
        }
      });
    }

    async function loadPosts() {
      const socialFeed = document.getElementById('social-feed');
      socialFeed.innerHTML = '<div class="text-center py-10"><div class="loading mx-auto"></div><p class="mt-3 text-gray-400">Memuat postingan...</p></div>';

      try {
        const snapshot = await postsRef.orderBy('createdAt', 'desc').get();
        socialFeed.innerHTML = '';

        if (snapshot.empty) {
          socialFeed.innerHTML = '<p class="text-center py-6 text-gray-400">Belum ada postingan</p>';
          return;
        }

        const postPromises = snapshot.docs.map(async doc => {
          const post = doc.data();
          const postId = doc.id;
          const postDate = post.createdAt ? post.createdAt.toDate().toLocaleDateString('id-ID', { 
            day: 'numeric', 
            month: 'long', 
            year: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit' 
          }) : 'Tidak diketahui';

          // Tempatkan kode ini DI SINI
            const senderName = post.userName || 'Anonim'; // Gunakan post.userName
            const senderHtml = `
            <span class="font-medium hover:underline cursor-pointer" onclick="showUserProfile('${post.userId}')">
            ${senderName}
            </span>
            `;

          let attachmentHtml = '';
          if (post.fileUrl) {
            if (post.fileType === 'image') {
              attachmentHtml = `<img src="${post.fileUrl}" alt="Post Image" class="w-full attachment-preview mt-3 rounded-lg">`;
            } else if (post.fileType === 'video') {
              attachmentHtml = `<video src="${post.fileUrl}" controls class="w-full attachment-preview mt-3 rounded-lg"></video>`;
            }
          }

          // Check if current user liked this post
          let likedByCurrentUser = false;
          if (currentUser?.uid) {
            const likeDoc = await postsRef.doc(postId).collection('likes').doc(currentUser.uid).get();
            likedByCurrentUser = likeDoc.exists;
          }

          // Get comments for this post
          const commentsSnapshot = await postsRef.doc(postId).collection('comments').orderBy('createdAt', 'asc').get();
          const commentsHtml = commentsSnapshot.docs.map(commentDoc => {
            const comment = commentDoc.data();
            const commentTime = comment.createdAt ? comment.createdAt.toDate().toLocaleTimeString('id-ID', { 
              hour: '2-digit', 
              minute: '2-digit' 
            }) : '';
            
            const commentUserAvatar = comment.userProfileImage ? 
              `<img src="${comment.userProfileImage}" class="w-6 h-6 rounded-full object-cover mr-2" alt="Avatar">` : 
              `<div class="w-6 h-6 rounded-full bg-gray-600 flex items-center justify-center text-xs text-white mr-2">${comment.userName.charAt(0)}</div>`;

            return `
              <div class="comment-box flex items-start text-sm bg-gray-800 p-2 rounded-lg mb-2">
                ${commentUserAvatar}
                <div>
                  <p class="font-medium text-gray-200">${comment.userName} <span class="text-gray-500 text-xs">${commentTime}</span></p>
                  <p class="text-gray-300">${comment.content}</p>
                </div>
              </div>
            `;
          }).join('');

          const postElement = document.createElement('div');
          postElement.className = `post-card bg-gray-900 rounded-lg shadow-md p-5 mb-5`;
          postElement.innerHTML = `
            <div class="flex items-center mb-4">
              <div class="user-avatar w-10 h-10 text-base mr-3 rounded-full overflow-hidden bg-gray-700 flex items-center justify-center text-white">
                ${post.userProfileImage ? `<img src="${post.userProfileImage}" class="w-full h-full object-cover" alt="Profile">` : post.userName.charAt(0).toUpperCase()}
              </div>
              <div>
                <h4 class="font-medium text-gray-100">${post.userName}</h4>
                <p class="text-xs text-gray-500">${postDate}</p>
              </div>
              ${currentUser && (currentUser.uid === post.userId || currentUser.role === 'admin') ? `
                <div class="ml-auto">
                  <button class="delete-post-button text-red-500 hover:text-red-400 text-lg" data-id="${postId}" title="Hapus Postingan">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              ` : ''}
            </div>
            <p class="text-gray-200 mb-3 whitespace-pre-wrap">${post.content}</p>
            ${attachmentHtml}
            <div class="flex items-center text-sm text-gray-400 mt-4 border-t border-gray-700 pt-3">
              <button class="like-button ${likedByCurrentUser ? 'text-red-500' : 'text-gray-400'} mr-4 hover:text-red-400 transition-colors duration-200" data-id="${postId}">
                <i class="fas fa-heart"></i> <span class="likes-count">${post.likesCount || 0}</span> Suka
              </button>
              <button class="comment-toggle-button text-gray-400 hover:text-blue-400 transition-colors duration-200" data-id="${postId}">
                <i class="fas fa-comment"></i> <span class="comments-count">${commentsSnapshot.size}</span> Komentar
              </button>
            </div>
            <div class="comments-section mt-4 hidden">
              <div class="comments-list space-y-2">
                ${commentsHtml}
              </div>
              <form class="add-comment-form mt-3" data-id="${postId}">
                <input type="text" placeholder="Tambahkan komentar..." class="input-field w-full p-2 rounded-md bg-gray-700 text-gray-100 border border-gray-600 focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50" required>
                <button type="submit" class="btn-primary px-4 py-2 text-sm mt-2 rounded-md bg-blue-600 hover:bg-blue-700 text-white transition-colors duration-200">Kirim</button>
              </form>
            </div>
          `;
          socialFeed.appendChild(postElement);

          // Add event listeners
          postElement.querySelector('.like-button').addEventListener('click', (e) => toggleLike(e.currentTarget.dataset.id));
          postElement.querySelector('.comment-toggle-button').addEventListener('click', (e) => {
            const commentsSection = postElement.querySelector('.comments-section');
            commentsSection.classList.toggle('hidden');
          });
          postElement.querySelector('.add-comment-form').addEventListener('submit', (e) => addComment(e));
          
          const deleteButton = postElement.querySelector('.delete-post-button');
          if (deleteButton) {
            deleteButton.addEventListener('click', (e) => deletePost(e.currentTarget.dataset.id, post.fileUrl));
          }
        });

        await Promise.all(postPromises);
      } catch (error) {
        socialFeed.innerHTML = `<p class="text-center py-6 text-red-400">Gagal memuat postingan: ${error.message}</p>`;
      }
    }

    async function toggleLike(postId) {
      if (!currentUser?.uid) {
        showError("Anda harus login untuk menyukai postingan.");
        return;
      }

      const likeRef = postsRef.doc(postId).collection('likes').doc(currentUser.uid);
      const postDocRef = postsRef.doc(postId);

      try {
        const likeDoc = await likeRef.get();
        
        if (likeDoc.exists) {
          // Unlike
          await likeRef.delete();
          await postDocRef.update({ 
            likesCount: firebase.firestore.FieldValue.increment(-1) 
          });
        } else {
          // Like
          await likeRef.set({ 
            userId: currentUser.uid, 
            likedAt: firebase.firestore.FieldValue.serverTimestamp() 
          });
          await postDocRef.update({ 
            likesCount: firebase.firestore.FieldValue.increment(1) 
          });
        }
        loadPosts();
      } catch (error) {
        showError("Gagal mengubah status suka: " + error.message);
      }
    }

    async function addComment(e) {
      e.preventDefault();
      const postId = e.currentTarget.dataset.id;
      const commentInput = e.currentTarget.querySelector('input');
      const commentContent = commentInput.value;

      if (!currentUser?.uid) {
        showError("Anda harus login untuk menambahkan komentar.");
        return;
      }

      if (!commentContent.trim()) {
        showError("Komentar tidak boleh kosong!");
        return;
      }

      try {
        const commentsRef = postsRef.doc(postId).collection('comments');
        const postDocRef = postsRef.doc(postId);

        await commentsRef.add({
          userId: currentUser.uid,
          userName: currentUser.name || currentUser.email.split('@')[0],
          userProfileImage: currentUser.photoURL || '',
          content: commentContent.trim(),
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        await postDocRef.update({
          commentsCount: firebase.firestore.FieldValue.increment(1)
        });

        commentInput.value = '';
        loadPosts();
      } catch (error) {
        showError("Gagal menambahkan komentar: " + error.message);
      }
    }

    async function deletePost(postId, fileUrl) {
      if (!confirm("Apakah Anda yakin ingin menghapus postingan ini? Semua komentar, suka, dan lampiran juga akan terhapus.")) return;

      try {
        // Delete likes
        const likesSnapshot = await postsRef.doc(postId).collection('likes').get();
        const deleteLikesPromises = likesSnapshot.docs.map(doc => doc.ref.delete());
        await Promise.all(deleteLikesPromises);

        // Delete comments
        const commentsSnapshot = await postsRef.doc(postId).collection('comments').get();
        const deleteCommentsPromises = commentsSnapshot.docs.map(doc => doc.ref.delete());
        await Promise.all(deleteCommentsPromises);

        // Delete attachment if exists
        if (fileUrl) {
          try {
            const fileRef = storage.refFromURL(fileUrl);
            await fileRef.delete();
          } catch (storageError) {
            console.warn("Could not delete file from storage:", storageError.message);
          }
        }

        // Delete post
        await postsRef.doc(postId).delete();
        showSuccess("Postingan berhasil dihapus!");
        loadPosts();
      } catch (error) {
        showError("Gagal menghapus postingan: " + error.message);
      }
    }

    // ================= ECOMMERCE FUNCTIONS =================
    let editingProductId = null; // Global variable to store product ID being edited
let productImagesFiles = []; // Array to store files for new/edited product images

function initEcommerceListeners() {
  const browseProductsTab = document.getElementById('browse-products-tab');
  const myProductsTab = document.getElementById('my-products-tab');
  const browseProductsContent = document.getElementById('browse-products-content');
  const myProductsContent = document.getElementById('my-products-content');

  const addProductBtn = document.getElementById('add-product-btn');
  const productForm = document.getElementById('product-form');
  const cancelProductBtn = document.getElementById('cancel-product-btn');
  const productNameInput = document.getElementById('product-name');
  const productDescriptionInput = document.getElementById('product-description');
  const productPriceInput = document.getElementById('product-price');
  const productStockInput = document.getElementById('product-stock');
  const productImagesInput = document.getElementById('product-images-input');
  const productImageNameDisplay = document.getElementById('product-image-name-display');
  const productImagesPreview = document.getElementById('product-images-preview');
  const productFormError = document.getElementById('product-form-error');

  // Tabs logic
  browseProductsTab.addEventListener('click', () => {
    browseProductsTab.classList.add('tab-active');
    myProductsTab.classList.remove('tab-active');
    browseProductsContent.classList.remove('hidden');
    myProductsContent.classList.add('hidden');
    productForm.classList.add('hidden'); // Hide form if visible
    loadAllProducts(); // Load all products when tab is active
  });

  myProductsTab.addEventListener('click', () => {
    myProductsTab.classList.add('tab-active');
    browseProductsTab.classList.remove('tab-active');
    myProductsContent.classList.remove('hidden');
    browseProductsContent.classList.add('hidden');
    loadMyProducts(); // Load user's products when tab is active
  });

  // Add Product Button
  addProductBtn.addEventListener('click', () => {
    editingProductId = null; // Reset for new product
    productForm.reset();
    productImagesFiles = []; // Clear images
    productImagesPreview.innerHTML = ''; // Clear preview
    productImageNameDisplay.textContent = 'Pilih gambar... (maks. 5)';
    productForm.classList.remove('hidden');
    productFormError.classList.add('hidden');
  });

  // Cancel Product Form
  cancelProductBtn.addEventListener('click', () => {
    productForm.classList.add('hidden');
  });

  // Product Image Handling
  productImagesInput.addEventListener('change', (e) => {
    productImagesFiles = [];
    productImagesPreview.innerHTML = '';
    const files = e.target.files;
    if (files.length > 5) {
      showError('Maksimal 5 gambar diperbolehkan.');
      e.target.value = ''; // Clear selected files
      return;
    }
    if (files.length > 0) {
      productImageNameDisplay.textContent = `${files.length} file dipilih`;
      Array.from(files).forEach(file => {
        productImagesFiles.push(file);
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        img.classList.add('w-20', 'h-20', 'object-cover', 'rounded-lg');
        productImagesPreview.appendChild(img);
      });
    } else {
      productImageNameDisplay.textContent = 'Pilih gambar... (maks. 5)';
    }
  });

  // Product Form Submission
  productForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    productFormError.classList.add('hidden');

    if (!currentUser) {
      showError('Anda harus login untuk menjual produk.');
      return;
    }

    const productName = productNameInput.value;
    const productDescription = productDescriptionInput.value;
    const productPrice = parseFloat(productPriceInput.value);
    const productStock = parseInt(productStockInput.value);

    if (productName.trim() === '' || productDescription.trim() === '') {
      productFormError.textContent = 'Nama dan deskripsi produk tidak boleh kosong.';
      productFormError.classList.remove('hidden');
      return;
    }
    if (isNaN(productPrice) || productPrice < 0) {
      productFormError.textContent = 'Harga tidak valid.';
      productFormError.classList.remove('hidden');
      return;
    }
    if (isNaN(productStock) || productStock < 0) {
      productFormError.textContent = 'Stok tidak valid.';
      productFormError.classList.remove('hidden');
      return;
    }

    try {
      let imageUrls = [];
      if (productImagesFiles.length > 0) {
        for (const file of productImagesFiles) {
          const storageRef = storage.ref(`product_images/${currentUser.uid}/${Date.now()}_${file.name}`);
          await storageRef.put(file);
          const url = await storageRef.getDownloadURL();
          imageUrls.push(url);
        }
      }

      const productData = {
        name: productName,
        description: productDescription,
        price: productPrice,
        stock: productStock,
        imageUrls: imageUrls,
        sellerId: currentUser.uid,
        sellerName: currentUser.displayName || currentUser.email, // Get from user profile if available
        sellerEmail: currentUser.email,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };

      if (editingProductId) {
        await productsRef.doc(editingProductId).update(productData);
        showSuccess('Produk berhasil diperbarui!');
      } else {
        await productsRef.add(productData);
        showSuccess('Produk berhasil ditambahkan!');
      }

      productForm.classList.add('hidden');
      productForm.reset();
      productImagesFiles = [];
      productImagesPreview.innerHTML = '';
      productImageNameDisplay.textContent = 'Pilih gambar... (maks. 5)';
      loadMyProducts(); // Refresh product list
      loadAllProducts(); // Also refresh all products list
    } catch (error) {
      console.error("Error saving product:", error);
      productFormError.textContent = `Gagal menyimpan produk: ${error.message}`;
      productFormError.classList.remove('hidden');
    }
  });

  // Search Products
  const productSearchInput = document.getElementById('product-search-input');
  productSearchInput.addEventListener('input', debounce(() => {
    loadAllProducts(productSearchInput.value);
  }, 300)); // Debounce to prevent too many queries

}

// Fungsi debounce (untuk pencarian)
function debounce(func, delay) {
  let timeout;
  return function(...args) {
    const context = this;
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(context, args), delay);
  };
}


// Fungsi untuk memuat semua produk
async function loadAllProducts(searchQuery = '') {
  const productsList = document.getElementById('products-list');
  productsList.innerHTML = `
    <div class="text-center py-10 col-span-full">
      <div class="loading mx-auto"></div>
      <p class="mt-3 text-gray-400">Memuat produk...</p>
    </div>
  `;

  try {
    let query = productsRef.orderBy('timestamp', 'desc');
    if (searchQuery) {
        // Simple search: startswith or contains (Firestore doesn't support full-text search directly)
        // For more robust search, integrate with a dedicated search service like Algolia or Elasticsearch
        query = query.where('name', '>=', searchQuery)
                     .where('name', '<=', searchQuery + '\uf8ff'); // Simple prefix search
    }

    const querySnapshot = await query.get();

    if (querySnapshot.empty) {
      productsList.innerHTML = '<p class="text-center col-span-full text-gray-400">Belum ada produk yang tersedia.</p>';
      return;
    }

    let productsHtml = '';
    querySnapshot.forEach(doc => {
      const product = doc.data();
      const productId = doc.id;
      const imageUrl = product.imageUrls && product.imageUrls.length > 0 ? product.imageUrls[0] : 'https://via.placeholder.com/150?text=No+Image';
      const formattedPrice = formatRupiah(product.price);

      productsHtml += `
        <div class="solana-card overflow-hidden cursor-pointer" onclick="showProductDetail('${productId}')">
          <img src="${imageUrl}" alt="${product.name}" class="w-full h-48 object-cover">
          <div class="p-4">
            <h4 class="font-bold text-lg mb-1 truncate">${product.name}</h4>
            <p class="text-green-400 font-bold">${formattedPrice}</p>
            <p class="text-gray-400 text-sm mt-1">Stok: ${product.stock}</p>
          </div>
        </div>
      `;
    });
    productsList.innerHTML = productsHtml;
  } catch (error) {
    console.error("Error loading all products:", error);
    productsList.innerHTML = '<p class="text-center col-span-full text-red-400">Gagal memuat produk.</p>';
  }
}

// Fungsi untuk memuat produk yang dijual pengguna saat ini
async function loadMyProducts() {
  if (!currentUser) {
    document.getElementById('my-products-list').innerHTML = '<p class="text-center text-gray-400">Silakan login untuk melihat produk Anda.</p>';
    return;
  }

  const myProductsList = document.getElementById('my-products-list');
  myProductsList.innerHTML = `
    <div class="text-center py-10">
      <div class="loading mx-auto"></div>
      <p class="mt-3 text-gray-400">Memuat produk Anda...</p>
    </div>
  `;

  try {
    const querySnapshot = await productsRef
      .where('sellerId', '==', currentUser.uid)
      .orderBy('timestamp', 'desc')
      .get();

    if (querySnapshot.empty) {
      myProductsList.innerHTML = '<p class="text-center text-gray-400">Anda belum menjual produk apapun.</p>';
      return;
    }

    let productsHtml = '';
    querySnapshot.forEach(doc => {
      const product = doc.data();
      const productId = doc.id;
      const imageUrl = product.imageUrls && product.imageUrls.length > 0 ? product.imageUrls[0] : 'https://via.placeholder.com/100?text=No+Image';
      const formattedPrice = formatRupiah(product.price);

      productsHtml += `
        <div class="solana-card p-4 flex items-center">
          <img src="${imageUrl}" alt="${product.name}" class="w-20 h-20 object-cover rounded-lg mr-4">
          <div class="flex-grow">
            <h4 class="font-bold text-lg">${product.name}</h4>
            <p class="text-green-400 font-bold">${formattedPrice}</p>
            <p class="text-gray-400 text-sm">Stok: ${product.stock}</p>
          </div>
          <div class="flex space-x-2 ml-4">
            <button class="px-3 py-1 bg-blue-600/70 hover:bg-blue-600 rounded-lg text-sm" onclick="editProduct('${productId}')">
              Edit
            </button>
            <button class="px-3 py-1 bg-red-600/70 hover:bg-red-600 rounded-lg text-sm" onclick="deleteProduct('${productId}')">
              Hapus
            </button>
          </div>
        </div>
      `;
    });
    myProductsList.innerHTML = productsHtml;
  } catch (error) {
    console.error("Error loading my products:", error);
    myProductsList.innerHTML = '<p class="text-center text-red-400">Gagal memuat produk Anda.</p>';
  }
}

// Edit Product
async function editProduct(productId) {
  try {
    const productDoc = await productsRef.doc(productId).get();
    if (!productDoc.exists) {
      showError('Produk tidak ditemukan.');
      return;
    }
    const productData = productDoc.data();
    editingProductId = productId;
    productNameInput.value = productData.name;
    productDescriptionInput.value = productData.description;
    productPriceInput.value = productData.price;
    productStockInput.value = productData.stock;

    // Display existing images for editing
    productImagesFiles = []; // Clear current selected files
    productImagesPreview.innerHTML = '';
    if (productData.imageUrls && productData.imageUrls.length > 0) {
        productData.imageUrls.forEach(url => {
            const img = document.createElement('img');
            img.src = url;
            img.classList.add('w-20', 'h-20', 'object-cover', 'rounded-lg');
            productImagesPreview.appendChild(img);
        });
        productImageNameDisplay.textContent = `${productData.imageUrls.length} gambar saat ini`;
        // Note: For actual file editing, you'd need more complex logic to allow adding/removing individual files.
        // For simplicity, this example overwrites all images if new ones are selected.
    } else {
        productImageNameDisplay.textContent = 'Pilih gambar... (maks. 5)';
    }

    productForm.classList.remove('hidden');
    myProductsContent.classList.add('hidden'); // Hide my products list to show form
  } catch (error) {
    console.error("Error editing product:", error);
    showError('Gagal memuat data produk untuk diedit.');
  }
}

// Delete Product
async function deleteProduct(productId) {
  if (!confirm('Apakah Anda yakin ingin menghapus produk ini?')) {
    return;
  }
  try {
    // Delete product images from storage first (optional, but good practice)
    const productDoc = await productsRef.doc(productId).get();
    if (productDoc.exists) {
        const productData = productDoc.data();
        if (productData.imageUrls && productData.imageUrls.length > 0) {
            for (const url of productData.imageUrls) {
                const imageRef = storage.refFromURL(url);
                await imageRef.delete().catch(err => console.warn("Could not delete image:", err.message)); // Catch errors if image doesn't exist
            }
        }
    }
    await productsRef.doc(productId).delete();
    showSuccess('Produk berhasil dihapus!');
    loadMyProducts(); // Refresh product list
    loadAllProducts(); // Also refresh all products list
  } catch (error) {
    console.error("Error deleting product:", error);
    showError('Gagal menghapus produk.');
  }
}

// Show Product Detail Modal
async function showProductDetail(productId) {
  const productDetailModal = document.getElementById('product-detail-modal');
  const detailProductName = document.getElementById('detail-product-name');
  const detailProductImages = document.getElementById('detail-product-images');
  const detailProductPrice = document.getElementById('detail-product-price');
  const detailProductStock = document.getElementById('detail-product-stock');
  const detailSellerName = document.getElementById('detail-seller-name');
  const detailSellerEmail = document.getElementById('detail-seller-email');
  const detailProductDescription = document.getElementById('detail-product-description');
  const messageSellerBtn = document.getElementById('message-seller-btn');

  try {
    const productDoc = await productsRef.doc(productId).get();
    if (!productDoc.exists) {
      showError('Produk tidak ditemukan.');
      return;
    }
    const productData = productDoc.data();

    detailProductName.textContent = productData.name;
    detailProductPrice.textContent = formatRupiah(productData.price);
    detailProductStock.textContent = productData.stock;
    detailSellerName.textContent = productData.sellerName || productData.sellerEmail;
    detailSellerEmail.textContent = productData.sellerEmail;
    detailProductDescription.textContent = productData.description;

    detailProductImages.innerHTML = ''; // Clear previous images
    if (productData.imageUrls && productData.imageUrls.length > 0) {
      productData.imageUrls.forEach(url => {
        const img = document.createElement('img');
        img.src = url;
        img.classList.add('w-full', 'h-48', 'object-contain', 'rounded-lg', 'bg-gray-900'); // object-contain for full image view
        detailProductImages.appendChild(img);
      });
      detailProductImages.classList.remove('grid-cols-1', 'md:grid-cols-2', 'lg:grid-cols-3');
      if (productData.imageUrls.length === 1) detailProductImages.classList.add('grid-cols-1');
      else if (productData.imageUrls.length === 2) detailProductImages.classList.add('grid-cols-2');
      else detailProductImages.classList.add('grid-cols-3'); // Adjust grid based on image count
    } else {
      detailProductImages.innerHTML = '<p class="text-center text-gray-500">Tidak ada gambar untuk produk ini.</p>';
    }

    // Set up message seller button
    messageSellerBtn.onclick = () => showMessageSellerModal(productId, productData.name, productData.sellerId, productData.sellerName || productData.sellerEmail);
    messageSellerBtn.classList.toggle('hidden', currentUser && currentUser.uid === productData.sellerId); // Hide if it's seller's own product

    productDetailModal.classList.remove('hidden');
  } catch (error) {
    console.error("Error showing product detail:", error);
    showError('Gagal menampilkan detail produk.');
  }
}

// Close Product Detail Modal
document.getElementById('close-product-detail-modal').addEventListener('click', () => {
  document.getElementById('product-detail-modal').classList.add('hidden');
});

// Show Message Seller Modal
let currentProductChatId = null;
let currentChatRecipientId = null;
let currentChatListener = null; // To detach Firestore listener

async function showMessageSellerModal(productId, productName, sellerId, sellerName) {
  if (!currentUser) {
    showError('Anda harus login untuk mengirim pesan.');
    return;
  }
  if (currentUser.uid === sellerId) {
    showError('Anda tidak bisa mengirim pesan ke diri sendiri.');
    return;
  }

  const messageSellerModal = document.getElementById('message-seller-modal');
  const chatRecipientName = document.getElementById('chat-recipient-name');
  const chatProductName = document.getElementById('chat-product-name');
  const chatMessagesDiv = document.getElementById('chat-messages');
  const chatForm = document.getElementById('chat-form');
  const chatInput = document.getElementById('chat-input');

  chatRecipientName.textContent = sellerName;
  chatProductName.textContent = productName;
  chatMessagesDiv.innerHTML = '<div class="text-center text-gray-400">Memuat pesan...</div>';
  chatInput.value = '';

  currentProductChatId = productId;
  currentChatRecipientId = sellerId;

  // Determine conversation ID (consistent for buyer-seller-product pair)
  const conversationId = [productId, currentUser.uid, sellerId].sort().join('_'); // Ensures consistent ID regardless of who initiates

  // Detach previous listener if any
  if (currentChatListener) {
      currentChatListener();
  }

  // Real-time listener for messages
  currentChatListener = conversationsRef.doc(conversationId).onSnapshot(docSnapshot => {
      if (docSnapshot.exists) {
          const conversation = docSnapshot.data();
          renderMessages(conversation.messages || []);
      } else {
          chatMessagesDiv.innerHTML = '<div class="text-center text-gray-400">Belum ada pesan.</div>';
      }
      chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight; // Scroll to bottom
  }, err => {
      console.error("Error getting real-time messages:", err);
      chatMessagesDiv.innerHTML = '<div class="text-center text-red-400">Gagal memuat pesan.</div>';
  });

  chatForm.onsubmit = async (e) => {
    e.preventDefault();
    const messageContent = chatInput.value.trim();
    if (messageContent === '') return;

    try {
      const message = {
        senderId: currentUser.uid,
        senderName: currentUser.displayName || currentUser.email,
        content: messageContent,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };

      await conversationsRef.doc(conversationId).set({
        productId: productId,
        buyerId: currentUser.uid,
        sellerId: sellerId,
        participants: [currentUser.uid, sellerId], // For easier query later
        lastMessageAt: firebase.firestore.FieldValue.serverTimestamp(),
        messages: firebase.firestore.FieldValue.arrayUnion(message) // Add message to array
      }, { merge: true }); // Merge to update if exists, create if not

      chatInput.value = '';
    } catch (error) {
      console.error("Error sending message:", error);
      showError('Gagal mengirim pesan.');
    }
  };

  productDetailModal.classList.add('hidden'); // Hide product detail modal
  messageSellerModal.classList.remove('hidden');
}

// Function to render messages in the chat UI
function renderMessages(messages) {
    const chatMessagesDiv = document.getElementById('chat-messages');
    chatMessagesDiv.innerHTML = '';
    if (messages.length === 0) {
        chatMessagesDiv.innerHTML = '<div class="text-center text-gray-400">Belum ada pesan.</div>';
        return;
    }

    messages.sort((a, b) => a.timestamp.toDate() - b.timestamp.toDate()); // Sort by timestamp

    messages.forEach(msg => {
        const messageClass = msg.senderId === currentUser.uid ? 'bg-purple-700 ml-auto' : 'bg-gray-700 mr-auto';
        const senderName = msg.senderId === currentUser.uid ? 'Anda' : msg.senderName.split(' ')[0]; // Show first name or 'Anda'
        const timestamp = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString() : '';

        chatMessagesDiv.innerHTML += `
            <div class="p-3 rounded-lg max-w-[80%] ${messageClass}">
                <p class="font-medium text-sm mb-1">${senderName} <span class="text-xs text-gray-400 ml-2">${timestamp}</span></p>
                <p>${msg.content}</p>
            </div>
        `;
    });
}


// Close Message Seller Modal
document.getElementById('close-message-seller-modal').addEventListener('click', () => {
  document.getElementById('message-seller-modal').classList.add('hidden');
  if (currentChatListener) { // Detach listener when modal closes
      currentChatListener();
      currentChatListener = null;
  }
});


// Functions for User Profile Modal (User Connection)
let currentUserProfileId = null;

async function showUserProfile(userId) {
  const userProfileModal = document.getElementById('user-profile-modal');
  const profileModalAvatar = document.getElementById('profile-modal-avatar');
  const profileModalImage = document.getElementById('profile-modal-image');
  const profileModalInitial = document.getElementById('profile-modal-initial');
  const profileModalName = document.getElementById('profile-modal-name');
  const profileModalEmail = document.getElementById('profile-modal-email');
  const profileModalRole = document.getElementById('profile-modal-role');
  const profileModalPosts = document.getElementById('profile-modal-posts');
  const profileModalProducts = document.getElementById('profile-modal-products');

  currentUserProfileId = userId; // Store for fetching related data

  try {
    const userDoc = await usersRef.doc(userId).get();
    if (!userDoc.exists) {
      showError('Profil pengguna tidak ditemukan.');
      return;
    }
    const userData = userDoc.data();

    profileModalName.textContent = userData.name || userData.email;
    profileModalEmail.textContent = userData.email;
    profileModalRole.textContent = userData.role === 'admin' ? 'Admin' : 'Member';
    profileModalRole.className = `role-badge ${userData.role === 'admin' ? 'admin-badge' : 'member-badge'}`;

    if (userData.profileImageUrl) {
      profileModalImage.src = userData.profileImageUrl;
      profileModalImage.classList.remove('hidden');
      profileModalAvatar.classList.add('hidden');
    } else {
      profileModalInitial.textContent = (userData.name ? userData.name[0] : userData.email[0]).toUpperCase();
      profileModalAvatar.classList.remove('hidden');
      profileModalImage.classList.add('hidden');
    }

    // Load user's posts
    profileModalPosts.innerHTML = '<div class="text-center text-gray-400">Memuat postingan...</div>';
    const userPostsSnapshot = await postsRef.where('userId', '==', userId).orderBy('timestamp', 'desc').limit(5).get();
    if (userPostsSnapshot.empty) {
      profileModalPosts.innerHTML = '<p class="text-center text-gray-400">Pengguna ini belum memposting apapun.</p>';
    } else {
      let postsHtml = '';
      userPostsSnapshot.forEach(postDoc => {
        const post = postDoc.data();
        const postDate = post.timestamp ? new Date(post.timestamp.toDate()).toLocaleString() : 'N/A';
        postsHtml += `
          <div class="bg-gray-800/50 p-3 rounded-lg">
            <p class="text-sm text-gray-300 mb-1">${post.content}</p>
            <p class="text-xs text-gray-500">${postDate}</p>
          </div>
        `;
      });
      profileModalPosts.innerHTML = postsHtml;
    }

    // Load user's products
    profileModalProducts.innerHTML = '<div class="text-center text-gray-400">Memuat produk...</div>';
    const userProductsSnapshot = await productsRef.where('sellerId', '==', userId).orderBy('timestamp', 'desc').limit(4).get();
    if (userProductsSnapshot.empty) {
      profileModalProducts.innerHTML = '<p class="text-center col-span-full text-gray-400">Pengguna ini belum menjual produk apapun.</p>';
    } else {
      let productsHtml = '';
      userProductsSnapshot.forEach(productDoc => {
        const product = productDoc.data();
        const imageUrl = product.imageUrls && product.imageUrls.length > 0 ? product.imageUrls[0] : 'https://via.placeholder.com/80?text=No+Image';
        productsHtml += `
          <div class="flex items-center p-2 bg-gray-800/50 rounded-lg" onclick="showProductDetail('${productDoc.id}'); document.getElementById('close-user-profile-modal').click();">
            <img src="${imageUrl}" class="w-16 h-16 object-cover rounded-md mr-3" alt="${product.name}">
            <div>
              <p class="font-medium text-sm truncate">${product.name}</p>
              <p class="text-green-400 text-xs">${formatRupiah(product.price)}</p>
            </div>
          </div>
        `;
      });
      profileModalProducts.innerHTML = productsHtml;
    }


    userProfileModal.classList.remove('hidden');
  } catch (error) {
    console.error("Error loading user profile:", error);
    showError('Gagal memuat profil pengguna.');
  }
}

document.getElementById('close-user-profile-modal').addEventListener('click', () => {
  document.getElementById('user-profile-modal').classList.add('hidden');
});

// Modify renderPost to make sender name clickable (in initSocialListeners)
// Inside renderPost function:
/*
  const senderHtml = `
    <span class="font-medium hover:underline cursor-pointer" onclick="showUserProfile('${post.userId}')">
      ${senderName}
    </span>
  `;
  // Replace existing sender name display with senderHtml
*/

// Panggil initEcommerceListeners() di DOMContentLoaded
document.addEventListener('DOMContentLoaded', () => {
  // ... (existing initializations)
  initEcommerceListeners(); // NEW
  // ...
});


    // ================= ADMIN PANEL FUNCTIONS =================
    function initAdminListeners() {
      // Admin tabs
      document.getElementById('users-tab').addEventListener('click', () => {
        document.getElementById('users-admin-content').classList.remove('hidden');
        document.getElementById('transactions-admin-content').classList.add('hidden');
        document.getElementById('agendas-admin-content').classList.add('hidden');
        document.getElementById('users-tab').classList.add('tab-active');
        document.getElementById('transactions-admin-tab').classList.remove('tab-active');
        document.getElementById('agendas-admin-tab').classList.remove('tab-active');
        loadUsers();
      });
      
      document.getElementById('transactions-admin-tab').addEventListener('click', () => {
        document.getElementById('users-admin-content').classList.add('hidden');
        document.getElementById('transactions-admin-content').classList.remove('hidden');
        document.getElementById('agendas-admin-content').classList.add('hidden');
        document.getElementById('users-tab').classList.remove('tab-active');
        document.getElementById('transactions-admin-tab').classList.add('tab-active');
        document.getElementById('agendas-admin-tab').classList.remove('tab-active');
        loadAdminTransactions();
      });
      
      document.getElementById('agendas-admin-tab').addEventListener('click', () => {
        document.getElementById('users-admin-content').classList.add('hidden');
        document.getElementById('transactions-admin-content').classList.add('hidden');
        document.getElementById('agendas-admin-content').classList.remove('hidden');
        document.getElementById('users-tab').classList.remove('tab-active');
        document.getElementById('transactions-admin-tab').classList.remove('tab-active');
        document.getElementById('agendas-admin-tab').classList.add('tab-active');
        loadAdminAgendas();
      });
    }

    async function loadUsers() {
      const usersList = document.getElementById('users-list');
      usersList.innerHTML = '<div class="text-center py-10"><div class="loading mx-auto"></div><p class="mt-3 text-gray-400">Memuat data pengguna...</p></div>';

      if (currentUser && currentUser.role !== 'admin') {
        usersList.innerHTML = '<p class="text-center py-6 text-red-400">Anda tidak memiliki izin untuk melihat data pengguna.</p>';
        return;
      }
      
      try {
        const snapshot = await usersRef.get();
        usersList.innerHTML = '';
        
        if (snapshot.empty) {
          usersList.innerHTML = '<p class="text-center py-6 text-gray-400">Belum ada pengguna terdaftar.</p>';
          return;
        }

        snapshot.forEach(doc => {
          const user = doc.data();
          if (user.uid === currentUser.uid) return; // Skip current user

          const userElement = document.createElement('div');
          userElement.className = `user-list-item solana-card p-3 my-2`;
          userElement.innerHTML = `
            <div class="user-avatar w-10 h-10 text-base mr-3">
              ${user.profileImage ? `<img src="${user.profileImage}" class="w-full h-full rounded-full object-cover" alt="Profile">` : user.name.charAt(0)}
            </div>
            <div>
              <p class="font-medium">${user.name} <span class="role-badge ${user.role === 'admin' ? 'admin-badge' : 'member-badge'}">${user.role === 'admin' ? 'Admin' : 'Member'}</span></p>
              <p class="text-sm text-gray-400">${user.email}</p>
            </div>
            <div class="user-actions">
              <select class="input-field text-sm p-1" data-uid="${user.uid}">
                <option value="member" ${user.role === 'member' ? 'selected' : ''}>Member</option>
                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
              </select>
              <button class="delete-user-btn px-3 py-1 bg-red-600/80 hover:bg-red-700 rounded-lg text-sm" data-uid="${user.uid}">
                Hapus
              </button>
            </div>
          `;
          usersList.appendChild(userElement);
        });

        // Add event listeners for role change and delete
        usersList.querySelectorAll('select.input-field').forEach(select => {
          select.addEventListener('change', (e) => {
            const uid = e.target.dataset.uid;
            const newRole = e.target.value;
            updateUserRole(uid, newRole);
          });
        });
        
        usersList.querySelectorAll('.delete-user-btn').forEach(button => {
          button.addEventListener('click', (e) => {
            const uid = e.target.dataset.uid;
            deleteUser(uid);
          });
        });

      } catch (error) {
        usersList.innerHTML = `<p class="text-center py-6 text-red-400">Gagal memuat pengguna: ${error.message}</p>`;
      }
    }

    async function updateUserRole(uid, newRole) {
      if (!currentUser || currentUser.role !== 'admin') {
        showError("Anda tidak memiliki izin untuk mengubah peran.");
        return;
      }
      if (uid === currentUser.uid) {
        showError("Anda tidak dapat mengubah peran Anda sendiri melalui panel ini.");
        return;
      }

      try {
        await usersRef.doc(uid).update({ role: newRole });
        showSuccess(`Peran pengguna berhasil diubah menjadi ${newRole}.`);
        loadUsers();
      } catch (error) {
        showError("Gagal mengubah peran pengguna: " + error.message);
      }
    }

    async function deleteUser(uidToDelete) {
      if (!currentUser || currentUser.role !== 'admin') {
        showError("Anda tidak memiliki izin untuk menghapus pengguna.");
        return;
      }
      if (uidToDelete === currentUser.uid) {
        showError("Anda tidak dapat menghapus akun Anda sendiri melalui panel ini.");
        return;
      }

      if (!confirm("Apakah Anda yakin ingin menghapus pengguna ini? Tindakan ini tidak dapat dibatalkan!")) {
        return;
      }

      try {
        // Delete user's Firestore document
        await usersRef.doc(uidToDelete).delete();

        // Delete user's transactions
        const userTransactionsSnapshot = await transactionsRef.where('userId', '==', uidToDelete).get();
        const batch = db.batch();
        userTransactionsSnapshot.forEach(doc => {
          batch.delete(doc.ref);
        });
        await batch.commit();

        // NOTE: Deleting from Firebase Authentication would require a Cloud Function
        
        showSuccess("Pengguna dan data terkait (transaksi) berhasil dihapus.");
        loadUsers();
      } catch (error) {
        showError("Gagal menghapus pengguna: " + error.message);
      }
    }

    async function loadAdminTransactions() {
      const adminTransactionsList = document.getElementById('admin-transactions-list');
      adminTransactionsList.innerHTML = '<div class="text-center py-10"><div class="loading mx-auto"></div><p class="mt-3 text-gray-400">Memuat data transaksi...</p></div>';

      if (currentUser && currentUser.role !== 'admin') {
        adminTransactionsList.innerHTML = '<p class="text-center py-6 text-red-400">Anda tidak memiliki izin untuk melihat semua transaksi.</p>';
        return;
      }

      try {
        const snapshot = await transactionsRef.orderBy('date', 'desc').get();
        adminTransactionsList.innerHTML = '';
        
        if (snapshot.empty) {
          adminTransactionsList.innerHTML = '<p class="text-center py-6 text-gray-400">Belum ada transaksi.</p>';
          return;
        }

        snapshot.forEach(doc => {
          const transaction = doc.data();
          const transactionDate = transaction.date ? transaction.date.toDate() : new Date();
          const formattedDate = transactionDate.toLocaleDateString('id-ID', {
            day: 'numeric',
            month: 'long',
            year: 'numeric'
          });

          const transactionElement = document.createElement('div');
          transactionElement.className = `p-4 rounded-lg ${transaction.type === 'masuk' ? 'transaction-in' : 'transaction-out'} bg-gray-800/50`;
          transactionElement.innerHTML = `
            <div class="flex justify-between items-start">
              <div>
                <h4 class="font-medium">${transaction.description}</h4>
                <p class="text-sm text-gray-400 mt-1">${formattedDate}</p>
              </div>
              <div class="text-right">
                <p class="${transaction.type === 'masuk' ? 'text-green-400' : 'text-red-400'} font-mono font-medium">${transaction.type === 'masuk' ? '+' : '-'} ${formatRupiah(transaction.amount)}</p>
                <p class="text-xs text-gray-400 mt-1">Oleh: ${transaction.userName}</p>
              </div>
            </div>
          `;
          adminTransactionsList.appendChild(transactionElement);
        });
      } catch (error) {
        adminTransactionsList.innerHTML = `<p class="text-center py-6 text-red-400">Gagal memuat transaksi admin: ${error.message}</p>`;
      }
    }

    async function loadAdminAgendas() {
      const adminAgendasList = document.getElementById('admin-agendas-list');
      adminAgendasList.innerHTML = '<div class="text-center py-10"><div class="loading mx-auto"></div><p class="mt-3 text-gray-400">Memuat data agenda...</p></div>';

      if (currentUser && currentUser.role !== 'admin') {
        adminAgendasList.innerHTML = '<p class="text-center py-6 text-red-400">Anda tidak memiliki izin untuk melihat semua agenda.</p>';
        return;
      }
      
      try {
        const snapshot = await agendasRef.orderBy('date', 'desc').get();
        adminAgendasList.innerHTML = '';
        
        if (snapshot.empty) {
          adminAgendasList.innerHTML = '<p class="text-center py-6 text-gray-400">Belum ada agenda.</p>';
          return;
        }

        snapshot.forEach(doc => {
          const agenda = doc.data();
          const agendaDate = agenda.date;

          const agendaElement = document.createElement('div');
          agendaElement.className = `agenda-card p-4 bg-gray-800/50`;
          agendaElement.innerHTML = `
            <div class="flex justify-between items-center mb-2">
              <h4 class="font-medium text-lg">${agenda.title}</h4>
              <p class="text-sm text-gray-400">${agendaDate}</p>
            </div>
            <p class="text-gray-300 text-sm mb-2">${agenda.description}</p>
            ${agenda.fileUrl ? `<p class="text-xs text-purple-400"><a href="${agenda.fileUrl}" target="_blank" class="hover:underline"><i class="fas fa-paperclip mr-1"></i> Lampiran</a></p>` : ''}
            <p class="text-xs text-gray-500 mt-2">Dibuat oleh: ${agenda.userName}</p>
          `;
          adminAgendasList.appendChild(agendaElement);
        });
      } catch (error) {
        adminAgendasList.innerHTML = `<p class="text-center py-6 text-red-400">Gagal memuat agenda admin: ${error.message}</p>`;
      }
    }

    // ================= SETTINGS FUNCTIONS =================
    function initSettingsListeners() {
      // Profile image change
      document.getElementById('profile-image-input').addEventListener('change', (e) => {
        profileImageFile = e.target.files[0];
        if (profileImageFile) {
          const reader = new FileReader();
          reader.onload = (e) => {
            document.getElementById('profile-image-setting').src = e.target.result;
            document.getElementById('profile-image-setting').classList.remove('hidden');
            document.getElementById('profile-avatar-setting').classList.add('hidden');
          };
          reader.readAsDataURL(profileImageFile);
        }
      });

      // Settings form submit
      document.getElementById('setting-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const newName = document.getElementById('setting-name').value;
        const newPassword = document.getElementById('setting-password').value;

        try {
          // Update profile image
          if (profileImageFile) {
            const storageRef = storage.ref(`profile_images/${currentUser.uid}/${profileImageFile.name}`);
            const snapshot = await storageRef.put(profileImageFile);
            const imageUrl = await snapshot.ref.getDownloadURL();
            await usersRef.doc(currentUser.uid).update({ profileImage: imageUrl });
          }

          // Update name
          if (newName && newName !== document.getElementById('user-name').textContent) {
            await usersRef.doc(currentUser.uid).update({ name: newName });
          }

          // Update password
          if (newPassword) {
            if (newPassword.length < 6) {
              showError("Kata sandi baru minimal 6 karakter.");
              return;
            }
            await auth.currentUser.updatePassword(newPassword);
            document.getElementById('setting-password').value = '';
          }

          await loadUserData();
          showSuccess("Pengaturan berhasil disimpan!");
        } catch (error) {
          showError("Gagal menyimpan pengaturan: " + error.message);
          if (error.code === 'auth/requires-recent-login') {
            showError("Mohon login kembali untuk memperbarui kata sandi Anda.");
          }
        }
      });

      // Delete account button
      document.getElementById('delete-account-btn').addEventListener('click', async () => {
        if (!confirm("Apakah Anda yakin ingin menghapus akun Anda? Ini akan menghapus semua data Anda dan tidak dapat dibatalkan!")) {
          return;
        }

        try {
          // Delete user document
          await usersRef.doc(currentUser.uid).delete();
          
          // Delete profile image
          if (document.getElementById('profile-image').src) {
            const imgUrl = document.getElementById('profile-image').src;
            const imgRef = storage.refFromURL(imgUrl);
            await imgRef.delete().catch(e => console.warn("Could not delete old profile image:", e.message));
          }

          // Delete user from Authentication
          await auth.currentUser.delete();

          showSuccess("Akun Anda berhasil dihapus. Anda telah logout.");
        } catch (error) {
          showError("Gagal menghapus akun: " + error.message);
          if (error.code === 'auth/requires-recent-login') {
            showError("Mohon login kembali baru saja untuk menghapus akun Anda. Ini adalah tindakan keamanan.");
          }
        }
      });
    }

    // ================= FINANCE CHART =================
    function updateFinanceChart(income, expense) {
      const ctx = document.getElementById('finance-chart').getContext('2d');
      
      if (!financeChart) {
        financeChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['Kas Masuk', 'Kas Keluar'],
            datasets: [{
              label: 'Jumlah (Rp)',
              data: [income, expense],
              backgroundColor: [
                'rgba(16, 185, 129, 0.7)',
                'rgba(239, 68, 68, 0.7)'
              ],
              borderColor: [
                'rgba(16, 185, 129, 1)',
                'rgba(239, 68, 68, 1)'
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return 'Rp ' + context.raw.toLocaleString('id-ID');
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return 'Rp ' + value.toLocaleString('id-ID');
                  }
                }
              }
            }
          }
        });
      } else {
        financeChart.data.datasets[0].data = [income, expense];
        financeChart.update();
      }
    }

    // ================= BALANCE FUNCTIONS =================
    async function updateBalance() {
  try {
    // Get global metrics
    const globalMetricsDoc = await appDataRef.get();
    const globalData = globalMetricsDoc.data() || { totalAppIncome: 0, totalAppExpense: 0 };
    
    const totalIncome = globalData.totalAppIncome || 0;
    const totalExpense = globalData.totalAppExpense || 0;
    const totalBalance = totalIncome - totalExpense;

    // Update balance display
    document.getElementById('income-amount').textContent = '+ ' + formatRupiah(totalIncome);
    document.getElementById('expense-amount').textContent = '- ' + formatRupiah(totalExpense);
    document.getElementById('total-saldo').textContent = formatRupiah(totalBalance);

    // Update finance chart
    updateFinanceChart(totalIncome, totalExpense);

    // Update user balance if logged in
    if (currentUser) {
      const userDoc = await usersRef.doc(currentUser.uid).get();
      if (userDoc.exists) {
        const userData = userDoc.data();
        const userIncome = userData.totalIncome || 0;
        const userExpense = userData.totalExpense || 0;
        const userBalance = userIncome - userExpense;

        document.getElementById('user-income').textContent = formatRupiah(userIncome);
        document.getElementById('user-expense').textContent = formatRupiah(userExpense);
        document.getElementById('user-total-balance').textContent = formatRupiah(userBalance);
      }
    }
  } catch (error) {
    console.error("Error updating balance:", error);
  }
}

    // ================= NAVIGATION FUNCTIONS =================
    function initNavigationListeners() {
      // Tab switching
      document.getElementById('login-tab').addEventListener('click', () => {
        document.getElementById('login-form').classList.remove('hidden');
        document.getElementById('register-form').classList.add('hidden');
        document.getElementById('reset-form').classList.add('hidden');
        document.getElementById('login-tab').classList.add('tab-active');
        document.getElementById('register-tab').classList.remove('tab-active');
        document.getElementById('reset-tab').classList.remove('tab-active');
        document.getElementById('error-message').classList.add('hidden');
        document.getElementById('success-message').classList.add('hidden');
      });
      
      document.getElementById('register-tab').addEventListener('click', () => {
        document.getElementById('login-form').classList.add('hidden');
        document.getElementById('register-form').classList.remove('hidden');
        document.getElementById('reset-form').classList.add('hidden');
        document.getElementById('login-tab').classList.remove('tab-active');
        document.getElementById('register-tab').classList.add('tab-active');
        document.getElementById('reset-tab').classList.remove('tab-active');
        document.getElementById('error-message').classList.add('hidden');
        document.getElementById('success-message').classList.add('hidden');
      });
      
      document.getElementById('reset-tab').addEventListener('click', () => {
        document.getElementById('login-form').classList.add('hidden');
        document.getElementById('register-form').classList.add('hidden');
        document.getElementById('reset-form').classList.remove('hidden');
        document.getElementById('login-tab').classList.remove('tab-active');
        document.getElementById('register-tab').classList.remove('tab-active');
        document.getElementById('reset-tab').classList.add('tab-active');
        document.getElementById('error-message').classList.add('hidden');
        document.getElementById('success-message').classList.add('hidden');
      });

      // Admin checkbox toggle
      document.getElementById('is-admin').addEventListener('change', (e) => {
        if (e.target.checked) {
          document.getElementById('admin-code-container').classList.remove('hidden');
        } else {
          document.getElementById('admin-code-container').classList.add('hidden');
        }
      });

      // Menu navigation
      document.getElementById('show-kas').addEventListener('click', () => {
        hideAllSections();
        document.getElementById('kas-section').classList.remove('hidden');
      });

      document.getElementById('show-ecommerce').addEventListener('click', () => { // NEW
        hideAllSections();
      document.getElementById('ecommerce-section').classList.remove('hidden');
      document.getElementById('browse-products-tab').click(); // Show browse tab by default
      });
      
      document.getElementById('show-agenda').addEventListener('click', () => {
        hideAllSections();
        document.getElementById('agenda-section').classList.remove('hidden');
      });
      
      document.getElementById('show-sosial').addEventListener('click', () => {
        hideAllSections();
        document.getElementById('sosial-section').classList.remove('hidden');
      });
      
      document.getElementById('show-admin').addEventListener('click', () => {
        hideAllSections();
        document.getElementById('admin-section').classList.remove('hidden');
        loadUsers();
        document.getElementById('users-tab').click();
      });
      
      document.getElementById('show-setting').addEventListener('click', () => {
        hideAllSections();
        document.getElementById('setting-section').classList.remove('hidden');
      });
    }

    // ================= INITIALIZATION =================
    document.addEventListener('DOMContentLoaded', () => {
      initAuthListeners();
      initTransactionListeners();
      initAgendaListeners();
      initSocialListeners();
      initAdminListeners();
      initSettingsListeners();
      initNavigationListeners();
      initializeRadioButtons();
    });
  </script>
  
</body>
</html>
