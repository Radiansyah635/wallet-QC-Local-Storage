<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wallet QC - Pengaturan Akun</title>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-purple: #8B5CF6;
      --primary-green: #10B981;
      --dark-bg: #0f0f0f;
      --card-bg: rgba(31, 31, 31, 0.7);
    }
    
    body {
      background: linear-gradient(to bottom, #000000, var(--dark-bg));
      min-height: 100vh;
      font-family: 'Segoe UI', system-ui, sans-serif;
      color: #f3f4f6;
    }
    
    .solana-card {
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
      transition: all 0.3s ease;
    }
    
    .solana-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(139, 92, 246, 0.2);
    }
    
    .gradient-text {
      background: linear-gradient(to right, var(--primary-purple), var(--primary-green));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    
    .btn-primary {
      background: linear-gradient(to right, var(--primary-purple), var(--primary-green));
      color: white;
      border: none;
      border-radius: 12px;
      padding: 12px 24px;
      font-weight: 600;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .btn-primary:hover {
      opacity: 0.9;
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
    }
    
    .input-field {
      background: rgba(55, 55, 55, 0.5);
      border: 1px solid rgba(107, 114, 128, 0.3);
      border-radius: 12px;
      padding: 14px 16px;
      color: white;
      width: 100%;
      transition: border 0.3s ease;
    }
    
    .input-field:focus {
      outline: none;
      border-color: var(--primary-purple);
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
    }
    
    .tab-active {
      background: rgba(139, 92, 246, 0.2);
      color: var(--primary-purple);
      font-weight: 600;
    }
    
    .hidden {
      display: none;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(139, 92, 246, 0.3);
      border-radius: 50%;
      border-top-color: var(--primary-purple);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .profile-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--primary-purple);
    }
    
    .file-upload-label {
      display: inline-block;
      padding: 10px 15px;
      background: rgba(70, 70, 70, 0.5);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
    }
    
    .file-upload-label:hover {
      background: rgba(90, 90, 90, 0.7);
    }
    
    .btn-danger {
      background: linear-gradient(to right, #EF4444, #F59E0B);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 12px 24px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-danger:hover {
      opacity: 0.9;
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
    }
    
    .btn-secondary {
      background: rgba(70, 70, 70, 0.5);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 12px 24px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-secondary:hover {
      background: rgba(90, 90, 90, 0.7);
    }
    
    .setting-section {
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(70, 70, 70, 0.5);
    }
  </style>
</head>
<body class="min-h-screen flex flex-col">
  <header class="bg-black/80 py-4 px-6 border-b border-purple-900/50 sticky top-0 z-50">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-2xl font-bold gradient-text">Wallet QC Local Storage</h1>
      <div id="auth-section" class="flex items-center space-x-4">
        <span id="user-email" class="text-sm text-gray-300 hidden"></span>
        <button id="logout-btn" class="px-4 py-2 bg-red-600/80 hover:bg-red-500/90 rounded-lg text-sm hidden">
          Logout
        </button>
        <button id="login-btn" class="btn-primary">Login</button>
      </div>
    </div>
  </header>

  <main class="flex-grow container mx-auto px-4 py-8">
    <!-- Auth Container -->
    <section id="auth-container" class="max-w-md mx-auto solana-card p-8">
      <div class="text-center mb-8">
        <h2 class="text-3xl font-bold gradient-text mb-2">Selamat Datang</h2>
        <p class="text-gray-400">Kelola kas tim QC dengan mudah dan aman</p>
      </div>

      <div class="flex border-b border-gray-800 mb-6">
        <button id="login-tab" class="flex-1 py-4 font-medium tab-active">
          Login
        </button>
        <button id="register-tab" class="flex-1 py-4 font-medium text-gray-400">
          Register
        </button>
        <button id="reset-tab" class="flex-1 py-4 font-medium text-gray-400">
          Reset Password
        </button>
      </div>

      <!-- Login Form -->
      <form id="login-form">
        <div class="space-y-4">
          <div>
            <label for="login-email" class="block text-sm mb-2 text-gray-300">Email</label>
            <input 
              type="email" 
              id="login-email" 
              required
              class="input-field"
              placeholder="email@contoh.com"
            >
          </div>
          <div>
            <label for="login-password" class="block text-sm mb-2 text-gray-300">Password</label>
            <input 
              type="password" 
              id="login-password" 
              required
              class="input-field"
              placeholder="••••••••"
            >
          </div>
          <button type="submit" class="btn-primary w-full">
            Masuk
          </button>
        </div>
      </form>

      <!-- Register Form -->
      <form id="register-form" class="hidden">
        <div class="space-y-4">
          <div>
            <label for="register-name" class="block text-sm mb-2 text-gray-300">Nama Lengkap</label>
            <input 
              type="text" 
              id="register-name" 
              required
              class="input-field"
              placeholder="Nama Anda"
            >
          </div>
          <div>
            <label for="register-email" class="block text-sm mb-2 text-gray-300">Email</label>
            <input 
              type="email" 
              id="register-email" 
              required
              class="input-field"
              placeholder="email@contoh.com"
            >
          </div>
          <div>
            <label for="register-password" class="block text-sm mb-2 text-gray-300">Password</label>
            <input 
              type="password" 
              id="register-password" 
              required
              class="input-field"
              placeholder="••••••••"
            >
          </div>
          <button type="submit" class="btn-primary w-full">
            Daftar
          </button>
        </div>
      </form>
      
      <!-- Reset Password Form -->
      <form id="reset-form" class="hidden">
        <div class="space-y-4">
          <div>
            <label for="reset-email" class="block text-sm mb-2 text-gray-300">Email</label>
            <input 
              type="email" 
              id="reset-email" 
              required
              class="input-field"
              placeholder="email@contoh.com"
            >
          </div>
          <button type="submit" class="btn-primary w-full">
            Kirim Link Reset Password
          </button>
        </div>
      </form>
      
      <div id="error-message" class="mt-4 text-center text-red-400 text-sm hidden"></div>
      <div id="success-message" class="mt-4 text-center text-green-400 text-sm hidden"></div>
    </section>

    <!-- Dashboard -->
    <section id="dashboard" class="hidden">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-1 space-y-6">
          <!-- User Profile Card -->
          <div class="solana-card p-6">
            <div class="flex items-center space-x-4">
              <div class="relative">
                <img id="profile-avatar" class="profile-avatar" alt="Profile">
                <div id="avatar-initial" class="profile-avatar bg-purple-600 flex items-center justify-center text-3xl font-bold hidden"></div>
              </div>
              <div>
                <h3 id="user-name" class="font-medium text-lg">User Name</h3>
                <p id="user-email-display" class="text-sm text-gray-400">user@email.com</p>
                <div class="mt-2 text-sm">
                  <p>Member sejak: <span id="join-date">Jan 2023</span></p>
                </div>
              </div>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="solana-card p-6">
            <h3 class="font-medium mb-4 text-purple-400">Menu Cepat</h3>
            <ul class="space-y-3">
              <li>
                <button id="show-kas" class="w-full text-left p-3 hover:bg-gray-800/50 rounded-lg flex items-center">
                  <span class="mr-3">💰</span> Kas & Transaksi
                </button>
              </li>
              <li>
                <button id="show-agenda" class="w-full text-left p-3 hover:bg-gray-800/50 rounded-lg flex items-center">
                  <span class="mr-3">📅</span> Agenda QC
                </button>
              </li>
              <li>
                <button id="show-sosial" class="w-full text-left p-3 hover:bg-gray-800/50 rounded-lg flex items-center">
                  <span class="mr-3">💬</span> Sosial Media
                </button>
              </li>
              <li>
                <button id="show-setting" class="w-full text-left p-3 hover:bg-gray-800/50 rounded-lg flex items-center">
                  <span class="mr-3">⚙️</span> Pengaturan
                </button>
              </li>
            </ul>
          </div>

          <!-- Stats Card -->
          <div class="solana-card bg-gradient-to-br from-purple-900/30 to-green-900/20 p-6">
            <h3 class="font-medium mb-2">Statistik Penggunaan</h3>
            <p class="text-3xl font-bold font-mono">12 Transaksi</p>
            <div class="mt-4 bg-black/20 rounded-lg p-3">
              <div class="flex justify-between mb-2">
                <span>Aktifitas</span>
                <span class="text-green-400">+ 5 hari</span>
              </div>
              <div class="flex justify-between">
                <span>Anggota</span>
                <span class="text-blue-400">8 orang</span>
              </div>
            </div>
          </div>
        </div>

        <div class="lg:col-span-2 space-y-6">
          <!-- Kas & Transaksi -->
          <section id="kas-section" class="solana-card p-6">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-xl font-semibold">Kas & Transaksi</h2>
              <button class="btn-primary">
                <i class="fas fa-plus mr-2"></i> Tambah Transaksi
              </button>
            </div>
            
            <div class="space-y-4">
              <div class="p-4 border-l-4 border-green-500 bg-gray-800/30 rounded">
                <div class="flex justify-between">
                  <h4 class="font-medium">Kas Masuk</h4>
                  <span class="text-green-400">+ Rp 500,000</span>
                </div>
                <p class="text-sm text-gray-400 mt-1">Pembayaran iuran anggota - 2 jam yang lalu</p>
              </div>
              
              <div class="p-4 border-l-4 border-red-500 bg-gray-800/30 rounded">
                <div class="flex justify-between">
                  <h4 class="font-medium">Kas Keluar</h4>
                  <span class="text-red-400">- Rp 250,000</span>
                </div>
                <p class="text-sm text-gray-400 mt-1">Pembelian konsumsi meeting - 1 hari yang lalu</p>
              </div>
            </div>
          </section>
          
          <!-- Pengaturan Akun -->
          <section id="setting-section" class="solana-card p-6">
            <h2 class="text-xl font-semibold mb-6">Pengaturan Akun</h2>
            
            <!-- Foto Profil -->
            <div class="setting-section">
              <h3 class="text-lg font-medium mb-4">Foto Profil</h3>
              <div class="flex items-center space-x-6">
                <div class="relative">
                  <img id="profile-image" class="profile-avatar" alt="Profile">
                  <div id="profile-initial" class="profile-avatar bg-purple-600 flex items-center justify-center text-3xl font-bold hidden"></div>
                  <label for="profile-image-input" class="absolute bottom-0 right-0 bg-purple-600 rounded-full p-2 cursor-pointer">
                    <i class="fas fa-camera text-white"></i>
                  </label>
                  <input type="file" id="profile-image-input" accept="image/*" class="hidden">
                </div>
                <div>
                  <p class="text-gray-400 text-sm">Ukuran maks. 5MB (JPG, PNG)</p>
                  <label for="profile-image-input" class="file-upload-label mt-3">
                    <i class="fas fa-upload mr-2"></i> Pilih Foto
                  </label>
                </div>
              </div>
            </div>
            
            <!-- Informasi Akun -->
            <div class="setting-section">
              <h3 class="text-lg font-medium mb-4">Informasi Akun</h3>
              <form id="account-form">
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm mb-2">Nama Lengkap</label>
                    <input type="text" id="setting-name" class="input-field" placeholder="Nama Anda" required>
                  </div>
                  
                  <div>
                    <label class="block text-sm mb-2">Email</label>
                    <input type="email" id="setting-email" class="input-field" disabled>
                  </div>
                  
                  <button type="submit" class="btn-primary mt-4">
                    <i class="fas fa-save mr-2"></i> Simpan Perubahan
                  </button>
                </div>
              </form>
            </div>
            
            <!-- Keamanan Akun -->
            <div class="setting-section">
              <h3 class="text-lg font-medium mb-4">Keamanan Akun</h3>
              <form id="security-form">
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm mb-2">Password Lama</label>
                    <input type="password" id="old-password" class="input-field" placeholder="••••••••" required>
                  </div>
                  
                  <div>
                    <label class="block text-sm mb-2">Password Baru</label>
                    <input type="password" id="new-password" class="input-field" placeholder="••••••••" required>
                  </div>
                  
                  <div>
                    <label class="block text-sm mb-2">Konfirmasi Password Baru</label>
                    <input type="password" id="confirm-password" class="input-field" placeholder="••••••••" required>
                  </div>
                  
                  <button type="submit" class="btn-primary mt-4">
                    <i class="fas fa-key mr-2"></i> Ganti Password
                  </button>
                </div>
              </form>
            </div>
            
            <!-- Aksi Akun -->
            <div>
              <h3 class="text-lg font-medium mb-4">Aksi Akun</h3>
              <div class="space-y-3">
                <button id="logout-setting-btn" class="btn-secondary w-full">
                  <i class="fas fa-sign-out-alt mr-2"></i> Logout
                </button>
                <button id="delete-account-btn" class="btn-danger w-full">
                  <i class="fas fa-trash-alt mr-2"></i> Hapus Akun
                </button>
              </div>
            </div>
          </section>
        </div>
      </div>
    </section>
  </main>

  <!-- Konfirmasi Hapus Akun Modal -->
  <div id="delete-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden">
    <div class="solana-card p-8 max-w-md w-full">
      <h3 class="text-xl font-semibold mb-4">Konfirmasi Penghapusan Akun</h3>
      <p class="text-gray-300 mb-6">Apakah Anda yakin ingin menghapus akun? Semua data akan dihapus secara permanen dan tidak dapat dikembalikan.</p>
      
      <div class="flex space-x-4">
        <button id="confirm-delete" class="btn-danger flex-1">
          <i class="fas fa-trash-alt mr-2"></i> Hapus Akun
        </button>
        <button id="cancel-delete" class="btn-secondary flex-1">
          <i class="fas fa-times mr-2"></i> Batal
        </button>
      </div>
    </div>
  </div>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyD0RL0zvv4DL9EBax3XouugVZpkHdzyVNQ",
      authDomain: "wallet-qc-local-storage.firebaseapp.com",
      projectId: "wallet-qc-local-storage",
      storageBucket: "wallet-qc-local-storage.appspot.com",
      messagingSenderId: "443546801664",
      appId: "1:443546801664:web:6d0342e1b8261dd920aae5"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const secondaryApp = firebase.initializeApp(firebaseConfig, 'mySecondaryFirestoreApp');
    const auth = firebase.auth();
    const db = firebase.firestore(secondaryApp);
    const storage = firebase.storage();

    // DOM Elements
    const authContainer = document.getElementById('auth-container');
    const dashboard = document.getElementById('dashboard');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const resetForm = document.getElementById('reset-form');
    const logoutBtn = document.getElementById('logout-btn');
    const loginBtn = document.getElementById('login-btn');
    const loginTab = document.getElementById('login-tab');
    const registerTab = document.getElementById('register-tab');
    const resetTab = document.getElementById('reset-tab');
    const errorMessage = document.getElementById('error-message');
    const successMessage = document.getElementById('success-message');
    const showSettingBtn = document.getElementById('show-setting');
    const profileImage = document.getElementById('profile-image');
    const profileInitial = document.getElementById('profile-initial');
    const profileImageInput = document.getElementById('profile-image-input');
    const accountForm = document.getElementById('account-form');
    const securityForm = document.getElementById('security-form');
    const logoutSettingBtn = document.getElementById('logout-setting-btn');
    const deleteAccountBtn = document.getElementById('delete-account-btn');
    const deleteModal = document.getElementById('delete-modal');
    const confirmDelete = document.getElementById('confirm-delete');
    const cancelDelete = document.getElementById('cancel-delete');

    // Tab Switching
    loginTab.addEventListener('click', () => switchTab('login'));
    registerTab.addEventListener('click', () => switchTab('register'));
    resetTab.addEventListener('click', () => switchTab('reset'));
    
    function switchTab(tab) {
      loginForm.classList.add('hidden');
      registerForm.classList.add('hidden');
      resetForm.classList.add('hidden');
      
      loginTab.classList.remove('tab-active');
      registerTab.classList.remove('tab-active');
      resetTab.classList.remove('tab-active');
      
      if (tab === 'login') {
        loginForm.classList.remove('hidden');
        loginTab.classList.add('tab-active');
      } else if (tab === 'register') {
        registerForm.classList.remove('hidden');
        registerTab.classList.add('tab-active');
      } else if (tab === 'reset') {
        resetForm.classList.remove('hidden');
        resetTab.classList.add('tab-active');
      }
    }

    // Form Submission
    loginForm.addEventListener('submit', handleLogin);
    registerForm.addEventListener('submit', handleRegister);
    resetForm.addEventListener('submit', handleResetPassword);
    logoutBtn.addEventListener('click', handleLogout);
    loginBtn.addEventListener('click', () => {
      authContainer.classList.remove('hidden');
      dashboard.classList.add('hidden');
    });

    // Handle Login
    function handleLogin(e) {
      e.preventDefault();
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      
      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          showSuccess('Login berhasil!');
          console.log('User logged in:', userCredential.user);
        })
        .catch((error) => {
          showError(error.message);
        });
    }

    // Handle Register
    function handleRegister(e) {
      e.preventDefault();
      const name = document.getElementById('register-name').value;
      const email = document.getElementById('register-email').value;
      const password = document.getElementById('register-password').value;
      
      auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
          // Save additional user data to Firestore
          return db.collection('users').doc(userCredential.user.uid).set({
            name: name,
            email: email,
            createdAt: new Date(),
            role: 'member',
            photoURL: ''
          });
        })
        .then(() => {
          showSuccess('Registrasi berhasil! Silakan login');
          switchTab('login');
          registerForm.reset();
        })
        .catch((error) => {
          showError(error.message);
        });
    }

    // Handle Reset Password
    function handleResetPassword(e) {
      e.preventDefault();
      const email = document.getElementById('reset-email').value;
      
      auth.sendPasswordResetEmail(email)
        .then(() => {
          showSuccess('Link reset password telah dikirim ke email Anda');
          resetForm.reset();
        })
        .catch((error) => {
          showError(error.message);
        });
    }

    // Handle Logout
    function handleLogout() {
      auth.signOut()
        .then(() => {
          showSuccess('Logout berhasil!');
        })
        .catch((error) => {
          showError(error.message);
        });
    }

    // Show error message
    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.classList.remove('hidden');
      successMessage.classList.add('hidden');
    }

    // Show success message
    function showSuccess(message) {
      successMessage.textContent = message;
      successMessage.classList.remove('hidden');
      errorMessage.classList.add('hidden');
      
      // Auto hide success message after 5 seconds
      setTimeout(hideMessages, 5000);
    }

    // Hide messages
    function hideMessages() {
      errorMessage.classList.add('hidden');
      successMessage.classList.add('hidden');
    }

    // Update UI based on auth state
    auth.onAuthStateChanged(user => {
      if (user) {
        // User is signed in
        console.log('User logged in:', user);
        
        // Update UI
        document.getElementById('user-email').textContent = user.email;
        document.getElementById('user-email').classList.remove('hidden');
        document.getElementById('logout-btn').classList.remove('hidden');
        document.getElementById('login-btn').classList.add('hidden');
        
        // Update dashboard
        document.getElementById('user-name').textContent = user.displayName || user.email.split('@')[0];
        document.getElementById('user-email-display').textContent = user.email;
        
        // Fetch additional user data from Firestore
        db.collection('users').doc(user.uid).get()
          .then(doc => {
            if (doc.exists) {
              const userData = doc.data();
              
              // Update name
              if (userData.name) {
                document.getElementById('user-name').textContent = userData.name;
                document.getElementById('setting-name').value = userData.name;
              }
              
              // Update join date
              if (userData.createdAt) {
                const joinDate = userData.createdAt.toDate();
                document.getElementById('join-date').textContent = joinDate.toLocaleDateString('id-ID', {
                  year: 'numeric',
                  month: 'long'
                });
              }
              
              // Update profile photo
              if (userData.photoURL) {
                profileImage.src = userData.photoURL;
                profileImage.classList.remove('hidden');
                profileInitial.classList.add('hidden');
              } else {
                profileImage.classList.add('hidden');
                profileInitial.textContent = userData.name?.charAt(0) || user.email.charAt(0).toUpperCase();
                profileInitial.classList.remove('hidden');
              }
            }
          });
        
        // Show dashboard
        authContainer.classList.add('hidden');
        dashboard.classList.remove('hidden');
      } else {
        // User is signed out
        console.log('User signed out');
        document.getElementById('user-email').classList.add('hidden');
        document.getElementById('logout-btn').classList.add('hidden');
        document.getElementById('login-btn').classList.remove('hidden');
        
        // Hide dashboard
        authContainer.classList.remove('hidden');
        dashboard.classList.add('hidden');
      }
      
      hideMessages();
    });

    // Profile image upload
    profileImageInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const user = auth.currentUser;
      if (!user) return;
      
      // Show loading state
      const initialText = profileInitial.textContent;
      profileInitial.innerHTML = '<div class="loading mx-auto"></div>';
      
      // Upload file to Firebase Storage
      const storageRef = storage.ref(`profile_images/${user.uid}/${file.name}`);
      const uploadTask = storageRef.put(file);
      
      uploadTask.on('state_changed', 
        (snapshot) => {
          // Progress monitoring can be added here
        }, 
        (error) => {
          showError('Gagal mengunggah foto: ' + error.message);
          profileInitial.textContent = initialText;
        }, 
        () => {
          // Upload completed successfully
          uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
            // Update user profile in Firestore
            db.collection('users').doc(user.uid).update({
              photoURL: downloadURL
            }).then(() => {
              // Update UI
              profileImage.src = downloadURL;
              profileImage.classList.remove('hidden');
              profileInitial.classList.add('hidden');
              showSuccess('Foto profil berhasil diperbarui!');
            }).catch((error) => {
              showError('Gagal memperbarui profil: ' + error.message);
              profileInitial.textContent = initialText;
            });
          });
        }
      );
    });

    // Update account info
    accountForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const user = auth.currentUser;
      if (!user) return;
      
      const newName = document.getElementById('setting-name').value;
      
      // Update in Firestore
      db.collection('users').doc(user.uid).update({
        name: newName
      }).then(() => {
        // Update UI
        document.getElementById('user-name').textContent = newName;
        showSuccess('Nama berhasil diperbarui!');
      }).catch((error) => {
        showError('Gagal memperbarui nama: ' + error.message);
      });
    });

    // Change password
    securityForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const user = auth.currentUser;
      if (!user) return;
      
      const oldPassword = document.getElementById('old-password').value;
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      
      // Validate new password
      if (newPassword !== confirmPassword) {
        showError('Password baru dan konfirmasi tidak cocok');
        return;
      }
      
      // Re-authenticate user
      const credential = firebase.auth.EmailAuthProvider.credential(
        user.email, 
        oldPassword
      );
      
      user.reauthenticateWithCredential(credential)
        .then(() => {
          // Update password
          return user.updatePassword(newPassword);
        })
        .then(() => {
          showSuccess('Password berhasil diperbarui!');
          securityForm.reset();
        })
        .catch((error) => {
          showError('Gagal memperbarui password: ' + error.message);
        });
    });

    // Logout from settings
    logoutSettingBtn.addEventListener('click', handleLogout);
    
    // Delete account
    deleteAccountBtn.addEventListener('click', function() {
      deleteModal.classList.remove('hidden');
    });
    
    cancelDelete.addEventListener('click', function() {
      deleteModal.classList.add('hidden');
    });
    
    confirmDelete.addEventListener('click', function() {
      const user = auth.currentUser;
      if (!user) return;
      
      // Get password for re-authentication
      const password = prompt("Masukkan password Anda untuk konfirmasi penghapusan akun:");
      if (!password) return;
      
      const credential = firebase.auth.EmailAuthProvider.credential(
        user.email, 
        password
      );
      
      // Re-authenticate user
      user.reauthenticateWithCredential(credential)
        .then(() => {
          // Delete user from Authentication
          return user.delete();
        })
        .then(() => {
          // Delete user data from Firestore
          return db.collection('users').doc(user.uid).delete();
        })
        .then(() => {
          showSuccess('Akun berhasil dihapus!');
          deleteModal.classList.add('hidden');
        })
        .catch((error) => {
          showError('Gagal menghapus akun: ' + error.message);
          deleteModal.classList.add('hidden');
        });
    });

    // Demo Accounts for Testing
    document.addEventListener('DOMContentLoaded', () => {
      // Pre-fill demo account for easier testing
      document.getElementById('login-email').value = 'admin@walletqc.com';
      document.getElementById('login-password').value = 'admin123';
    });
  </script>
</body>
</html>
