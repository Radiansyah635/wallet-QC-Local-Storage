// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

// Collection references
const usersRef = db.collection("users");
const transactionsRef = db.collection("transactions");
const agendasRef = db.collection("agendas");
const postsRef = db.collection("posts");

// Global variables
let currentUser = null;
let financeChart = null;
let fullFinanceChart = null;
let selectedAgendaFile = null;
let selectedPostFile = null;
let profileImageFile = null;
let editingTransactionId = null;
let editingAgendaId = null;
let editingPostId = null;
let allUsers = [];
let allTransactions = [];
let allAgendas = [];
let allPosts = [];

// ================= AUTH FUNCTIONS =================
// Handle login
document.getElementById('login-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const email = document.getElementById('login-email').value;
  const password = document.getElementById('login-password').value;
  
  try {
    const userCredential = await auth.signInWithEmailAndPassword(email, password);
    currentUser = userCredential.user;
    showSuccess("Login berhasil!");
  } catch (error) {
    showError(error.message);
  }
});

// Handle register
document.getElementById('register-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const name = document.getElementById('register-name').value;
  const email = document.getElementById('register-email').value;
  const password = document.getElementById('register-password').value;
  const isAdmin = document.getElementById('is-admin').checked;
  const adminCode = document.getElementById('admin-code').value;
  
  // Validate admin code
  if (isAdmin && adminCode !== "admin123") {
    showError("Kode admin salah!");
    return;
  }

  try {
    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
    currentUser = userCredential.user;
    
    // Save additional user data
    await usersRef.doc(currentUser.uid).set({
      uid: currentUser.uid,
      name: name,
      email: email,
      role: isAdmin ? "admin" : "member",
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      profileImage: "",
      totalIncome: 0,
      totalExpense: 0,
      lastLogin: firebase.firestore.FieldValue.serverTimestamp()
    });

    showSuccess("Pendaftaran berhasil! Selamat datang.");
    document.getElementById('register-form').reset();
    document.getElementById('admin-code-container').classList.add('hidden');
    document.getElementById('is-admin').checked = false;
  } catch (error) {
    showError(error.message);
  }
});

// Handle reset password
document.getElementById('reset-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const email = document.getElementById('reset-email').value;
  
  try {
    await auth.sendPasswordResetEmail(email);
    showSuccess("Email reset password telah dikirim!");
    document.getElementById('reset-form').reset();
  } catch (error) {
    showError(error.message);
  }
});

// Handle logout
document.getElementById('logout-btn').addEventListener('click', async () => {
  try {
    await auth.signOut();
    showSuccess("Anda telah berhasil logout.");
  } catch (error) {
    showError("Gagal logout: " + error.message);
  }
});

// Handle auth state changes
auth.onAuthStateChanged(async user => {
  if (user) {
    currentUser = user;
    try {
      const userData = await loadUserData();
      
      // Set UI based on user role
      if (userData.role === 'admin') {
        document.querySelectorAll('.admin-only').forEach(el => {
          el.style.display = 'block';
        });
      } else {
        document.querySelectorAll('.admin-only').forEach(el => {
          el.style.display = 'none';
        });
      }
      
      // Show dashboard
      document.getElementById('auth-container').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');
      document.getElementById('logout-btn').classList.remove('hidden');
      document.getElementById('login-btn').classList.add('hidden');
      
      // Load all data
      await loadAllData();
      
    } catch (error) {
      showError("Gagal memuat data pengguna: " + error.message);
      auth.signOut();
    }
  } else {
    // User logged out
    currentUser = null;
    document.getElementById('dashboard').classList.add('hidden');
    document.getElementById('auth-container').classList.remove('hidden');
    document.getElementById('logout-btn').classList.add('hidden');
    document.getElementById('login-btn').classList.remove('hidden');
    document.getElementById('user-email').classList.add('hidden');
    document.getElementById('user-role').classList.add('hidden');
    
    // Hide admin elements
    document.querySelectorAll('.admin-only').forEach(el => {
      el.style.display = 'none';
    });
    
    // Return to login tab
    document.getElementById('login-tab').click();
  }
});

// ================= USER FUNCTIONS =================
async function loadUserData() {
  if (!currentUser) throw new Error("No current user");

  const doc = await usersRef.doc(currentUser.uid).get();
  if (!doc.exists) {
    throw new Error("Data pengguna tidak ditemukan di Firestore");
  }

  const userData = doc.data();
  currentUser.role = userData.role || 'member';
  
  // Update UI
  document.getElementById('user-initial').textContent = userData.name.charAt(0);
  document.getElementById('user-initial-setting').textContent = userData.name.charAt(0);
  document.getElementById('user-name').textContent = userData.name;
  document.getElementById('user-email-display').textContent = userData.email;
  document.getElementById('setting-name').value = userData.name;
  document.getElementById('setting-email').value = userData.email;
  
  // Update role badge
  const roleBadge = document.getElementById('role-badge');
  roleBadge.textContent = userData.role === 'admin' ? 'Admin' : 'Member';
  roleBadge.className = userData.role === 'admin' ? 
    'role-badge admin-badge' : 'role-badge member-badge';
  
  // Update user stats
  document.getElementById('user-income').textContent = formatRupiah(userData.totalIncome || 0);
  document.getElementById('user-expense').textContent = formatRupiah(userData.totalExpense || 0);
  document.getElementById('user-balance').textContent = formatRupiah((userData.totalIncome || 0) - (userData.totalExpense || 0));
  
  // Show profile image if exists
  if (userData.profileImage) {
    document.getElementById('profile-avatar').classList.add('hidden');
    document.getElementById('profile-image').classList.remove('hidden');
    document.getElementById('profile-image').src = userData.profileImage;
    
    document.getElementById('profile-avatar-setting').classList.add('hidden');
    document.getElementById('profile-image-setting').classList.remove('hidden');
    document.getElementById('profile-image-setting').src = userData.profileImage;
  } else {
    document.getElementById('profile-avatar').classList.remove('hidden');
    document.getElementById('profile-image').classList.add('hidden');
    document.getElementById('profile-avatar-setting').classList.remove('hidden');
    document.getElementById('profile-image-setting').classList.add('hidden');
  }
  
  // Update last login time
  await usersRef.doc(currentUser.uid).update({
    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
  });

  return userData;
}

// Load all data needed for dashboard
async function loadAllData() {
  try {
    await Promise.all([
      loadUsers(),
      loadTransactions(),
      loadAgendas(),
      loadPosts(),
      updateBalance(),
      loadRecentTransactions(),
      loadRecentPosts(),
      loadUpcomingAgendas()
    ]);
  } catch (error) {
    showError("Gagal memuat beberapa data: " + error.message);
  }
}

// ================= DASHBOARD FUNCTIONS =================
async function loadRecentTransactions() {
  const recentTransactionsList = document.getElementById('recent-transactions');
  recentTransactionsList.innerHTML = '<div class="text-center py-10"><div class="loading mx-auto"></div><p class="mt-3 text-gray-400">Memuat data transaksi...</p></div>';
  
  try {
    let query = transactionsRef.orderBy('date', 'desc').limit(5);
    
    // If not admin, only show current user's transactions
    if (currentUser.role !== 'admin') {
      query = query.where('userId', '==', currentUser.uid);
    }
    
    const snapshot = await query.get();
    recentTransactionsList.innerHTML = '';
    
    if (snapshot.empty) {
      recentTransactionsList.innerHTML = '<p class="text-center py-6 text-gray-400">Belum ada transaksi</p>';
      return;
    }
    
    snapshot.forEach(doc => {
      const transaction = doc.data();
      const transactionDate = transaction.date ? transaction.date.toDate() : new Date();
      const formattedDate = transactionDate.toLocaleDateString('id-ID', {
        day: 'numeric',
        month: 'short',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      const transactionElement = document.createElement('div');
      transactionElement.className = `p-3 rounded-lg ${transaction.type === 'masuk' ? 'transaction-in' : 'transaction-out'} bg-gray-800/50`;
      transactionElement.innerHTML = `
        <div class="flex justify-between items-center">
          <div class="truncate">
            <h4 class="font-medium truncate">${transaction.description}</h4>
            <p class="text-xs text-gray-400 mt-1">${formattedDate} â€¢ ${transaction.userName}</p>
          </div>
          <div class="text-right min-w-[100px]">
            <p class="${transaction.type === 'masuk' ? 'text-green-400' : 'text-red-400'} font-mono font-medium">${transaction.type === 'masuk' ? '+' : '-'} ${formatRupiah(transaction.amount)}</p>
          </div>
        </div>
      `;
      
      recentTransactionsList.appendChild(transactionElement);
    });
    
    // Add "View All" button
    const viewAllBtn = document.createElement('button');
    viewAllBtn.className = 'w-full mt-3 text-center text-purple-400 hover:underline';
    viewAllBtn.textContent = 'Lihat Semua Transaksi';
    viewAllBtn.addEventListener('click', () => {
      document.getElementById('show-full-kas').click();
    });
    recentTransactionsList.appendChild(viewAllBtn);
  } catch (error) {
    recentTransactionsList.innerHTML = `<p class="text-center py-6 text-red-400">Gagal memuat transaksi: ${error.message}</p>`;
  }
}

// ================= TRANSACTION FUNCTIONS =================
document.getElementById('add-transaction-btn').addEventListener('click', () => {
  showTransactionForm();
});

document.getElementById('add-transaction-full-btn').addEventListener('click', () => {
  showTransactionForm();
});

document.getElementById('admin-add-transaction-btn').addEventListener('click', () => {
  showTransactionForm();
});

function showTransactionForm() {
  document.getElementById('transaction-form').classList.remove('hidden');
  document.getElementById('transaction-form').reset();
  editingTransactionId = null;
  
  // If admin, populate user dropdown
  if (currentUser.role === 'admin') {
    populateUserDropdown();
  } else {
    document.getElementById('transaction-user').value = currentUser.uid;
  }
}

document.getElementById('transaction-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const type = document.getElementById('transaction-type').value;
  const amount = parseFloat(document.getElementById('transaction-amount').value);
  const description = document.getElementById('transaction-desc').value;
  const userId = document.getElementById('transaction-user').value || currentUser.uid;

  if (isNaN(amount) || amount <= 0) {
    showError("Jumlah transaksi harus angka positif.");
    return;
  }

  const transactionData = {
    userId: userId,
    userName: document.getElementById('user-name').textContent,
    type: type,
    amount: amount,
    description: description,
    date: firebase.firestore.FieldValue.serverTimestamp()
  };

  try {
    if (editingTransactionId) {
      // Edit mode
      await db.runTransaction(async (transaction) => {
        const oldDoc = await transaction.get(transactionsRef.doc(editingTransactionId));
        const oldTransaction = oldDoc.data();

        // Update user's total income/expense based on old and new transaction
        const userDocRef = usersRef.doc(userId);
        const userDoc = await transaction.get(userDocRef);
        const userData = userDoc.data();

        let newTotalIncome = userData.totalIncome || 0;
        let newTotalExpense = userData.totalExpense || 0;

        // Revert old transaction's effect
        if (oldTransaction.type === 'masuk') {
          newTotalIncome -= oldTransaction.amount;
        } else {
          newTotalExpense -= oldTransaction.amount;
        }

        // Apply new transaction's effect
        if (type === 'masuk') {
          newTotalIncome += amount;
        } else {
          newTotalExpense += amount;
        }

        transaction.update(userDocRef, {
          totalIncome: newTotalIncome,
          totalExpense: newTotalExpense
        });
        transaction.update(transactionsRef.doc(editingTransactionId), transactionData);
      });

      showSuccess("Transaksi berhasil diperbarui!");
    } else {
      // Add mode
      await db.runTransaction(async (transaction) => {
        const newTransactionRef = transactionsRef.doc();
        
        const userDocRef = usersRef.doc(userId);
        const userDoc = await transaction.get(userDocRef);
        const userData = userDoc.data();

        let newTotalIncome = userData.totalIncome || 0;
        let newTotalExpense = userData.totalExpense || 0;

        if (type === 'masuk') {
          newTotalIncome += amount;
        } else {
          newTotalExpense += amount;
        }

        transaction.set(newTransactionRef, transactionData);
        transaction.update(userDocRef, {
          totalIncome: newTotalIncome,
          totalExpense: newTotalExpense
        });
      });

      showSuccess("Transaksi berhasil ditambahkan!");
    }

    document.getElementById('transaction-form').classList.add('hidden');
    document.getElementById('transaction-form').reset();
    editingTransactionId = null;
    
    // Refresh data
    await Promise.all([
      loadTransactions(),
      loadRecentTransactions(),
      updateBalance()
    ]);
    
  } catch (error) {
    showError(`Gagal ${editingTransactionId ? 'memperbarui' : 'menambahkan'} transaksi: ${error.message}`);
  }
});

// ================= CHART FUNCTIONS =================
function initFullFinanceChart() {
  const ctx = document.getElementById('full-finance-chart').getContext('2d');
  fullFinanceChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Kas Masuk', 'Kas Keluar'],
      datasets: [{
        label: 'Jumlah (Rp)',
        data: [0, 0],
        backgroundColor: [
          'rgba(16, 185, 129, 0.7)',
          'rgba(239, 68, 68, 0.7)'
        ],
        borderColor: [
          'rgba(16, 185, 129, 1)',
          'rgba(239, 68, 68, 1)'
        ],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return 'Rp ' + context.raw.toLocaleString('id-ID');
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return 'Rp ' + value.toLocaleString('id-ID');
            }
          }
        }
      }
    }
  });
}

function updateFinanceChart(income, expense) {
  if (financeChart) {
    financeChart.data.datasets[0].data = [income, expense];
    financeChart.update();
  }
  
  if (fullFinanceChart) {
    fullFinanceChart.data.datasets[0].data = [income, expense];
    fullFinanceChart.update();
  }
}

// ================= HELPER FUNCTIONS =================
        function showError(message) {
          const errorElement = document.getElementById('error-message');
          errorElement.textContent = message;
          errorElement.classList.remove('hidden');
          setTimeout(() => errorElement.classList.add('hidden'), 5000);
        }
        
        function showSuccess(message) {
          const successElement = document.getElementById('success-message');
          successElement.textContent = message;
          successElement.classList.remove('hidden');
          setTimeout(() => successElement.classList.add('hidden'), 5000);
        }
    
        function formatRupiah(amount) {
          return 'Rp ' + amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }
        
        function updateBalance() {
          // Update user balance
          usersRef.doc(currentUser.uid).get().then(doc => {
            if (doc.exists) {
                const userData = doc.data();
                const totalBalance = (userData.totalIncome || 0) - (userData.totalExpense || 0);
                document.getElementById('user-balance').textContent = formatRupiah(totalBalance);
            }
          });
          
          // Update total QC balance (for admin)
          if (currentUser.role === 'admin') {
            usersRef.get().then(snapshot => {
              let totalIncome = 0;
              let totalExpense = 0;
              let userCount = 0;
              
              snapshot.forEach(doc => {
                const userData = doc.data();
                totalIncome += userData.totalIncome || 0;
                totalExpense += userData.totalExpense || 0;
                userCount++;
              });
              
              const totalBalance = totalIncome - totalExpense;
              
              document.getElementById('total-saldo').textContent = formatRupiah(totalBalance);
              document.getElementById('total-income').textContent = formatRupiah(totalIncome);
              document.getElementById('total-expense').textContent = formatRupiah(totalExpense);
              document.getElementById('total-users').textContent = userCount;
              
              // Update chart
              updateFinanceChart(totalIncome, totalExpense);
            });
          }
        }
        
        function updateFinanceChart(income, expense) {
          const ctx = document.getElementById('finance-chart').getContext('2d');
          
          if (financeChart) {
            financeChart.data.datasets[0].data = [income, expense];
            financeChart.update();
          } else {
            financeChart = new Chart(ctx, {
              type: 'bar',
              data: {
                labels: ['Kas Masuk', 'Kas Keluar'],
                datasets: [{
                  label: 'Jumlah (Rp)',
                  data: [income, expense],
                  backgroundColor: [
                    'rgba(16, 185, 129, 0.7)',
                    'rgba(239, 68, 68, 0.7)'
                  ],
                  borderColor: [
                    'rgba(16, 185, 129, 1)',
                    'rgba(239, 68, 68, 1)'
                  ],
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: false
                  },
                  tooltip: {
                    callbacks: {
                      label: function(context) {
                        return 'Rp ' + context.raw.toLocaleString('id-ID');
                      }
                    }
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    ticks: {
                      callback: function(value) {
                        return 'Rp ' + value.toLocaleString('id-ID');
                      }
                    }
                  }
                }
              }
            });
          }
          
          // Update full finance chart if it exists
          if (fullFinanceChart) {
            fullFinanceChart.data.datasets[0].data = [income, expense];
            fullFinanceChart.update();
          }
        }
    
        // ================= INITIALIZATION =================
        // Tab switching
        document.getElementById('login-tab').addEventListener('click', () => {
          document.getElementById('login-form').classList.remove('hidden');
          document.getElementById('register-form').classList.add('hidden');
          document.getElementById('reset-form').classList.add('hidden');
          document.getElementById('login-tab').classList.add('tab-active');
          document.getElementById('register-tab').classList.remove('tab-active');
          document.getElementById('reset-tab').classList.remove('tab-active');
          document.getElementById('error-message').classList.add('hidden');
          document.getElementById('success-message').classList.add('hidden');
        });
        
        document.getElementById('register-tab').addEventListener('click', () => {
          document.getElementById('login-form').classList.add('hidden');
          document.getElementById('register-form').classList.remove('hidden');
          document.getElementById('reset-form').classList.add('hidden');
          document.getElementById('login-tab').classList.remove('tab-active');
          document.getElementById('register-tab').classList.add('tab-active');
          document.getElementById('reset-tab').classList.remove('tab-active');
          document.getElementById('error-message').classList.add('hidden');
          document.getElementById('success-message').classList.add('hidden');
        });
        
        document.getElementById('reset-tab').addEventListener('click', () => {
          document.getElementById('login-form').classList.add('hidden');
          document.getElementById('register-form').classList.add('hidden');
          document.getElementById('reset-form').classList.remove('hidden');
          document.getElementById('login-tab').classList.remove('tab-active');
          document.getElementById('register-tab').classList.remove('tab-active');
          document.getElementById('reset-tab').classList.add('tab-active');
          document.getElementById('error-message').classList.add('hidden');
          document.getElementById('success-message').classList.add('hidden');
        });
        
        // Admin checkbox toggle
        document.getElementById('is-admin').addEventListener('change', (e) => {
          if (e.target.checked) {
            document.getElementById('admin-code-container').classList.remove('hidden');
          } else {
            document.getElementById('admin-code-container').classList.add('hidden');
          }
        });
        
        // Dashboard navigation
        document.getElementById('show-full-kas').addEventListener('click', () => {
          hideAllSections();
          document.getElementById('full-kas-section').classList.remove('hidden');
          loadTransactions();
        });
        
        document.getElementById('show-full-agenda').addEventListener('click', () => {
          hideAllSections();
          document.getElementById('full-agenda-section').classList.remove('hidden');
          loadAgendas();
        });
        
        document.getElementById('show-full-sosial').addEventListener('click', () => {
          hideAllSections();
          document.getElementById('full-sosial-section').classList.remove('hidden');
          loadPosts();
        });
        
        document.getElementById('show-admin').addEventListener('click', () => {
          hideAllSections();
          document.getElementById('admin-section').classList.remove('hidden');
          loadUsers();
          document.getElementById('users-tab').click();
        });
        
        function hideAllSections() {
          document.getElementById('full-kas-section').classList.add('hidden');
          document.getElementById('full-agenda-section').classList.add('hidden');
          document.getElementById('full-sosial-section').classList.add('hidden');
          document.getElementById('admin-section').classList.add('hidden');
          document.getElementById('setting-section').classList.add('hidden');
        }
        
        // Admin tabs
        document.getElementById('users-tab').addEventListener('click', () => {
          document.getElementById('users-admin-content').classList.remove('hidden');
          document.getElementById('transactions-admin-content').classList.add('hidden');
          document.getElementById('agendas-admin-content').classList.add('hidden');
          document.getElementById('users-tab').classList.add('tab-active');
          document.getElementById('transactions-admin-tab').classList.remove('tab-active');
          document.getElementById('agendas-admin-tab').classList.remove('tab-active');
          loadUsers();
        });
        
        document.getElementById('transactions-admin-tab').addEventListener('click', () => {
          document.getElementById('users-admin-content').classList.add('hidden');
          document.getElementById('transactions-admin-content').classList.remove('hidden');
          document.getElementById('agendas-admin-content').classList.add('hidden');
          document.getElementById('users-tab').classList.remove('tab-active');
          document.getElementById('transactions-admin-tab').classList.add('tab-active');
          document.getElementById('agendas-admin-tab').classList.remove('tab-active');
          loadAdminTransactions();
        });
        
        document.getElementById('agendas-admin-tab').addEventListener('click', () => {
          document.getElementById('users-admin-content').classList.add('hidden');
          document.getElementById('transactions-admin-content').classList.add('hidden');
          document.getElementById('agendas-admin-content').classList.remove('hidden');
          document.getElementById('users-tab').classList.remove('tab-active');
          document.getElementById('transactions-admin-tab').classList.remove('tab-active');
          document.getElementById('agendas-admin-tab').classList.add('tab-active');
          loadAdminAgendas();
        });
    
        // Populate user dropdown for admin transaction creation
        function populateUserDropdown() {
          const userDropdown = document.getElementById('transaction-user');
          userDropdown.innerHTML = '<option value="">Pilih User</option>';
          
          usersRef.orderBy('name').get().then(snapshot => {
            snapshot.forEach(doc => {
              const user = doc.data();
              const option = document.createElement('option');
              option.value = user.uid;
              option.textContent = user.name;
              userDropdown.appendChild(option);
            });
          });
        }
    
        // Search functionality
        document.getElementById('admin-user-search').addEventListener('input', (e) => {
          const searchTerm = e.target.value.toLowerCase();
          const usersList = document.getElementById('users-list');
          const userItems = usersList.querySelectorAll('.user-list-item');
          
          userItems.forEach(item => {
            const name = item.querySelector('p.font-medium').textContent.toLowerCase();
            const email = item.querySelector('p.text-sm').textContent.toLowerCase();
            
            if (name.includes(searchTerm)) {
              item.style.display = 'flex';
            } else if (email.includes(searchTerm)) {
              item.style.display = 'flex';
            } else {
              item.style.display = 'none';
            }
          });
        });
    
        document.getElementById('admin-transaction-search').addEventListener('input', (e) => {
          const searchTerm = e.target.value.toLowerCase();
          const transactionsList = document.getElementById('admin-transactions-list');
          const transactionItems = transactionsList.querySelectorAll('.transaction-in, .transaction-out');
          
          transactionItems.forEach(item => {
            const description = item.querySelector('h4.font-medium').textContent.toLowerCase();
            const userName = item.querySelector('p.text-xs').textContent.toLowerCase();
            
            if (description.includes(searchTerm)) {
              item.style.display = 'block';
            } else if (userName.includes(searchTerm)) {
              item.style.display = 'block';
            } else {
              item.style.display = 'none';
            }
          });
        });
    
        document.getElementById('admin-agenda-search').addEventListener('input', (e) => {
          const searchTerm = e.target.value.toLowerCase();
          const agendasList = document.getElementById('admin-agendas-list');
          const agendaItems = agendasList.querySelectorAll('.agenda-card');
          
          agendaItems.forEach(item => {
            const title = item.querySelector('h4.font-medium').textContent.toLowerCase();
            const description = item.querySelector('p.text-gray-300').textContent.toLowerCase();
            
            if (title.includes(searchTerm)) {
              item.style.display = 'block';
            } else if (description.includes(searchTerm)) {
              item.style.display = 'block';
            } else {
              item.style.display = 'none';
            }
          });
        });
    
        // Initialize full finance chart
        function initFullFinanceChart() {
          const ctx = document.getElementById('full-finance-chart').getContext('2d');
          fullFinanceChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: ['Kas Masuk', 'Kas Keluar'],
              datasets: [{
                label: 'Jumlah (Rp)',
                data: [0, 0],
                backgroundColor: [
                  'rgba(16, 185, 129, 0.7)',
                  'rgba(239, 68, 68, 0.7)'
                ],
                borderColor: [
                  'rgba(16, 185, 129, 1)',
                  'rgba(239, 68, 68, 1)'
                ],
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false
                },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      return 'Rp ' + context.raw.toLocaleString('id-ID');
                    }
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function(value) {
                      return 'Rp ' + value.toLocaleString('id-ID');
                    }
                  }
                }
              }
            }
          });
        }
    
        // Initialize when page loads
        initFullFinanceChart();
        populateUserDropdown();
});
</script>
</body>
</html>
