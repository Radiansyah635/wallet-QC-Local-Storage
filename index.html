<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wallet QC Firebase App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD0RL0zvv4DL9EBax3XouugVZpkHdzyVNQ",
      authDomain: "wallet-qc-local-storage.firebaseapp.com",
      projectId: "wallet-qc-local-storage",
      storageBucket: "wallet-qc-local-storage.firebasestorage.app",
      messagingSenderId: "443546801664",
      appId: "1:443546801664:web:d520fd8d2f311edd20aae5",
      measurementId: "G-KVKSD7ES9P"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();
    let currentUserId = null;

    auth.onAuthStateChanged(user => {
      if (user) {
        currentUserId = user.uid;
        document.getElementById("loginSection").classList.add("hidden");
        document.getElementById("dashboardSection").classList.remove("hidden");
        loadUserData(user.uid);
        loadMessages();
        loadTasks();
        loadReports();
      } else {
        document.getElementById("loginSection").classList.remove("hidden");
        document.getElementById("dashboardSection").classList.add("hidden");
      }
    });

    function loginUser() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      auth.signInWithEmailAndPassword(email, password)
        .catch(e => alert("Login gagal: " + e.message));
    }

    function registerUser() {
      const name = document.getElementById("regName").value;
      const email = document.getElementById("regEmail").value;
      const password = document.getElementById("regPassword").value;
      auth.createUserWithEmailAndPassword(email, password)
        .then(cred => db.collection("users").doc(cred.user.uid).set({ name, email }))
        .then(() => alert("Registrasi berhasil!"))
        .catch(e => alert("Gagal daftar: " + e.message));
    }

    function logoutUser() {
      auth.signOut();
    }

    function loadUserData(uid) {
      db.collection("users").doc(uid).get().then(doc => {
        if (doc.exists) {
          document.getElementById("userName").textContent = doc.data().name;
        }
      });
    }

    function sendMessage() {
      const content = document.getElementById("messageInput").value;
      if (!content.trim()) return;
      const name = document.getElementById("userName").textContent;
      db.collection("messages").add({
        sender: name,
        content,
        timestamp: new Date()
      }).then(() => {
        document.getElementById("messageInput").value = "";
        loadMessages();
      });
    }

    function loadMessages() {
      db.collection("messages").orderBy("timestamp", "desc").limit(10).get().then(snapshot => {
        const container = document.getElementById("messageList");
        container.innerHTML = "";
        snapshot.forEach(doc => {
          const d = doc.data();
          container.innerHTML += `<div class="p-2 border-b"><strong>${d.sender}:</strong> ${d.content}</div>`;
        });
      });
    }

    function addTask() {
      const task = document.getElementById("taskInput").value;
      if (!task.trim()) return;
      db.collection("tasks").add({ task, completed: false, createdAt: new Date() })
        .then(() => {
          document.getElementById("taskInput").value = "";
          loadTasks();
        });
    }

    function loadTasks() {
      db.collection("tasks").orderBy("createdAt", "desc").get().then(snapshot => {
        const list = document.getElementById("taskList");
        list.innerHTML = "";
        snapshot.forEach(doc => {
          list.innerHTML += `<li>${doc.data().task}</li>`;
        });
      });
    }

    function submitReport() {
      const tanggal = document.getElementById("tanggalLaporan").value;
      const file = document.getElementById("fotoLaporan").files[0];
      if (!file || !tanggal) return alert("Isi tanggal dan pilih foto.");
      const ref = storage.ref(`laporan/${Date.now()}_${file.name}`);
      ref.put(file).then(snap => snap.ref.getDownloadURL())
        .then(url => db.collection("laporan").add({
          tanggal, fotoURL: url, uploadedAt: new Date(), user: currentUserId
        }))
        .then(() => {
          document.getElementById("fotoLaporan").value = "";
          loadReports();
        });
    }

    function loadReports() {
      const tanggal = document.getElementById("filterTanggal").value;
      let query = db.collection("laporan").where("user", "==", currentUserId);
      if (tanggal) query = query.where("tanggal", "==", tanggal);
      query.orderBy("uploadedAt", "desc").get().then(snapshot => {
        const div = document.getElementById("laporanList");
        div.innerHTML = "";
        snapshot.forEach(doc => {
          const d = doc.data();
          div.innerHTML += `<div class="border p-2 mb-2"><strong>${d.tanggal}</strong><br><img src="${d.fotoURL}" class="w-32"/></div>`;
        });
      });
    }

    function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const laporan = document.querySelectorAll("#laporanList div");
      let y = 10;
      laporan.forEach((lap, i) => {
        const tgl = lap.querySelector("strong").innerText;
        doc.text(`${i + 1}. Tanggal: ${tgl}`, 10, y);
        y += 10;
      });
      doc.save("laporan-qc.pdf");
    }
  </script>
</head>
<body class="bg-gray-100 p-4 text-gray-900">

  <!-- Login -->
  <section id="loginSection" class="max-w-sm mx-auto">
    <h2 class="text-2xl font-bold mb-4">Login</h2>
    <input id="email" type="email" placeholder="Email" class="border p-2 w-full mb-2"/>
    <input id="password" type="password" placeholder="Password" class="border p-2 w-full mb-2"/>
    <button onclick="loginUser()" class="bg-blue-600 text-white px-4 py-2 w-full">Login</button>
    <p class="mt-4 text-sm">Belum punya akun? <a href="#" onclick="document.getElementById('registerModal').classList.remove('hidden')" class="text-blue-500">Daftar di sini</a></p>
  </section>

  <!-- Register Modal -->
  <div id="registerModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded shadow-md w-full max-w-md">
      <h2 class="text-xl font-bold mb-4">Daftar</h2>
      <input id="regName" type="text" placeholder="Nama" class="border p-2 w-full mb-2"/>
      <input id="regEmail" type="email" placeholder="Email" class="border p-2 w-full mb-2"/>
      <input id="regPassword" type="password" placeholder="Password" class="border p-2 w-full mb-2"/>
      <button onclick="registerUser()" class="bg-green-600 text-white px-4 py-2 w-full">Daftar</button>
      <button onclick="document.getElementById('registerModal').classList.add('hidden')" class="text-red-500 text-sm mt-2 w-full">Tutup</button>
    </div>
  </div>

  <!-- Dashboard -->
  <section id="dashboardSection" class="hidden max-w-4xl mx-auto space-y-6">
    <div class="flex justify-between items-center">
      <h2 class="text-2xl font-bold">Halo, <span id="userName"></span> ðŸ‘‹</h2>
      <button onclick="logoutUser()" class="bg-red-600 text-white px-4 py-2">Logout</button>
    </div>

    <!-- Pesan -->
    <div>
      <h3 class="text-xl font-semibold mb-2">ðŸ’¬ Pesan Tim</h3>
      <input id="messageInput" type="text" class="border p-2 w-full mb-2" placeholder="Tulis pesan..." />
      <button onclick="sendMessage()" class="bg-blue-600 text-white px-4 py-2">Kirim</button>
      <div id="messageList" class="bg-white rounded shadow p-4 mt-2"></div>
    </div>

    <!-- Tugas -->
    <div>
      <h3 class="text-xl font-semibold mb-2">âœ… Tugas QC</h3>
      <input id="taskInput" type="text" class="border p-2 w-full mb-2" placeholder="Tambah tugas..." />
      <button onclick="addTask()" class="bg-green-600 text-white px-4 py-2">Tambah</button>
      <ul id="taskList" class="bg-white rounded shadow p-4 list-disc list-inside mt-2"></ul>
    </div>

    <!-- Laporan -->
    <div>
      <h3 class="text-xl font-semibold mb-2">ðŸ“… Laporan & Foto</h3>
      <input id="tanggalLaporan" type="date" class="border p-2 w-full mb-2" />
      <input id="fotoLaporan" type="file" accept="image/*" class="border p-2 w-full mb-2"/>
      <button onclick="submitReport()" class="bg-purple-600 text-white px-4 py-2 mb-2">Upload Laporan</button>

      <div class="flex gap-2 mb-4">
        <input id="filterTanggal" type="date" class="border p-2"/>
        <button onclick="loadReports()" class="bg-gray-600 text-white px-3 py-2">Filter</button>
        <button onclick="exportPDF()" class="bg-indigo-600 text-white px-3 py-2">Export ke PDF</button>
      </div>

      <div id="laporanList" class="bg-white rounded shadow p-4"></div>
    </div>
  </section>
</body>
        </html>
